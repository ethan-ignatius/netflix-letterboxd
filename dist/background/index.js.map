{"version":3,"file":"index.js","sources":["../../src/background/index.ts"],"sourcesContent":["import { log } from \"../shared/log\";\nimport type { ExtensionMessage, ResolveTitleMessage, TitleResolvedMessage } from \"../shared/types\";\n\nconst TMDB_BASE_URL = \"https://api.themoviedb.org/3\";\nconst TMDB_CACHE_TTL_MS = 7 * 24 * 60 * 60 * 1000;\nconst TMDB_FEATURE_TTL_MS = 30 * 24 * 60 * 60 * 1000;\nconst PROFILE_TTL_MS = 24 * 60 * 60 * 1000;\nconst TMDB_KEY_STORAGE = \"tmdbApiKey\";\nconst TMDB_CACHE_STORAGE = \"tmdbCache\";\nconst TMDB_FEATURE_STORAGE = \"tmdbFeatureCache\";\nconst MATCH_PROFILE_STORAGE = \"matchProfile\";\n\ntype TmdbCacheEntry = {\n  storedAt: number;\n  data: TitleResolvedMessage[\"payload\"];\n};\n\ntype TmdbCacheState = Record<string, TmdbCacheEntry>;\n\ntype TmdbFeature = {\n  tmdbId: number;\n  title?: string;\n  releaseYear?: number;\n  genres: string[];\n};\n\ntype TmdbFeatureCacheEntry = {\n  storedAt: number;\n  data: TmdbFeature;\n};\n\ntype TmdbFeatureCacheState = Record<string, TmdbFeatureCacheEntry>;\n\ntype MatchProfile = {\n  storedAt: number;\n  lastImportAt?: string;\n  meanRating: number;\n  genreStats: Record<string, { avg: number; count: number; strength: number }>;\n  decadeStats: Record<string, { avg: number; count: number; strength: number }>;\n};\n\nconst normalizeTitle = (title?: string): string => {\n  if (!title) return \"\";\n  return title\n    .toLowerCase()\n    .replace(/[^a-z0-9]+/g, \" \")\n    .trim();\n};\n\nconst buildCacheKey = (title?: string, year?: number): string => {\n  const normalized = normalizeTitle(title);\n  return year ? `${normalized} (${year})` : normalized;\n};\n\nconst buildLetterboxdKey = (title?: string, year?: number): string => {\n  const normalized = normalizeTitle(title);\n  return year ? `${normalized}|${year}` : normalized;\n};\n\nconst getLetterboxdIndex = async (): Promise<Record<string, { r?: number; w?: 1 }>> => {\n  const data = await chrome.storage.local.get([\"letterboxdIndex\"]);\n  return (data.letterboxdIndex as Record<string, { r?: number; w?: 1 }> | undefined) ?? {};\n};\n\nconst getLetterboxdStats = async (): Promise<{ importedAt?: string } | null> => {\n  const data = await chrome.storage.local.get([\"letterboxdStats\"]);\n  return (data.letterboxdStats as { importedAt?: string } | undefined) ?? null;\n};\n\nconst getTmdbCache = async (): Promise<TmdbCacheState> => {\n  const data = await chrome.storage.local.get([TMDB_CACHE_STORAGE]);\n  return (data[TMDB_CACHE_STORAGE] as TmdbCacheState | undefined) ?? {};\n};\n\nconst setTmdbCache = async (cache: TmdbCacheState) => {\n  await chrome.storage.local.set({ [TMDB_CACHE_STORAGE]: cache });\n};\n\nconst getFeatureCache = async (): Promise<TmdbFeatureCacheState> => {\n  const data = await chrome.storage.local.get([TMDB_FEATURE_STORAGE]);\n  return (data[TMDB_FEATURE_STORAGE] as TmdbFeatureCacheState | undefined) ?? {};\n};\n\nconst setFeatureCache = async (cache: TmdbFeatureCacheState) => {\n  await chrome.storage.local.set({ [TMDB_FEATURE_STORAGE]: cache });\n};\n\nconst getMatchProfileCache = async (): Promise<MatchProfile | null> => {\n  const data = await chrome.storage.local.get([MATCH_PROFILE_STORAGE]);\n  return (data[MATCH_PROFILE_STORAGE] as MatchProfile | undefined) ?? null;\n};\n\nconst setMatchProfileCache = async (profile: MatchProfile) => {\n  await chrome.storage.local.set({ [MATCH_PROFILE_STORAGE]: profile });\n};\n\nconst getTmdbApiKey = async (): Promise<string | null> => {\n  const data = await chrome.storage.local.get([TMDB_KEY_STORAGE]);\n  const key = data[TMDB_KEY_STORAGE] as string | undefined;\n  return key?.trim() ? key.trim() : null;\n};\n\nconst pickBestMatch = (results: any[], titleText?: string, year?: number) => {\n  if (!results.length) return null;\n  const normalized = normalizeTitle(titleText);\n\n  const exactTitleAndYear = results.find((item) => {\n    const resultTitle = normalizeTitle(item.title);\n    const releaseYear = item.release_date ? Number(item.release_date.slice(0, 4)) : undefined;\n    return resultTitle === normalized && year && releaseYear === year;\n  });\n  if (exactTitleAndYear) return exactTitleAndYear;\n\n  const exactTitle = results.find((item) => normalizeTitle(item.title) === normalized);\n  if (exactTitle) return exactTitle;\n\n  return results[0];\n};\n\nconst fetchJson = async (url: string) => {\n  const response = await fetch(url);\n  if (!response.ok) {\n    throw new Error(`TMDb request failed: ${response.status}`);\n  }\n  return response.json();\n};\n\ntype ResolvedTitle = TitleResolvedMessage[\"payload\"] & { tmdbGenres?: string[] };\n\nconst resolveTitleWithTmdb = async (payload: ResolveTitleMessage[\"payload\"]): Promise<ResolvedTitle> => {\n  const apiKey = await getTmdbApiKey();\n  if (!apiKey || !payload.titleText) {\n    log(\"TMDb resolve skipped (missing api key or title)\", { hasKey: !!apiKey, payload });\n    return { title: payload.titleText ?? \"Unknown title\" };\n  }\n\n  const cacheKey = buildCacheKey(payload.titleText, payload.year);\n  const cache = await getTmdbCache();\n  const cached = cache[cacheKey];\n  if (cached && Date.now() - cached.storedAt < TMDB_CACHE_TTL_MS) {\n    log(\"TMDb cache hit\", { cacheKey });\n    return cached.data;\n  }\n\n  const params = new URLSearchParams({\n    api_key: apiKey,\n    query: payload.titleText\n  });\n  if (payload.year) params.set(\"year\", String(payload.year));\n\n  const searchUrl = `${TMDB_BASE_URL}/search/movie?${params.toString()}`;\n  log(\"TMDb search\", { searchUrl });\n  const searchData = await fetchJson(searchUrl);\n  const match = pickBestMatch(searchData?.results ?? [], payload.titleText, payload.year);\n\n  if (!match?.id) {\n    log(\"TMDb no match\", { titleText: payload.titleText });\n    return { title: payload.titleText };\n  }\n\n  const detailsUrl = `${TMDB_BASE_URL}/movie/${match.id}?api_key=${apiKey}`;\n  log(\"TMDb details\", { detailsUrl });\n  const details = await fetchJson(detailsUrl);\n\n  const releaseYear = details.release_date ? Number(details.release_date.slice(0, 4)) : undefined;\n\n  const resolved: ResolvedTitle = {\n    title: details.title ?? payload.titleText ?? \"Unknown title\",\n    tmdbId: details.id,\n    tmdbVoteAverage: details.vote_average,\n    tmdbVoteCount: details.vote_count,\n    posterPath: details.poster_path ?? undefined,\n    releaseYear: Number.isNaN(releaseYear) ? undefined : releaseYear,\n    tmdbGenres: Array.isArray(details.genres)\n      ? details.genres.map((genre: { name: string }) => genre.name.toLowerCase())\n      : []\n  };\n\n  const { tmdbGenres, ...cachePayload } = resolved;\n  cache[cacheKey] = { storedAt: Date.now(), data: cachePayload };\n  await setTmdbCache(cache);\n  log(\"TMDb cached result\", { cacheKey, tmdbId: resolved.tmdbId });\n\n  return resolved;\n};\n\nconst parseIndexKey = (key: string): { title: string; year?: number } => {\n  const parts = key.split(\"|\");\n  if (parts.length === 2) {\n    const year = Number(parts[1]);\n    return { title: parts[0], year: Number.isNaN(year) ? undefined : year };\n  }\n  return { title: key };\n};\n\nconst getTmdbFeatures = async (\n  apiKey: string,\n  tmdbId: number\n): Promise<TmdbFeature | null> => {\n  const cache = await getFeatureCache();\n  const cacheKey = String(tmdbId);\n  const cached = cache[cacheKey];\n  if (cached && Date.now() - cached.storedAt < TMDB_FEATURE_TTL_MS) {\n    return cached.data;\n  }\n\n  const detailsUrl = `${TMDB_BASE_URL}/movie/${tmdbId}?api_key=${apiKey}`;\n  const details = await fetchJson(detailsUrl);\n  const releaseYear = details.release_date ? Number(details.release_date.slice(0, 4)) : undefined;\n  const features: TmdbFeature = {\n    tmdbId,\n    title: details.title,\n    releaseYear: Number.isNaN(releaseYear) ? undefined : releaseYear,\n    genres: Array.isArray(details.genres)\n      ? details.genres.map((genre: { name: string }) => genre.name.toLowerCase())\n      : []\n  };\n\n  cache[cacheKey] = { storedAt: Date.now(), data: features };\n  await setFeatureCache(cache);\n  return features;\n};\n\nconst searchTmdbId = async (\n  apiKey: string,\n  titleText: string,\n  year?: number,\n  cache?: TmdbCacheState\n): Promise<{ tmdbId: number; title?: string; releaseYear?: number } | null> => {\n  if (cache) {\n    const key = buildCacheKey(titleText, year);\n    const cached = cache[key];\n    if (cached?.data?.tmdbId) {\n      return {\n        tmdbId: cached.data.tmdbId,\n        title: cached.data.title,\n        releaseYear: cached.data.releaseYear\n      };\n    }\n  }\n  const params = new URLSearchParams({\n    api_key: apiKey,\n    query: titleText\n  });\n  if (year) params.set(\"year\", String(year));\n  const searchUrl = `${TMDB_BASE_URL}/search/movie?${params.toString()}`;\n  const searchData = await fetchJson(searchUrl);\n  const match = pickBestMatch(searchData?.results ?? [], titleText, year);\n  if (!match?.id) return null;\n  const releaseYear = match.release_date ? Number(match.release_date.slice(0, 4)) : undefined;\n  return {\n    tmdbId: match.id,\n    title: match.title,\n    releaseYear: Number.isNaN(releaseYear) ? undefined : releaseYear\n  };\n};\n\nconst buildMatchProfile = async (): Promise<MatchProfile | null> => {\n  const apiKey = await getTmdbApiKey();\n  if (!apiKey) return null;\n\n  const stats = await getLetterboxdStats();\n  const cached = await getMatchProfileCache();\n  if (\n    cached &&\n    Date.now() - cached.storedAt < PROFILE_TTL_MS &&\n    cached.lastImportAt &&\n    stats?.importedAt &&\n    cached.lastImportAt === stats.importedAt\n  ) {\n    return cached;\n  }\n\n  const index = await getLetterboxdIndex();\n  const tmdbCache = await getTmdbCache();\n  const entries = Object.entries(index).filter(([, entry]) => entry.r !== undefined);\n  if (!entries.length) return null;\n\n  let ratingSum = 0;\n  let ratingCount = 0;\n  const genreTotals: Record<string, { sum: number; count: number }> = {};\n  const decadeTotals: Record<string, { sum: number; count: number }> = {};\n\n  const maxEntries = 300;\n  for (const [key, entry] of entries.slice(0, maxEntries)) {\n    const rating = entry.r;\n    if (rating === undefined) continue;\n    ratingSum += rating;\n    ratingCount += 1;\n\n    const { title, year } = parseIndexKey(key);\n    if (!title) continue;\n\n    const searchResult = await searchTmdbId(apiKey, title, year, tmdbCache);\n    if (!searchResult) continue;\n\n    const features = await getTmdbFeatures(apiKey, searchResult.tmdbId);\n    if (!features) continue;\n\n    const releaseYear = features.releaseYear ?? searchResult.releaseYear ?? year;\n    const decade = releaseYear ? `${Math.floor(releaseYear / 10) * 10}s` : undefined;\n\n    features.genres.forEach((genre) => {\n      if (!genreTotals[genre]) genreTotals[genre] = { sum: 0, count: 0 };\n      genreTotals[genre].sum += rating;\n      genreTotals[genre].count += 1;\n    });\n\n    if (decade) {\n      if (!decadeTotals[decade]) decadeTotals[decade] = { sum: 0, count: 0 };\n      decadeTotals[decade].sum += rating;\n      decadeTotals[decade].count += 1;\n    }\n  }\n\n  const meanRating = ratingCount ? ratingSum / ratingCount : 0;\n  const genreStats: MatchProfile[\"genreStats\"] = {};\n  const decadeStats: MatchProfile[\"decadeStats\"] = {};\n\n  Object.entries(genreTotals).forEach(([genre, { sum, count }]) => {\n    const avg = sum / count;\n    genreStats[genre] = {\n      avg,\n      count,\n      strength: avg - meanRating\n    };\n  });\n\n  Object.entries(decadeTotals).forEach(([decade, { sum, count }]) => {\n    const avg = sum / count;\n    decadeStats[decade] = {\n      avg,\n      count,\n      strength: avg - meanRating\n    };\n  });\n\n  const profile: MatchProfile = {\n    storedAt: Date.now(),\n    lastImportAt: stats?.importedAt,\n    meanRating,\n    genreStats,\n    decadeStats\n  };\n\n  await setMatchProfileCache(profile);\n  return profile;\n};\n\nconst computeMatchScore = (\n  profile: MatchProfile | null,\n  candidateGenres: string[]\n): { matchScore?: number; matchExplanation?: string } => {\n  if (!profile || !candidateGenres.length) return {};\n\n  let weightedSum = 0;\n  let totalWeight = 0;\n  let bestGenre = \"\";\n  let bestStrength = 0;\n\n  candidateGenres.forEach((genre) => {\n    const normalized = genre.toLowerCase();\n    const stats = profile.genreStats[normalized];\n    if (!stats) return;\n    const confidence = Math.min(1, stats.count / 5);\n    const strength = stats.strength;\n    weightedSum += strength * confidence;\n    totalWeight += confidence;\n    if (strength > bestStrength) {\n      bestStrength = strength;\n      bestGenre = normalized;\n    }\n  });\n\n  if (totalWeight === 0) return {};\n  const normalized = weightedSum / totalWeight;\n  const score = Math.round(Math.max(0, Math.min(100, 50 + normalized * 20)));\n\n  const explanation =\n    bestStrength > 0.2 && bestGenre\n      ? `Because you rate ${bestGenre} highly`\n      : undefined;\n\n  return { matchScore: score, matchExplanation: explanation };\n};\n\nconst resolveLetterboxdEntry = async (\n  payload: ResolveTitleMessage[\"payload\"],\n  resolvedTitle?: string,\n  resolvedYear?: number\n) => {\n  const index = await getLetterboxdIndex();\n  const keys = [\n    buildLetterboxdKey(payload.titleText, payload.year),\n    buildLetterboxdKey(resolvedTitle, resolvedYear),\n    buildLetterboxdKey(payload.titleText, undefined),\n    buildLetterboxdKey(resolvedTitle, undefined)\n  ].filter((key) => key);\n\n  for (const key of keys) {\n    const entry = index[key];\n    if (entry) {\n      return {\n        inWatchlist: entry.w === 1,\n        userRating: entry.r\n      };\n    }\n  }\n\n  return {};\n};\n\nchrome.runtime.onInstalled.addListener((details) => {\n  log(\"Extension installed\", details);\n});\n\nchrome.runtime.onMessage.addListener(\n  (message: ExtensionMessage, sender, sendResponse) => {\n    log(\"Background received message\", { message, sender });\n\n    if (message.type === \"RESOLVE_TITLE\") {\n      const { requestId, payload } = message as ResolveTitleMessage;\n\n      void (async () => {\n        try {\n          const resolved = await resolveTitleWithTmdb(payload);\n          const lbData = await resolveLetterboxdEntry(\n            payload,\n            resolved.title,\n            resolved.releaseYear ?? payload.year\n          );\n          const profile = await buildMatchProfile();\n          const matchData = computeMatchScore(profile, resolved.tmdbGenres ?? []);\n          const { tmdbGenres, ...resolvedPayload } = resolved;\n          const response: TitleResolvedMessage = {\n            type: \"TITLE_RESOLVED\",\n            requestId,\n            payload: {\n              ...resolvedPayload,\n              ...lbData,\n              ...matchData\n            }\n          };\n          sendResponse(response);\n        } catch (error) {\n          log(\"TMDb resolve failed\", { error });\n          const lbData = await resolveLetterboxdEntry(\n            payload,\n            payload.titleText ?? \"Unknown title\",\n            payload.year\n          );\n          sendResponse({\n            type: \"TITLE_RESOLVED\",\n            requestId,\n            payload: {\n              title: payload.titleText ?? \"Unknown title\",\n              ...lbData\n            }\n          } satisfies TitleResolvedMessage);\n        }\n      })();\n\n      return true;\n    }\n\n    return false;\n  }\n);\n"],"names":["TMDB_BASE_URL","TMDB_CACHE_TTL_MS","TMDB_FEATURE_TTL_MS","PROFILE_TTL_MS","TMDB_KEY_STORAGE","TMDB_CACHE_STORAGE","TMDB_FEATURE_STORAGE","MATCH_PROFILE_STORAGE","normalizeTitle","title","buildCacheKey","year","normalized","buildLetterboxdKey","getLetterboxdIndex","getLetterboxdStats","getTmdbCache","setTmdbCache","cache","getFeatureCache","setFeatureCache","getMatchProfileCache","setMatchProfileCache","profile","getTmdbApiKey","key","pickBestMatch","results","titleText","exactTitleAndYear","item","resultTitle","releaseYear","exactTitle","fetchJson","url","response","resolveTitleWithTmdb","payload","apiKey","cacheKey","cached","params","searchUrl","searchData","match","log","detailsUrl","details","resolved","genre","tmdbGenres","cachePayload","parseIndexKey","parts","getTmdbFeatures","tmdbId","features","searchTmdbId","_a","buildMatchProfile","stats","index","tmdbCache","entries","entry","ratingSum","ratingCount","genreTotals","decadeTotals","maxEntries","rating","searchResult","decade","meanRating","genreStats","decadeStats","sum","count","avg","computeMatchScore","candidateGenres","weightedSum","totalWeight","bestGenre","bestStrength","confidence","strength","score","explanation","resolveLetterboxdEntry","resolvedTitle","resolvedYear","keys","message","sender","sendResponse","requestId","lbData","matchData","resolvedPayload"],"mappings":"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"}