import{l as N}from"../assets/log-BKemMERr.js";const E="https://api.themoviedb.org/3",K=7*24*60*60*1e3,B=30*24*60*60*1e3,F=24*60*60*1e3,$="tmdbApiKey",L="tmdbCache",M="tmdbFeatureCache",C="matchProfile",y=t=>t?t.toLowerCase().replace(/[^a-z0-9]+/g," ").trim():"",Y=(t,e)=>{const a=y(t);return e?`${a} (${e})`:a},x=(t,e)=>{const a=y(t);return e?`${a}|${e}`:a},U=async()=>(await chrome.storage.local.get(["letterboxdIndex"])).letterboxdIndex??{},G=async()=>(await chrome.storage.local.get(["letterboxdStats"])).letterboxdStats??null,k=async()=>(await chrome.storage.local.get([L]))[L]??{},z=async t=>{await chrome.storage.local.set({[L]:t})},V=async()=>(await chrome.storage.local.get([M]))[M]??{},j=async t=>{await chrome.storage.local.set({[M]:t})},q=async()=>(await chrome.storage.local.get([C]))[C]??null,H=async t=>{await chrome.storage.local.set({[C]:t})},O=async()=>{const e=(await chrome.storage.local.get([$]))[$];return e!=null&&e.trim()?e.trim():null},P=(t,e,a)=>{if(!t.length)return null;const c=y(e),n=t.find(r=>{const o=y(r.title),i=r.release_date?Number(r.release_date.slice(0,4)):void 0;return o===c&&a&&i===a});if(n)return n;const s=t.find(r=>y(r.title)===c);return s||t[0]},A=async t=>{const e=await fetch(t);if(!e.ok)throw new Error(`TMDb request failed: ${e.status}`);return e.json()},W=async t=>{const e=await O();if(!e||!t.titleText)return{title:t.titleText??"Unknown title"};const a=Y(t.titleText,t.year),c=await k(),n=c[a];if(n&&Date.now()-n.storedAt<K)return n.data;const s=new URLSearchParams({api_key:e,query:t.titleText});t.year&&s.set("year",String(t.year));const r=`${E}/search/movie?${s.toString()}`,o=await A(r),i=P((o==null?void 0:o.results)??[],t.titleText,t.year);if(!(i!=null&&i.id))return N("TMDb no match",{titleText:t.titleText}),{title:t.titleText};const u=`${E}/movie/${i.id}?api_key=${e}`,d=await A(u),l=d.release_date?Number(d.release_date.slice(0,4)):void 0,h={title:d.title??t.titleText??"Unknown title",tmdbId:d.id,tmdbVoteAverage:d.vote_average,tmdbVoteCount:d.vote_count,posterPath:d.poster_path??void 0,releaseYear:Number.isNaN(l)?void 0:l,tmdbGenres:Array.isArray(d.genres)?d.genres.map(f=>f.name.toLowerCase()):[]},{tmdbGenres:b,..._}=h;return c[a]={storedAt:Date.now(),data:_},await z(c),N("TMDb cached result",{cacheKey:a,tmdbId:h.tmdbId}),h},J=t=>{const e=t.split("|");if(e.length===2){const a=Number(e[1]);return{title:e[0],year:Number.isNaN(a)?void 0:a}}return{title:t}},Q=async(t,e)=>{const a=await V(),c=String(e),n=a[c];if(n&&Date.now()-n.storedAt<B)return n.data;const s=`${E}/movie/${e}?api_key=${t}`,r=await A(s),o=r.release_date?Number(r.release_date.slice(0,4)):void 0,i={tmdbId:e,title:r.title,releaseYear:Number.isNaN(o)?void 0:o,genres:Array.isArray(r.genres)?r.genres.map(u=>u.name.toLowerCase()):[]};return a[c]={storedAt:Date.now(),data:i},await j(a),i},X=async(t,e,a,c)=>{var u;if(c){const d=Y(e,a),l=c[d];if((u=l==null?void 0:l.data)!=null&&u.tmdbId)return{tmdbId:l.data.tmdbId,title:l.data.title,releaseYear:l.data.releaseYear}}const n=new URLSearchParams({api_key:t,query:e});a&&n.set("year",String(a));const s=`${E}/search/movie?${n.toString()}`,r=await A(s),o=P((r==null?void 0:r.results)??[],e,a);if(!(o!=null&&o.id))return null;const i=o.release_date?Number(o.release_date.slice(0,4)):void 0;return{tmdbId:o.id,title:o.title,releaseYear:Number.isNaN(i)?void 0:i}},Z=async()=>{const t=await O();if(!t)return null;const e=await G(),a=await q();if(a&&Date.now()-a.storedAt<F&&a.lastImportAt&&(e!=null&&e.importedAt)&&a.lastImportAt===e.importedAt)return a;const c=await U(),n=await k(),s=Object.entries(c).filter(([,f])=>f.r!==void 0);if(!s.length)return null;let r=0,o=0;const i={},u={},d=300;for(const[f,w]of s.slice(0,d)){const m=w.r;if(m===void 0)continue;r+=m,o+=1;const{title:g,year:I}=J(f);if(!g)continue;const S=await X(t,g,I,n);if(!S)continue;const p=await Q(t,S.tmdbId);if(!p)continue;const D=p.releaseYear??S.releaseYear??I,T=D?`${Math.floor(D/10)*10}s`:void 0;p.genres.forEach(v=>{i[v]||(i[v]={sum:0,count:0}),i[v].sum+=m,i[v].count+=1}),T&&(u[T]||(u[T]={sum:0,count:0}),u[T].sum+=m,u[T].count+=1)}const l=o?r/o:0,h={},b={};Object.entries(i).forEach(([f,{sum:w,count:m}])=>{const g=w/m;h[f]={avg:g,count:m,strength:g-l}}),Object.entries(u).forEach(([f,{sum:w,count:m}])=>{const g=w/m;b[f]={avg:g,count:m,strength:g-l}});const _={storedAt:Date.now(),lastImportAt:e==null?void 0:e.importedAt,meanRating:l,genreStats:h,decadeStats:b};return await H(_),_},tt=(t,e)=>{if(!t||!e.length)return{};let a=0,c=0,n="",s=0;if(e.forEach(u=>{const d=u.toLowerCase(),l=t.genreStats[d];if(!l)return;const h=Math.min(1,l.count/5),b=l.strength;a+=b*h,c+=h,b>s&&(s=b,n=d)}),c===0)return{};const r=a/c,o=Math.round(Math.max(0,Math.min(100,50+r*20))),i=s>.2&&n?`Because you rate ${n} highly`:void 0;return{matchScore:o,matchExplanation:i}},R=async(t,e,a)=>{const c=await U(),n=[x(t.titleText,t.year),x(e,a),x(t.titleText,void 0),x(e,void 0)].filter(s=>s);for(const s of n){const r=c[s];if(r)return{inWatchlist:r.w===1,userRating:r.r}}return{}};chrome.runtime.onInstalled.addListener(t=>{});chrome.runtime.onMessage.addListener((t,e,a)=>{if(t.type==="RESOLVE_TITLE"){const{requestId:c,payload:n}=t;return(async()=>{try{const s=await W(n),r=await R(n,s.title,s.releaseYear??n.year),o=await Z(),i=tt(o,s.tmdbGenres??[]),{tmdbGenres:u,...d}=s,l={type:"TITLE_RESOLVED",requestId:c,payload:{...d,...r,...i}};a(l)}catch{const r=await R(n,n.titleText??"Unknown title",n.year);a({type:"TITLE_RESOLVED",requestId:c,payload:{title:n.titleText??"Unknown title",...r}})}})(),!0}return!1});
//# sourceMappingURL=index.js.map
