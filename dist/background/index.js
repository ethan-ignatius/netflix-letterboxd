import{l as $}from"../assets/log-Bck1zoEB.js";const A="https://api.themoviedb.org/3",B=7*24*60*60*1e3,G=30*24*60*60*1e3,F=24*60*60*1e3,N="tmdbApiKey",L="tmdbCache",I="tmdbFeatureCache",C="matchProfile",p=t=>t?t.toLowerCase().replace(/[^a-z0-9]+/g," ").trim():"",Y=(t,e)=>{const a=p(t);return e?`${a} (${e})`:a},E=(t,e)=>{const a=p(t);return e?`${a}|${e}`:a},k=async()=>(await chrome.storage.local.get(["letterboxdIndex"])).letterboxdIndex??{},z=async()=>(await chrome.storage.local.get(["letterboxdStats"])).letterboxdStats??null,U=async()=>(await chrome.storage.local.get([L]))[L]??{},j=async t=>{await chrome.storage.local.set({[L]:t})},V=async()=>(await chrome.storage.local.get([I]))[I]??{},q=async t=>{await chrome.storage.local.set({[I]:t})},H=async()=>(await chrome.storage.local.get([C]))[C]??null,W=async t=>{await chrome.storage.local.set({[C]:t})},O=async()=>{const e=(await chrome.storage.local.get([N]))[N];return e!=null&&e.trim()?e.trim():null},P=(t,e,a)=>{if(!t.length)return null;const i=p(e),r=t.find(s=>{const n=p(s.title??s.name),l=s.release_date??s.first_air_date,o=l?Number(l.slice(0,4)):void 0;return n===i&&a&&o===a});if(r)return r;const c=t.find(s=>p(s.title??s.name)===i);return c||t[0]},M=async t=>{const e=await fetch(t);if(!e.ok)throw new Error(`TMDb request failed: ${e.status}`);return e.json()},J=async t=>{const e=await O();if(!e||!t.titleText)return{title:t.titleText??"Unknown title"};const a=Y(t.titleText,t.year),i=await U(),r=i[a];if(r&&Date.now()-r.storedAt<B){const h=r.data.tmdbMediaType??"movie";if(r.data.tmdbId){const w=await K(e,r.data.tmdbId,h);return{...r.data,tmdbGenres:(w==null?void 0:w.genres)??[]}}return r.data}const c=new URLSearchParams({api_key:e,query:t.titleText}),s=`${A}/search/multi?${c.toString()}`,n=await M(s),l=((n==null?void 0:n.results)??[]).filter(h=>h.media_type==="movie"||h.media_type==="tv"),o=P(l,t.titleText,t.year);if(!(o!=null&&o.id))return $("TMDb no match",{titleText:t.titleText}),{title:t.titleText};const m=o.media_type==="tv"?"tv":"movie",d=`${A}/${m}/${o.id}?api_key=${e}`,u=await M(d),b=m==="tv"?u.first_air_date??o.first_air_date:u.release_date??o.release_date,y=b?Number(b.slice(0,4)):void 0,g={title:u.title??u.name??t.titleText??"Unknown title",tmdbId:u.id,tmdbVoteAverage:u.vote_average,tmdbVoteCount:u.vote_count,posterPath:u.poster_path??void 0,releaseYear:Number.isNaN(y)?void 0:y,tmdbMediaType:m,tmdbGenres:Array.isArray(u.genres)?u.genres.map(h=>h.name.toLowerCase()):[]},{tmdbGenres:T,...f}=g;return i[a]={storedAt:Date.now(),data:f},await j(i),$("TMDb cached result",{cacheKey:a,tmdbId:g.tmdbId}),g},Q=t=>{const e=t.split("|");if(e.length===2){const a=Number(e[1]);return{title:e[0],year:Number.isNaN(a)?void 0:a}}return{title:t}},K=async(t,e,a)=>{const i=await V(),r=`${a}:${e}`,c=i[r];if(c&&Date.now()-c.storedAt<G)return c.data;const s=`${A}/${a}/${e}?api_key=${t}`,n=await M(s),l=a==="tv"?n.first_air_date:n.release_date,o=l?Number(l.slice(0,4)):void 0,m={tmdbId:e,mediaType:a,title:n.title??n.name,releaseYear:Number.isNaN(o)?void 0:o,genres:Array.isArray(n.genres)?n.genres.map(d=>d.name.toLowerCase()):[]};return i[r]={storedAt:Date.now(),data:m},await q(i),m},X=async(t,e,a,i)=>{var o;if(i){const m=Y(e,a),d=i[m];if((o=d==null?void 0:d.data)!=null&&o.tmdbId)return{tmdbId:d.data.tmdbId,title:d.data.title,releaseYear:d.data.releaseYear,mediaType:"movie"}}const r=new URLSearchParams({api_key:t,query:e});a&&r.set("year",String(a));const c=`${A}/search/movie?${r.toString()}`,s=await M(c),n=P((s==null?void 0:s.results)??[],e,a);if(!(n!=null&&n.id))return null;const l=n.release_date?Number(n.release_date.slice(0,4)):void 0;return{tmdbId:n.id,title:n.title,releaseYear:Number.isNaN(l)?void 0:l,mediaType:"movie"}},Z=async()=>{const t=await O();if(!t)return null;const e=await z(),a=await H();if(a&&Date.now()-a.storedAt<F&&a.lastImportAt&&(e!=null&&e.importedAt)&&a.lastImportAt===e.importedAt)return a;const i=await k(),r=await U(),c=Object.entries(i).filter(([,g])=>g.r!==void 0);if(!c.length)return null;let s=0,n=0;const l={},o={},m=300;for(const[g,T]of c.slice(0,m)){const f=T.r;if(f===void 0)continue;s+=f,n+=1;const{title:h,year:w}=Q(g);if(!h)continue;const v=await X(t,h,w,r);if(!v)continue;const S=await K(t,v.tmdbId,v.mediaType);if(!S)continue;const D=S.releaseYear??v.releaseYear??w,_=D?`${Math.floor(D/10)*10}s`:void 0;S.genres.forEach(x=>{l[x]||(l[x]={sum:0,count:0}),l[x].sum+=f,l[x].count+=1}),_&&(o[_]||(o[_]={sum:0,count:0}),o[_].sum+=f,o[_].count+=1)}const d=n?s/n:0,u={},b={};Object.entries(l).forEach(([g,{sum:T,count:f}])=>{const h=T/f;u[g]={avg:h,count:f,strength:h-d}}),Object.entries(o).forEach(([g,{sum:T,count:f}])=>{const h=T/f;b[g]={avg:h,count:f,strength:h-d}});const y={storedAt:Date.now(),lastImportAt:e==null?void 0:e.importedAt,meanRating:d,genreStats:u,decadeStats:b};return await W(y),y},tt=(t,e)=>{if(!t||!e.length)return{};let a=0,i=0;const r=[];if(e.forEach(o=>{const m=o.toLowerCase(),d=t.genreStats[m];if(!d)return;const u=Math.min(1,d.count/5),b=d.strength;a+=b*u,i+=u,b>0&&r.push({genre:m,strength:b})}),i===0)return{};const c=a/i,s=Math.round(Math.max(0,Math.min(100,50+c*20))),n=r.sort((o,m)=>m.strength-o.strength).slice(0,2).map(o=>o.genre),l=n.length>0?`Because you like ${n.join(", ")}`:void 0;return{matchScore:s,matchExplanation:l}},R=async(t,e,a)=>{const i=await k(),r=[E(t.titleText,t.year),E(e,a),E(t.titleText,void 0),E(e,void 0)].filter(c=>c);for(const c of r){const s=i[c];if(s)return{inWatchlist:s.w===1,userRating:s.r}}return{}};chrome.runtime.onInstalled.addListener(t=>{});chrome.runtime.onMessage.addListener((t,e,a)=>{if(t.type==="RESOLVE_TITLE"){const{requestId:i,payload:r}=t;return(async()=>{try{const c=await J(r),s=await R(r,c.title,c.releaseYear??r.year),n=await Z(),l=tt(n,c.tmdbGenres??[]),{tmdbGenres:o,...m}=c,d={type:"TITLE_RESOLVED",requestId:i,payload:{...m,...s,...l}};a(d)}catch{const s=await R(r,r.titleText??"Unknown title",r.year);a({type:"TITLE_RESOLVED",requestId:i,payload:{title:r.titleText??"Unknown title",...s}})}})(),!0}return!1});
//# sourceMappingURL=index.js.map
