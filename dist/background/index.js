import{b as R,l as I,S as h,n as L,a as v,p as U}from"../assets/normalize-nDA3_Ddb.js";const M="https://api.themoviedb.org/3",k=7*24*60*60*1e3,P=30*24*60*60*1e3,B=async()=>(await chrome.storage.local.get([h.TMDB_CACHE]))[h.TMDB_CACHE]??{},F=async t=>{await chrome.storage.local.set({[h.TMDB_CACHE]:t})},H=async()=>(await chrome.storage.local.get([h.TMDB_FEATURE_CACHE]))[h.TMDB_FEATURE_CACHE]??{},K=async t=>{await chrome.storage.local.set({[h.TMDB_FEATURE_CACHE]:t})},Y=async()=>{const e=(await chrome.storage.local.get([h.TMDB_API_KEY]))[h.TMDB_API_KEY];return e!=null&&e.trim()?e.trim():null},$=(t,e,r)=>{if(!t.length)return null;const i=L(e),a=t.find(s=>{const n=L(s.title??s.name),l=s.release_date??s.first_air_date,o=l?Number(l.slice(0,4)):void 0;return n===i&&r&&o===r});if(a)return a;const c=t.find(s=>L(s.title??s.name)===i);return c||t[0]},D=async t=>{const e=await fetch(t);if(!e.ok)throw new Error(`TMDb request failed: ${e.status}`);return e.json()},G=async t=>{const e=await Y();if(!e||!t.titleText)return{title:t.titleText??"Unknown title"};const r=R(t.titleText,t.year),i=await B(),a=i[r];if(a&&Date.now()-a.storedAt<k){const T=a.data.tmdbMediaType??"movie";if(a.data.tmdbId){const b=await N(e,a.data.tmdbId,T);return{...a.data,tmdbGenres:(b==null?void 0:b.genres)??[]}}return a.data}const c=new URLSearchParams({api_key:e,query:t.titleText}),s=`${M}/search/multi?${c.toString()}`,n=await D(s),l=((n==null?void 0:n.results)??[]).filter(T=>T.media_type==="movie"||T.media_type==="tv"),o=$(l,t.titleText,t.year);if(!(o!=null&&o.id))return I("TMDb no match",{titleText:t.titleText}),{title:t.titleText};const m=o.media_type==="tv"?"tv":"movie",d=`${M}/${m}/${o.id}?api_key=${e}`,u=await D(d),_=m==="tv"?u.first_air_date??o.first_air_date:u.release_date??o.release_date,E=_?Number(_.slice(0,4)):void 0,f={title:u.title??u.name??t.titleText??"Unknown title",tmdbId:u.id,tmdbVoteAverage:u.vote_average,tmdbVoteCount:u.vote_count,posterPath:u.poster_path??void 0,releaseYear:Number.isNaN(E)?void 0:E,tmdbMediaType:m,tmdbGenres:Array.isArray(u.genres)?u.genres.map(T=>T.name.toLowerCase()):[]},{tmdbGenres:w,...g}=f;return i[r]={storedAt:Date.now(),data:g},await F(i),I("TMDb cached result",{cacheKey:r,tmdbId:f.tmdbId}),f},N=async(t,e,r)=>{const i=await H(),a=`${r}:${e}`,c=i[a];if(c&&Date.now()-c.storedAt<P)return c.data;const s=`${M}/${r}/${e}?api_key=${t}`,n=await D(s),l=r==="tv"?n.first_air_date:n.release_date,o=l?Number(l.slice(0,4)):void 0,m={tmdbId:e,mediaType:r,title:n.title??n.name,releaseYear:Number.isNaN(o)?void 0:o,genres:Array.isArray(n.genres)?n.genres.map(d=>d.name.toLowerCase()):[]};return i[a]={storedAt:Date.now(),data:m},await K(i),m},X=async(t,e,r,i)=>{var o;if(i){const m=R(e,r),d=i[m];if((o=d==null?void 0:d.data)!=null&&o.tmdbId)return{tmdbId:d.data.tmdbId,title:d.data.title,releaseYear:d.data.releaseYear,mediaType:"movie"}}const a=new URLSearchParams({api_key:t,query:e});r&&a.set("year",String(r));const c=`${M}/search/movie?${a.toString()}`,s=await D(c),n=$((s==null?void 0:s.results)??[],e,r);if(!(n!=null&&n.id))return null;const l=n.release_date?Number(n.release_date.slice(0,4)):void 0;return{tmdbId:n.id,title:n.title,releaseYear:Number.isNaN(l)?void 0:l,mediaType:"movie"}},j=async()=>B(),V=24*60*60*1e3,O=async()=>(await chrome.storage.local.get([h.LETTERBOXD_INDEX]))[h.LETTERBOXD_INDEX]??{},q=async()=>(await chrome.storage.local.get([h.LETTERBOXD_STATS]))[h.LETTERBOXD_STATS]??null,z=async()=>(await chrome.storage.local.get([h.MATCH_PROFILE]))[h.MATCH_PROFILE]??null,W=async t=>{await chrome.storage.local.set({[h.MATCH_PROFILE]:t})},x=async(t,e,r)=>{const i=await O(),a=[v(t.titleText,t.year),v(e,r),v(t.titleText,void 0),v(e,void 0)].filter(c=>c);for(const c of a){const s=i[c];if(s)return{inWatchlist:s.w===1,userRating:s.r}}return{}},J=async()=>{const t=await Y();if(!t)return null;const e=await q(),r=await z();if(r&&Date.now()-r.storedAt<V&&r.lastImportAt&&(e!=null&&e.importedAt)&&r.lastImportAt===e.importedAt)return r;const i=await O(),a=await j(),c=Object.entries(i).filter(([,f])=>f.r!==void 0);if(!c.length)return null;let s=0,n=0;const l={},o={},m=300;for(const[f,w]of c.slice(0,m)){const g=w.r;if(g===void 0)continue;s+=g,n+=1;const{title:T,year:b}=U(f);if(!T)continue;const A=await X(t,T,b,a);if(!A)continue;const C=await N(t,A.tmdbId,A.mediaType);if(!C)continue;const S=C.releaseYear??A.releaseYear??b,y=S?`${Math.floor(S/10)*10}s`:void 0;C.genres.forEach(p=>{l[p]||(l[p]={sum:0,count:0}),l[p].sum+=g,l[p].count+=1}),y&&(o[y]||(o[y]={sum:0,count:0}),o[y].sum+=g,o[y].count+=1)}const d=n?s/n:0,u={},_={};Object.entries(l).forEach(([f,{sum:w,count:g}])=>{const T=w/g;u[f]={avg:T,count:g,strength:T-d}}),Object.entries(o).forEach(([f,{sum:w,count:g}])=>{const T=w/g;_[f]={avg:T,count:g,strength:T-d}});const E={storedAt:Date.now(),lastImportAt:e==null?void 0:e.importedAt,meanRating:d,genreStats:u,decadeStats:_};return await W(E),E},Q=(t,e)=>{if(!t||!e.length)return{};let r=0,i=0;const a=[];if(e.forEach(o=>{const m=o.toLowerCase(),d=t.genreStats[m];if(!d)return;const u=Math.min(1,d.count/5),_=d.strength;r+=_*u,i+=u,_>0&&a.push({genre:m,strength:_})}),i===0)return{};const c=r/i,s=Math.round(Math.max(0,Math.min(100,50+c*20))),n=a.sort((o,m)=>m.strength-o.strength).slice(0,2).map(o=>o.genre),l=n.length>0?`Because you like ${n.join(", ")}`:void 0;return{matchScore:s,matchExplanation:l}},Z=()=>{chrome.runtime.onMessage.addListener((t,e,r)=>{if(t.type==="RESOLVE_TITLE"){const{requestId:i,payload:a}=t;return(async()=>{try{const c=await G(a),s=await x(a,c.title,c.releaseYear??a.year),n=await J(),l=Q(n,c.tmdbGenres??[]),{tmdbGenres:o,...m}=c,d={type:"TITLE_RESOLVED",requestId:i,payload:{...m,...s,...l}};r(d)}catch{const s=await x(a,a.titleText??"Unknown title",a.year);r({type:"TITLE_RESOLVED",requestId:i,payload:{title:a.titleText??"Unknown title",...s}})}})(),!0}return!1})};chrome.runtime.onInstalled.addListener(t=>{});Z();
//# sourceMappingURL=index.js.map
