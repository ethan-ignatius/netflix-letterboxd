import{b as S,l as v,S as T,n as C,a as p,p as K,g as O}from"../assets/storage-Bn6SSwi1.js";const D="https://api.themoviedb.org/3",P=7*24*60*60*1e3,Y=30*24*60*60*1e3,B=async()=>(await chrome.storage.local.get([T.TMDB_CACHE]))[T.TMDB_CACHE]??{},k=async t=>{await chrome.storage.local.set({[T.TMDB_CACHE]:t})},F=async()=>(await chrome.storage.local.get([T.TMDB_FEATURE_CACHE]))[T.TMDB_FEATURE_CACHE]??{},H=async t=>{await chrome.storage.local.set({[T.TMDB_FEATURE_CACHE]:t})},R=async()=>{const e=(await chrome.storage.local.get([T.TMDB_API_KEY]))[T.TMDB_API_KEY];return e!=null&&e.trim()?e.trim():null},N=(t,e,n)=>{if(!t.length)return null;const a=C(e),r=t.find(i=>{const s=C(i.title??i.name),d=i.release_date??i.first_air_date,c=d?Number(d.slice(0,4)):void 0;return s===a&&n&&c===n});if(r)return r;const o=t.find(i=>C(i.title??i.name)===a);return o||t[0]},M=async t=>{const e=await fetch(t);if(!e.ok)throw new Error(`TMDb request failed: ${e.status}`);return e.json()},G=async t=>{const e=await R();if(!e||!t.titleText)return{title:t.titleText??"Unknown title"};const n=S(t.titleText,t.year),a=await B(),r=a[n];if(r&&Date.now()-r.storedAt<P){const h=r.data.tmdbMediaType??"movie";if(r.data.tmdbId){const w=await U(e,r.data.tmdbId,h);return{...r.data,tmdbGenres:(w==null?void 0:w.genres)??[]}}return r.data}const o=new URLSearchParams({api_key:e,query:t.titleText}),i=`${D}/search/multi?${o.toString()}`,s=await M(i),d=((s==null?void 0:s.results)??[]).filter(h=>h.media_type==="movie"||h.media_type==="tv"),c=N(d,t.titleText,t.year);if(!(c!=null&&c.id))return v("TMDb no match",{titleText:t.titleText}),{title:t.titleText};const u=c.media_type==="tv"?"tv":"movie",l=`${D}/${u}/${c.id}?api_key=${e}`,m=await M(l),g=u==="tv"?m.first_air_date??c.first_air_date:m.release_date??c.release_date,b=g?Number(g.slice(0,4)):void 0,f={title:m.title??m.name??t.titleText??"Unknown title",tmdbId:m.id,tmdbVoteAverage:m.vote_average,tmdbVoteCount:m.vote_count,posterPath:m.poster_path??void 0,releaseYear:Number.isNaN(b)?void 0:b,tmdbMediaType:u,tmdbGenres:Array.isArray(m.genres)?m.genres.map(h=>h.name.toLowerCase()):[]},{tmdbGenres:y,..._}=f;return a[n]={storedAt:Date.now(),data:_},await k(a),v("TMDb cached result",{cacheKey:n,tmdbId:f.tmdbId}),f},U=async(t,e,n)=>{const a=await F(),r=`${n}:${e}`,o=a[r];if(o&&Date.now()-o.storedAt<Y)return o.data;const i=`${D}/${n}/${e}?api_key=${t}`,s=await M(i),d=n==="tv"?s.first_air_date:s.release_date,c=d?Number(d.slice(0,4)):void 0,u={tmdbId:e,mediaType:n,title:s.title??s.name,releaseYear:Number.isNaN(c)?void 0:c,genres:Array.isArray(s.genres)?s.genres.map(l=>l.name.toLowerCase()):[]};return a[r]={storedAt:Date.now(),data:u},await H(a),u},j=async(t,e,n,a)=>{var c;if(a){const u=S(e,n),l=a[u];if((c=l==null?void 0:l.data)!=null&&c.tmdbId)return{tmdbId:l.data.tmdbId,title:l.data.title,releaseYear:l.data.releaseYear,mediaType:"movie"}}const r=new URLSearchParams({api_key:t,query:e});n&&r.set("year",String(n));const o=`${D}/search/movie?${r.toString()}`,i=await M(o),s=N((i==null?void 0:i.results)??[],e,n);if(!(s!=null&&s.id))return null;const d=s.release_date?Number(s.release_date.slice(0,4)):void 0;return{tmdbId:s.id,title:s.title,releaseYear:Number.isNaN(d)?void 0:d,mediaType:"movie"}},V=async()=>B(),X=24*60*60*1e3,$=async()=>O(),q=async()=>(await chrome.storage.local.get([T.LETTERBOXD_STATS]))[T.LETTERBOXD_STATS]??null,z=async()=>(await chrome.storage.local.get([T.MATCH_PROFILE]))[T.MATCH_PROFILE]??null,W=async t=>{await chrome.storage.local.set({[T.MATCH_PROFILE]:t})},x=async(t,e,n)=>{const a=await $();if(!a)return{};v("LB_INDEX_LOADED",{found:!0,updatedAt:a.updatedAt});const r=[p(t.titleText,t.year),p(e,n),p(t.titleText,void 0),p(e,void 0)].filter(o=>o);for(const o of r)if(a.watchlistKeys[o]||a.ratingsByKey[o]!==void 0)return{inWatchlist:a.watchlistKeys[o]===!0,userRating:a.ratingsByKey[o]};return v("LB_MATCH_NOT_FOUND",{keys:r,title:e??t.titleText}),{}},J=async()=>{const t=await R();if(!t)return null;const e=await q(),n=await z();if(n&&Date.now()-n.storedAt<X&&n.lastImportAt&&(e!=null&&e.importedAt)&&n.lastImportAt===e.importedAt)return n;const a=await $();if(!a)return null;const r=await V(),o=Object.entries(a.ratingsByKey);if(!o.length)return null;let i=0,s=0;const d={},c={},u=300;for(const[f,y]of o.slice(0,u)){i+=y,s+=1;const{title:_,year:h}=K(f);if(!_)continue;const w=await j(t,_,h,r);if(!w)continue;const L=await U(t,w.tmdbId,w.mediaType);if(!L)continue;const I=L.releaseYear??w.releaseYear??h,E=I?`${Math.floor(I/10)*10}s`:void 0;L.genres.forEach(A=>{d[A]||(d[A]={sum:0,count:0}),d[A].sum+=y,d[A].count+=1}),E&&(c[E]||(c[E]={sum:0,count:0}),c[E].sum+=y,c[E].count+=1)}const l=s?i/s:0,m={},g={};Object.entries(d).forEach(([f,{sum:y,count:_}])=>{const h=y/_;m[f]={avg:h,count:_,strength:h-l}}),Object.entries(c).forEach(([f,{sum:y,count:_}])=>{const h=y/_;g[f]={avg:h,count:_,strength:h-l}});const b={storedAt:Date.now(),lastImportAt:e==null?void 0:e.importedAt,meanRating:l,genreStats:m,decadeStats:g};return await W(b),b},Q=(t,e)=>{if(!t||!e.length)return{};let n=0,a=0;const r=[];if(e.forEach(c=>{const u=c.toLowerCase(),l=t.genreStats[u];if(!l)return;const m=Math.min(1,l.count/5),g=l.strength;n+=g*m,a+=m,g>0&&r.push({genre:u,strength:g})}),a===0)return{};const o=n/a,i=Math.round(Math.max(0,Math.min(100,50+o*20))),s=r.sort((c,u)=>u.strength-c.strength).slice(0,2).map(c=>c.genre),d=s.length>0?`Because you like ${s.join(", ")}`:void 0;return{matchScore:i,matchExplanation:d}},Z=()=>{chrome.runtime.onMessage.addListener((t,e,n)=>{if(t.type==="LB_INDEX_UPDATED")return(async()=>{await chrome.storage.local.remove([T.MATCH_PROFILE]);const a={type:"LB_INDEX_UPDATED_ACK",payload:{updatedAt:Date.now()}};try{chrome.runtime.sendMessage(a).catch(()=>{})}catch{}n(a)})(),!0;if(t.type==="RESOLVE_TITLE"){const{requestId:a,payload:r}=t;return(async()=>{try{const o=await G(r),i=await x(r,o.title,o.releaseYear??r.year),s=await J(),d=Q(s,o.tmdbGenres??[]),{tmdbGenres:c,...u}=o,l={type:"TITLE_RESOLVED",requestId:a,payload:{...u,...i,...d}};n(l)}catch{const i=await x(r,r.titleText??"Unknown title",r.year);n({type:"TITLE_RESOLVED",requestId:a,payload:{title:r.titleText??"Unknown title",...i}})}})(),!0}return!1})};chrome.runtime.onInstalled.addListener(t=>{});Z();
//# sourceMappingURL=index.js.map
