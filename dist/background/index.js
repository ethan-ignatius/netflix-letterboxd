import{S as y,b as B,l as A,n as S,a as L,c as D,p as $,g as V}from"../assets/storage-D8BXcNmO.js";const C="https://api.themoviedb.org/3",F=7*24*60*60*1e3,H=30*24*60*60*1e3,K=async()=>(await chrome.storage.local.get([y.TMDB_CACHE]))[y.TMDB_CACHE]??{},G=async t=>{await chrome.storage.local.set({[y.TMDB_CACHE]:t})},W=async()=>(await chrome.storage.local.get([y.TMDB_FEATURE_CACHE]))[y.TMDB_FEATURE_CACHE]??{},j=async t=>{await chrome.storage.local.set({[y.TMDB_FEATURE_CACHE]:t})},I=async()=>{const a=(await chrome.storage.local.get([y.TMDB_API_KEY]))[y.TMDB_API_KEY];return a!=null&&a.trim()?a.trim():null},P=(t,a,s)=>{if(!t.length)return null;const n=S(a),o=t.find(c=>{const e=S(c.title??c.name),l=c.release_date??c.first_air_date,i=l?Number(l.slice(0,4)):void 0;return e===n&&s&&i===s});if(o)return o;const r=t.find(c=>S(c.title??c.name)===n);return r||t[0]},M=async t=>{const a=await fetch(t);if(!a.ok)throw new Error(`TMDb request failed: ${a.status}`);return a.json()},R=async t=>{const a=await I();if(!a||!t.titleText)return{title:t.titleText??"Unknown title"};const s=B(t.titleText,t.year),n=await K(),o=n[s];if(o&&Date.now()-o.storedAt<F){const h=o.data.tmdbMediaType??"movie";if(o.data.tmdbId){const f=await U(a,o.data.tmdbId,h);return{...o.data,tmdbGenres:(f==null?void 0:f.genres)??[]}}return o.data}const r=new URLSearchParams({api_key:a,query:t.titleText}),c=`${C}/search/multi?${r.toString()}`,e=await M(c),l=((e==null?void 0:e.results)??[]).filter(h=>h.media_type==="movie"||h.media_type==="tv"),i=P(l,t.titleText,t.year);if(!(i!=null&&i.id))return A("TMDb no match",{titleText:t.titleText}),{title:t.titleText};const d=i.media_type==="tv"?"tv":"movie",u=`${C}/${d}/${i.id}?api_key=${a}`,m=await M(u),T=d==="tv"?m.first_air_date??i.first_air_date:m.release_date??i.release_date,w=T?Number(T.slice(0,4)):void 0,b={title:m.title??m.name??t.titleText??"Unknown title",tmdbId:m.id,tmdbVoteAverage:m.vote_average,tmdbVoteCount:m.vote_count,posterPath:m.poster_path??void 0,releaseYear:Number.isNaN(w)?void 0:w,tmdbMediaType:d,tmdbGenres:Array.isArray(m.genres)?m.genres.map(h=>h.name.toLowerCase()):[]},{tmdbGenres:g,..._}=b;return n[s]={storedAt:Date.now(),data:_},await G(n),A("TMDb cached result",{cacheKey:s,tmdbId:b.tmdbId}),b},U=async(t,a,s)=>{const n=await W(),o=`${s}:${a}`,r=n[o];if(r&&Date.now()-r.storedAt<H)return r.data;const c=`${C}/${s}/${a}?api_key=${t}`,e=await M(c),l=s==="tv"?e.first_air_date:e.release_date,i=l?Number(l.slice(0,4)):void 0,d={tmdbId:a,mediaType:s,title:e.title??e.name,releaseYear:Number.isNaN(i)?void 0:i,genres:Array.isArray(e.genres)?e.genres.map(u=>u.name.toLowerCase()):[]};return n[o]={storedAt:Date.now(),data:d},await j(n),d},q=async(t,a,s,n)=>{var i;if(n){const d=B(a,s),u=n[d];if((i=u==null?void 0:u.data)!=null&&i.tmdbId)return{tmdbId:u.data.tmdbId,title:u.data.title,releaseYear:u.data.releaseYear,mediaType:"movie"}}const o=new URLSearchParams({api_key:t,query:a});s&&o.set("year",String(s));const r=`${C}/search/movie?${o.toString()}`,c=await M(r),e=P((c==null?void 0:c.results)??[],a,s);if(!(e!=null&&e.id))return null;const l=e.release_date?Number(e.release_date.slice(0,4)):void 0;return{tmdbId:e.id,title:e.title,releaseYear:Number.isNaN(l)?void 0:l,mediaType:"movie"}},X=async()=>K(),z=24*60*60*1e3,N=async()=>V(),J=async()=>(await chrome.storage.local.get([y.LETTERBOXD_STATS]))[y.LETTERBOXD_STATS]??null,Q=async()=>(await chrome.storage.local.get([y.MATCH_PROFILE]))[y.MATCH_PROFILE]??null,Z=async t=>{await chrome.storage.local.set({[y.MATCH_PROFILE]:t})},v=async(t,a,s)=>{const n=await N();if(!n)return{};A("LB_INDEX_LOADED",{found:!0,updatedAt:n.updatedAt,ratingsCount:Object.keys(n.ratingsByKey).length,watchlistCount:Object.keys(n.watchlistKeys).length});const o=[L(t.titleText,t.year),L(a,s),L(t.titleText,void 0),L(a,void 0)].filter(e=>e),r=[D(t.titleText,t.year),D(a,s),D(t.titleText,void 0),D(a,void 0)].filter(e=>e),c=Array.from(new Set([...o,...r]));for(const e of c)if(n.watchlistKeys[e]||n.ratingsByKey[e]!==void 0)return{inWatchlist:n.watchlistKeys[e]===!0,userRating:n.ratingsByKey[e]};return A("LB_MATCH_NOT_FOUND",{attemptedKeys:c,title:a??t.titleText}),{}},k=async()=>{const t=await I();if(!t)return null;const a=await J(),s=await Q();if(s&&Date.now()-s.storedAt<z&&s.lastImportAt&&(a!=null&&a.importedAt)&&s.lastImportAt===a.importedAt)return s;const n=await N();if(!n)return null;const o=await X(),r=Object.entries(n.ratingsByKey);if(!r.length)return null;let c=0,e=0;const l={},i={},d=300;for(const[b,g]of r.slice(0,d)){c+=g,e+=1;const{title:_,year:h}=$(b);if(!_)continue;const f=await q(t,_,h,o);if(!f)continue;const x=await U(t,f.tmdbId,f.mediaType);if(!x)continue;const Y=x.releaseYear??f.releaseYear??h,E=Y?`${Math.floor(Y/10)*10}s`:void 0;x.genres.forEach(p=>{l[p]||(l[p]={sum:0,count:0}),l[p].sum+=g,l[p].count+=1}),E&&(i[E]||(i[E]={sum:0,count:0}),i[E].sum+=g,i[E].count+=1)}const u=e?c/e:0,m={},T={};Object.entries(l).forEach(([b,{sum:g,count:_}])=>{const h=g/_;m[b]={avg:h,count:_,strength:h-u}}),Object.entries(i).forEach(([b,{sum:g,count:_}])=>{const h=g/_;T[b]={avg:h,count:_,strength:h-u}});const w={storedAt:Date.now(),lastImportAt:a==null?void 0:a.importedAt,meanRating:u,genreStats:m,decadeStats:T};return await Z(w),w},O=(t,a)=>{if(!t||!a.length)return{matchPercent:null,becauseYouLike:[]};let s=0,n=0;const o=[];if(a.forEach(i=>{const d=i.toLowerCase(),u=t.genreStats[d];if(!u)return;const m=Math.min(1,u.count/5),T=u.strength;s+=T*m,n+=m,T>0&&o.push({genre:d,strength:T})}),n===0)return{matchPercent:null,becauseYouLike:[]};const r=s/n,c=Math.round(Math.max(0,Math.min(100,50+r*20))),e=o.sort((i,d)=>d.strength-i.strength).slice(0,2).map(i=>i.genre.replace(/\b\w/g,d=>d.toUpperCase())),l=e.length>0?`Because you like ${e.join(", ")}`:void 0;return{matchPercent:c,becauseYouLike:e,matchScore:c,matchExplanation:l}},tt=()=>{chrome.runtime.onMessage.addListener((t,a,s)=>{if(t.type==="LB_INDEX_UPDATED")return(async()=>{await chrome.storage.local.remove([y.MATCH_PROFILE]);const n={type:"LB_INDEX_UPDATED_ACK",payload:{updatedAt:Date.now()}};try{chrome.runtime.sendMessage(n).catch(()=>{})}catch{}s(n)})(),!0;if(t.type==="RESOLVE_OVERLAY_DATA"){const{requestId:n,extracted:o}=t,r=o;return(async()=>{try{if(!await I()){A("TMDB_KEY_MISSING");const m=await v(r,r.titleText,r.year),T={type:"OVERLAY_DATA_RESOLVED",requestId:n,error:"TMDB_KEY_MISSING",payload:{title:r.titleText??"Unknown title",year:r.year??null,tmdb:{id:null,voteAverage:null,voteCount:null},letterboxd:{inWatchlist:m.inWatchlist??!1,userRating:m.userRating??null,matchPercent:null,becauseYouLike:[]}}};s(T);return}const e=await R(r),l=await v(r,e.title,e.releaseYear??r.year),i=await k(),d=O(i,e.tmdbGenres??[]),u={type:"OVERLAY_DATA_RESOLVED",requestId:n,payload:{title:e.title??r.titleText??"Unknown title",year:e.releaseYear??r.year??null,tmdb:{id:e.tmdbId??null,voteAverage:e.tmdbVoteAverage??null,voteCount:e.tmdbVoteCount??null},letterboxd:{inWatchlist:l.inWatchlist??!1,userRating:l.userRating??null,matchPercent:d.matchPercent??null,becauseYouLike:d.becauseYouLike??[]}}};s(u)}catch{const e={type:"OVERLAY_DATA_RESOLVED",requestId:n,payload:{title:r.titleText??"Unknown title",year:r.year??null,tmdb:{id:null,voteAverage:null,voteCount:null},letterboxd:{inWatchlist:!1,userRating:null,matchPercent:null,becauseYouLike:[]}}};s(e)}})(),!0}if(t.type==="RESOLVE_TITLE"){const{requestId:n,payload:o}=t;return(async()=>{try{const r=await R(o),c=await v(o,r.title,r.releaseYear??o.year),e=await k(),l=O(e,r.tmdbGenres??[]),{tmdbGenres:i,...d}=r,u={type:"TITLE_RESOLVED",requestId:n,payload:{...d,...c,...l}};s(u)}catch{const c=await v(o,o.titleText??"Unknown title",o.year);s({type:"TITLE_RESOLVED",requestId:n,payload:{title:o.titleText??"Unknown title",...c}})}})(),!0}return!1})};chrome.runtime.onInstalled.addListener(t=>{});tt();
//# sourceMappingURL=index.js.map
