import{l as y,b as Y,S as _,n as I,a as C,c as M,p as H,g as F}from"../assets/storage-CcVRV5ek.js";const p="https://api.themoviedb.org/3",V=7*24*60*60*1e3,z=30*24*60*60*1e3,P=async()=>(await chrome.storage.local.get([_.TMDB_CACHE]))[_.TMDB_CACHE]??{},G=async e=>{await chrome.storage.local.set({[_.TMDB_CACHE]:e})},X=async()=>(await chrome.storage.local.get([_.TMDB_FEATURE_CACHE]))[_.TMDB_FEATURE_CACHE]??{},j=async e=>{await chrome.storage.local.set({[_.TMDB_FEATURE_CACHE]:e})},K=async()=>{const t=(await chrome.storage.local.get([_.TMDB_API_KEY]))[_.TMDB_API_KEY];return t!=null&&t.trim()?t.trim():null},W=(e,t)=>{if(!e||!t)return 0;if(e===t)return 1;if(e.includes(t)||t.includes(e))return .8;const a=new Set(e.split(" ").filter(Boolean)),r=new Set(t.split(" ").filter(Boolean));if(!a.size||!r.size)return 0;let i=0;a.forEach(l=>{r.has(l)&&(i+=1)});const s=new Set([...a,...r]).size;return s?i/s:0},N=(e,t,a)=>{const r=t.title??t.name??"",i=I(r),s=e.normalizedTitle||I(e.rawTitle);let c=W(s,i)*100;const o=t.release_date??t.first_air_date,n=o?Number(o.slice(0,4)):void 0;if(e.year&&n){const d=Math.abs(e.year-n);d===0?c+=20:d===1?c+=8:c-=Math.min(20,d*4)}return e.isSeries===!0&&(c+=a==="tv"?10:-10),e.isSeries===!1&&(c+=a==="movie"?10:-10),{score:c,candidateTitle:r,candidateYear:n}},k=(e,t,a)=>{if(!t.length)return null;let r=null;return t.forEach(i=>{if(!i.id)return;const{score:s}=N(e,i,a);(!r||s>r.score)&&(r={result:i,score:s})}),!r||r.score<50?null:r.result},A=async e=>{const t=await fetch(e);if(!t.ok)throw new Error(`TMDb request failed: ${t.status}`);return t.json()},q=e=>{if("rawTitle"in e)return e;const t=e.titleText??"Unknown title";return{rawTitle:t,normalizedTitle:I(t),year:e.year??null,isSeries:void 0,netflixId:e.netflixTitleId??null,href:e.href??null}},Q=(e,t)=>{let a=null;return t.forEach(r=>{const i=r.media_type==="tv"?"tv":r.media_type==="movie"?"movie":null;if(!i||!r.id)return;const{score:s}=N(e,r,i);(!a||s>a.score)&&(a={result:r,mediaType:i,score:s})}),!a||a.score<50?null:a},R=async e=>{const t=await K(),a=q(e);if(!t||!a.rawTitle)return y("TMDb resolve skipped (missing api key or title)",{hasKey:!!t,info:a}),{title:a.rawTitle??"Unknown title"};const r=Y(a.rawTitle,a.year??void 0),i=await P(),s=i[r];if(s&&Date.now()-s.storedAt<V){y("TMDb cache hit",{cacheKey:r});const m=s.data.tmdbMediaType??"movie";if(s.data.tmdbId){const T=await x(t,s.data.tmdbId,m);return{...s.data,tmdbGenres:(T==null?void 0:T.genres)??[]}}return s.data}const l=a.rawTitle,c=a.year??void 0,o=a.isSeries===!0?"tv":a.isSeries===!1?"movie":"multi";y("TMDB_SEARCH_REQUEST",{query:l,year:c,mediaType:o});let n=null,d=null;if(o==="tv"){const m=new URLSearchParams({api_key:t,query:l,...c?{first_air_date_year:String(c)}:{}}),T=`${p}/search/tv?${m.toString()}`,h=await A(T);n=k(a,(h==null?void 0:h.results)??[],"tv"),d=n?"tv":null}else if(o==="movie"){const m=new URLSearchParams({api_key:t,query:l,...c?{year:String(c)}:{}}),T=`${p}/search/movie?${m.toString()}`,h=await A(T);n=k(a,(h==null?void 0:h.results)??[],"movie"),d=n?"movie":null}if(!n){const m=new URLSearchParams({api_key:t,query:l}),T=`${p}/search/multi?${m.toString()}`,h=await A(T),S=((h==null?void 0:h.results)??[]).filter(v=>v.media_type==="movie"||v.media_type==="tv"),b=Q(a,S);b&&(n=b.result,d=b.mediaType)}if(!(n!=null&&n.id)||!d)return y("TMDB_NO_MATCH",{titleText:a.rawTitle,year:c,mediaType:o}),{title:a.rawTitle};const f=`${p}/${d}/${n.id}?api_key=${t}`;y("TMDB_SEARCH_CHOSEN",{title:n.title??n.name,year:n.release_date??n.first_air_date,mediaType:d});const u=await A(f),D=d==="tv"?u.first_air_date??n.first_air_date:u.release_date??n.release_date,L=D?Number(D.slice(0,4)):void 0,g={title:u.title??u.name??a.rawTitle??"Unknown title",tmdbId:u.id,tmdbVoteAverage:u.vote_average,tmdbVoteCount:u.vote_count,posterPath:u.poster_path??void 0,releaseYear:Number.isNaN(L)?void 0:L,tmdbMediaType:d,tmdbGenres:Array.isArray(u.genres)?u.genres.map(m=>m.name.toLowerCase()):[]},{tmdbGenres:E,...w}=g;return i[r]={storedAt:Date.now(),data:w},await G(i),y("TMDb cached result",{cacheKey:r,tmdbId:g.tmdbId}),g},x=async(e,t,a)=>{const r=await X(),i=`${a}:${t}`,s=r[i];if(s&&Date.now()-s.storedAt<z)return s.data;const l=`${p}/${a}/${t}?api_key=${e}`,c=await A(l),o=a==="tv"?c.first_air_date:c.release_date,n=o?Number(o.slice(0,4)):void 0,d={tmdbId:t,mediaType:a,title:c.title??c.name,releaseYear:Number.isNaN(n)?void 0:n,genres:Array.isArray(c.genres)?c.genres.map(f=>f.name.toLowerCase()):[]};return r[i]={storedAt:Date.now(),data:d},await j(r),d},J=async(e,t,a,r)=>{var d;if(r){const f=Y(t,a),u=r[f];if((d=u==null?void 0:u.data)!=null&&d.tmdbId)return{tmdbId:u.data.tmdbId,title:u.data.title,releaseYear:u.data.releaseYear,mediaType:"movie"}}const i=new URLSearchParams({api_key:e,query:t});a&&i.set("year",String(a));const s=`${p}/search/movie?${i.toString()}`,l=await A(s),c={rawTitle:t,normalizedTitle:I(t),year:a??null,isSeries:!1},o=k(c,(l==null?void 0:l.results)??[],"movie");if(!(o!=null&&o.id))return null;const n=o.release_date?Number(o.release_date.slice(0,4)):void 0;return{tmdbId:o.id,title:o.title,releaseYear:Number.isNaN(n)?void 0:n,mediaType:"movie"}},Z=async()=>P(),ee=24*60*60*1e3,$=async()=>F(),te=async()=>(await chrome.storage.local.get([_.LETTERBOXD_STATS]))[_.LETTERBOXD_STATS]??null,ae=async()=>(await chrome.storage.local.get([_.MATCH_PROFILE]))[_.MATCH_PROFILE]??null,re=async e=>{await chrome.storage.local.set({[_.MATCH_PROFILE]:e})},B=async(e,t,a)=>{const r=await $();if(!r)return y("LB_INDEX_LOADED",{found:!1}),{};y("LB_INDEX_LOADED",{found:!0,updatedAt:r.updatedAt,ratingsCount:Object.keys(r.ratingsByKey).length,watchlistCount:Object.keys(r.watchlistKeys).length});const i="rawTitle"in e?e.rawTitle:e.titleText,s="rawTitle"in e?e.year??void 0:e.year,l=[C(i,s),C(t,a),C(i,void 0),C(t,void 0)].filter(n=>n),c=[M(i,s),M(t,a),M(i,void 0),M(t,void 0)].filter(n=>n),o=Array.from(new Set([...l,...c]));y("LB_MATCH_KEYS",{attemptedKeys:o});for(const n of o)if(r.watchlistKeys[n]||r.ratingsByKey[n]!==void 0)return y("LB_MATCH_FOUND",{key:n}),{inWatchlist:r.watchlistKeys[n]===!0,userRating:r.ratingsByKey[n]};return y("LB_MATCH_NOT_FOUND",{attemptedKeys:o,title:t??i}),{}},O=async()=>{const e=await K();if(!e)return null;const t=await te(),a=await ae();if(a&&Date.now()-a.storedAt<ee&&a.lastImportAt&&(t!=null&&t.importedAt)&&a.lastImportAt===t.importedAt)return a;const r=await $();if(!r)return null;const i=await Z(),s=Object.entries(r.ratingsByKey);if(!s.length)return null;let l=0,c=0;const o={},n={},d=300;for(const[g,E]of s.slice(0,d)){l+=E,c+=1;const{title:w,year:m}=H(g);if(!w)continue;const T=await J(e,w,m,i);if(!T)continue;const h=await x(e,T.tmdbId,T.mediaType);if(!h)continue;const S=h.releaseYear??T.releaseYear??m,b=S?`${Math.floor(S/10)*10}s`:void 0;h.genres.forEach(v=>{o[v]||(o[v]={sum:0,count:0}),o[v].sum+=E,o[v].count+=1}),b&&(n[b]||(n[b]={sum:0,count:0}),n[b].sum+=E,n[b].count+=1)}const f=c?l/c:0,u={},D={};Object.entries(o).forEach(([g,{sum:E,count:w}])=>{const m=E/w;u[g]={avg:m,count:w,strength:m-f}}),Object.entries(n).forEach(([g,{sum:E,count:w}])=>{const m=E/w;D[g]={avg:m,count:w,strength:m-f}});const L={storedAt:Date.now(),lastImportAt:t==null?void 0:t.importedAt,meanRating:f,genreStats:u,decadeStats:D};return await re(L),L},U=(e,t)=>{if(!e||!t.length)return{matchPercent:null,becauseYouLike:[]};let a=0,r=0;const i=[];if(t.forEach(o=>{const n=o.toLowerCase(),d=e.genreStats[n];if(!d)return;const f=Math.min(1,d.count/5),u=d.strength;a+=u*f,r+=f,u>0&&i.push({genre:n,strength:u})}),r===0)return{matchPercent:null,becauseYouLike:[]};const s=a/r,l=Math.round(Math.max(0,Math.min(100,50+s*20))),c=i.sort((o,n)=>n.strength-o.strength).slice(0,2).map(o=>o.genre.replace(/\b\w/g,n=>n.toUpperCase()));return{matchPercent:l,becauseYouLike:c}},ne=()=>{chrome.runtime.onMessage.addListener((e,t,a)=>{if(y("Background received message",{message:e,sender:t}),e.type==="LB_INDEX_UPDATED")return(async()=>{await chrome.storage.local.remove([_.MATCH_PROFILE]),y("LB_INDEX_UPDATED");const r={type:"LB_INDEX_UPDATED_ACK",payload:{updatedAt:Date.now()}};try{chrome.runtime.sendMessage(r).catch(()=>{})}catch{}a(r)})(),!0;if(e.type==="RESOLVE_OVERLAY_DATA"){const{requestId:r,payload:i}=e;return(async()=>{try{const s=await R(i),l=await B(i,s.title,s.releaseYear??i.year??void 0),c=await O(),o=U(c,s.tmdbGenres??[]),n={type:"OVERLAY_DATA_RESOLVED",requestId:r,payload:{title:s.title??i.rawTitle??"Unknown title",year:s.releaseYear??i.year??null,tmdb:{id:s.tmdbId??null,voteAverage:s.tmdbVoteAverage??null,voteCount:s.tmdbVoteCount??null},letterboxd:{inWatchlist:l.inWatchlist??!1,userRating:l.userRating??null,matchPercent:o.matchPercent??null,becauseYouLike:o.becauseYouLike??[]}}};a(n)}catch(s){y("Overlay resolve failed",{error:s});const l={type:"OVERLAY_DATA_RESOLVED",requestId:r,payload:{title:i.rawTitle??"Unknown title",year:i.year??null,tmdb:{id:null,voteAverage:null,voteCount:null},letterboxd:{inWatchlist:!1,userRating:null,matchPercent:null,becauseYouLike:[]}}};a(l)}})(),!0}if(e.type==="RESOLVE_TITLE"){const{requestId:r,payload:i}=e;return(async()=>{try{const s=await R(i),l=await B(i,s.title,s.releaseYear??i.year),c=await O(),o=U(c,s.tmdbGenres??[]),{tmdbGenres:n,...d}=s,f={type:"TITLE_RESOLVED",requestId:r,payload:{...d,...l,...o}};a(f)}catch(s){y("TMDb resolve failed",{error:s});const l=await B(i,i.titleText??"Unknown title",i.year);a({type:"TITLE_RESOLVED",requestId:r,payload:{title:i.titleText??"Unknown title",...l}})}})(),!0}return!1})};chrome.runtime.onInstalled.addListener(e=>{y("Extension installed",e)});ne();
//# sourceMappingURL=index.js.map
