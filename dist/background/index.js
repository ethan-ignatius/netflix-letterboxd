import{b as k,l as v,S as y,n as x,a as L,c as p,p as $,g as F}from"../assets/storage-D8BXcNmO.js";const D="https://api.themoviedb.org/3",H=7*24*60*60*1e3,V=30*24*60*60*1e3,B=async()=>(await chrome.storage.local.get([y.TMDB_CACHE]))[y.TMDB_CACHE]??{},G=async t=>{await chrome.storage.local.set({[y.TMDB_CACHE]:t})},j=async()=>(await chrome.storage.local.get([y.TMDB_FEATURE_CACHE]))[y.TMDB_FEATURE_CACHE]??{},W=async t=>{await chrome.storage.local.set({[y.TMDB_FEATURE_CACHE]:t})},P=async()=>{const e=(await chrome.storage.local.get([y.TMDB_API_KEY]))[y.TMDB_API_KEY];return e!=null&&e.trim()?e.trim():null},K=(t,e,s)=>{if(!t.length)return null;const n=x(e),a=t.find(c=>{const r=x(c.title??c.name),l=c.release_date??c.first_air_date,i=l?Number(l.slice(0,4)):void 0;return r===n&&s&&i===s});if(a)return a;const o=t.find(c=>x(c.title??c.name)===n);return o||t[0]},C=async t=>{const e=await fetch(t);if(!e.ok)throw new Error(`TMDb request failed: ${e.status}`);return e.json()},Y=async t=>{const e=await P();if(!e||!t.titleText)return{title:t.titleText??"Unknown title"};const s=k(t.titleText,t.year),n=await B(),a=n[s];if(a&&Date.now()-a.storedAt<H){const h=a.data.tmdbMediaType??"movie";if(a.data.tmdbId){const b=await U(e,a.data.tmdbId,h);return{...a.data,tmdbGenres:(b==null?void 0:b.genres)??[]}}return a.data}const o=new URLSearchParams({api_key:e,query:t.titleText}),c=`${D}/search/multi?${o.toString()}`,r=await C(c),l=((r==null?void 0:r.results)??[]).filter(h=>h.media_type==="movie"||h.media_type==="tv"),i=K(l,t.titleText,t.year);if(!(i!=null&&i.id))return v("TMDb no match",{titleText:t.titleText}),{title:t.titleText};const m=i.media_type==="tv"?"tv":"movie",d=`${D}/${m}/${i.id}?api_key=${e}`,u=await C(d),f=m==="tv"?u.first_air_date??i.first_air_date:u.release_date??i.release_date,w=f?Number(f.slice(0,4)):void 0,g={title:u.title??u.name??t.titleText??"Unknown title",tmdbId:u.id,tmdbVoteAverage:u.vote_average,tmdbVoteCount:u.vote_count,posterPath:u.poster_path??void 0,releaseYear:Number.isNaN(w)?void 0:w,tmdbMediaType:m,tmdbGenres:Array.isArray(u.genres)?u.genres.map(h=>h.name.toLowerCase()):[]},{tmdbGenres:_,...T}=g;return n[s]={storedAt:Date.now(),data:T},await G(n),v("TMDb cached result",{cacheKey:s,tmdbId:g.tmdbId}),g},U=async(t,e,s)=>{const n=await j(),a=`${s}:${e}`,o=n[a];if(o&&Date.now()-o.storedAt<V)return o.data;const c=`${D}/${s}/${e}?api_key=${t}`,r=await C(c),l=s==="tv"?r.first_air_date:r.release_date,i=l?Number(l.slice(0,4)):void 0,m={tmdbId:e,mediaType:s,title:r.title??r.name,releaseYear:Number.isNaN(i)?void 0:i,genres:Array.isArray(r.genres)?r.genres.map(d=>d.name.toLowerCase()):[]};return n[a]={storedAt:Date.now(),data:m},await W(n),m},q=async(t,e,s,n)=>{var i;if(n){const m=k(e,s),d=n[m];if((i=d==null?void 0:d.data)!=null&&i.tmdbId)return{tmdbId:d.data.tmdbId,title:d.data.title,releaseYear:d.data.releaseYear,mediaType:"movie"}}const a=new URLSearchParams({api_key:t,query:e});s&&a.set("year",String(s));const o=`${D}/search/movie?${a.toString()}`,c=await C(o),r=K((c==null?void 0:c.results)??[],e,s);if(!(r!=null&&r.id))return null;const l=r.release_date?Number(r.release_date.slice(0,4)):void 0;return{tmdbId:r.id,title:r.title,releaseYear:Number.isNaN(l)?void 0:l,mediaType:"movie"}},X=async()=>B(),z=24*60*60*1e3,N=async()=>F(),J=async()=>(await chrome.storage.local.get([y.LETTERBOXD_STATS]))[y.LETTERBOXD_STATS]??null,Q=async()=>(await chrome.storage.local.get([y.MATCH_PROFILE]))[y.MATCH_PROFILE]??null,Z=async t=>{await chrome.storage.local.set({[y.MATCH_PROFILE]:t})},I=async(t,e,s)=>{const n=await N();if(!n)return{};v("LB_INDEX_LOADED",{found:!0,updatedAt:n.updatedAt,ratingsCount:Object.keys(n.ratingsByKey).length,watchlistCount:Object.keys(n.watchlistKeys).length});const a=[L(t.titleText,t.year),L(e,s),L(t.titleText,void 0),L(e,void 0)].filter(r=>r),o=[p(t.titleText,t.year),p(e,s),p(t.titleText,void 0),p(e,void 0)].filter(r=>r),c=Array.from(new Set([...a,...o]));for(const r of c)if(n.watchlistKeys[r]||n.ratingsByKey[r]!==void 0)return{inWatchlist:n.watchlistKeys[r]===!0,userRating:n.ratingsByKey[r]};return v("LB_MATCH_NOT_FOUND",{attemptedKeys:c,title:e??t.titleText}),{}},R=async()=>{const t=await P();if(!t)return null;const e=await J(),s=await Q();if(s&&Date.now()-s.storedAt<z&&s.lastImportAt&&(e!=null&&e.importedAt)&&s.lastImportAt===e.importedAt)return s;const n=await N();if(!n)return null;const a=await X(),o=Object.entries(n.ratingsByKey);if(!o.length)return null;let c=0,r=0;const l={},i={},m=300;for(const[g,_]of o.slice(0,m)){c+=_,r+=1;const{title:T,year:h}=$(g);if(!T)continue;const b=await q(t,T,h,a);if(!b)continue;const M=await U(t,b.tmdbId,b.mediaType);if(!M)continue;const S=M.releaseYear??b.releaseYear??h,A=S?`${Math.floor(S/10)*10}s`:void 0;M.genres.forEach(E=>{l[E]||(l[E]={sum:0,count:0}),l[E].sum+=_,l[E].count+=1}),A&&(i[A]||(i[A]={sum:0,count:0}),i[A].sum+=_,i[A].count+=1)}const d=r?c/r:0,u={},f={};Object.entries(l).forEach(([g,{sum:_,count:T}])=>{const h=_/T;u[g]={avg:h,count:T,strength:h-d}}),Object.entries(i).forEach(([g,{sum:_,count:T}])=>{const h=_/T;f[g]={avg:h,count:T,strength:h-d}});const w={storedAt:Date.now(),lastImportAt:e==null?void 0:e.importedAt,meanRating:d,genreStats:u,decadeStats:f};return await Z(w),w},O=(t,e)=>{if(!t||!e.length)return{matchPercent:null,becauseYouLike:[]};let s=0,n=0;const a=[];if(e.forEach(l=>{const i=l.toLowerCase(),m=t.genreStats[i];if(!m)return;const d=Math.min(1,m.count/5),u=m.strength;s+=u*d,n+=d,u>0&&a.push({genre:i,strength:u})}),n===0)return{matchPercent:null,becauseYouLike:[]};const o=s/n,c=Math.round(Math.max(0,Math.min(100,50+o*20))),r=a.sort((l,i)=>i.strength-l.strength).slice(0,2).map(l=>l.genre.replace(/\b\w/g,i=>i.toUpperCase()));return{matchPercent:c,becauseYouLike:r}},tt=()=>{chrome.runtime.onMessage.addListener((t,e,s)=>{if(t.type==="LB_INDEX_UPDATED")return(async()=>{await chrome.storage.local.remove([y.MATCH_PROFILE]);const n={type:"LB_INDEX_UPDATED_ACK",payload:{updatedAt:Date.now()}};try{chrome.runtime.sendMessage(n).catch(()=>{})}catch{}s(n)})(),!0;if(t.type==="RESOLVE_OVERLAY_DATA"){const{requestId:n,payload:a}=t;return(async()=>{try{const o=await Y(a),c=await I(a,o.title,o.releaseYear??a.year),r=await R(),l=O(r,o.tmdbGenres??[]),i={type:"OVERLAY_DATA_RESOLVED",requestId:n,payload:{title:o.title??a.titleText??"Unknown title",year:o.releaseYear??a.year??null,tmdb:{id:o.tmdbId??null,voteAverage:o.tmdbVoteAverage??null,voteCount:o.tmdbVoteCount??null},letterboxd:{inWatchlist:c.inWatchlist??!1,userRating:c.userRating??null,matchPercent:l.matchPercent??null,becauseYouLike:l.becauseYouLike??[]}}};s(i)}catch{const c={type:"OVERLAY_DATA_RESOLVED",requestId:n,payload:{title:a.titleText??"Unknown title",year:a.year??null,tmdb:{id:null,voteAverage:null,voteCount:null},letterboxd:{inWatchlist:!1,userRating:null,matchPercent:null,becauseYouLike:[]}}};s(c)}})(),!0}if(t.type==="RESOLVE_TITLE"){const{requestId:n,payload:a}=t;return(async()=>{try{const o=await Y(a),c=await I(a,o.title,o.releaseYear??a.year),r=await R(),l=O(r,o.tmdbGenres??[]),{tmdbGenres:i,...m}=o,d={type:"TITLE_RESOLVED",requestId:n,payload:{...m,...c,...l}};s(d)}catch{const c=await I(a,a.titleText??"Unknown title",a.year);s({type:"TITLE_RESOLVED",requestId:n,payload:{title:a.titleText??"Unknown title",...c}})}})(),!0}return!1})};chrome.runtime.onInstalled.addListener(t=>{});tt();
//# sourceMappingURL=index.js.map
