import{l as m,S as h,s as qe,d as We,m as Oe}from"../assets/storage-CcVRV5ek.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))n(o);new MutationObserver(o=>{for(const i of o)if(i.type==="childList")for(const s of i.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&n(s)}).observe(document,{childList:!0,subtree:!0});function r(o){const i={};return o.integrity&&(i.integrity=o.integrity),o.referrerPolicy&&(i.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?i.credentials="include":o.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function n(o){if(o.ep)return;o.ep=!0;const i=r(o);fetch(o.href,i)}})();var p=Uint8Array,P=Uint16Array,Qe=Int32Array,_e=new p([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),Me=new p([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),je=new p([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),Fe=function(e,t){for(var r=new P(31),n=0;n<31;++n)r[n]=t+=1<<e[n-1];for(var o=new Qe(r[30]),n=1;n<30;++n)for(var i=r[n];i<r[n+1];++i)o[i]=i-r[n]<<5|n;return{b:r,r:o}},Ke=Fe(_e,2),ze=Ke.b,Je=Ke.r;ze[28]=258,Je[258]=28;var et=Fe(Me,0),tt=et.b,de=new P(32768);for(var v=0;v<32768;++v){var T=(v&43690)>>1|(v&21845)<<1;T=(T&52428)>>2|(T&13107)<<2,T=(T&61680)>>4|(T&3855)<<4,de[v]=((T&65280)>>8|(T&255)<<8)>>1}var H=function(e,t,r){for(var n=e.length,o=0,i=new P(t);o<n;++o)e[o]&&++i[e[o]-1];var s=new P(t);for(o=1;o<t;++o)s[o]=s[o-1]+i[o-1]<<1;var c;if(r){c=new P(1<<t);var l=15-t;for(o=0;o<n;++o)if(e[o])for(var f=o<<4|e[o],d=t-e[o],a=s[e[o]-1]++<<d,u=a|(1<<d)-1;a<=u;++a)c[de[a]>>l]=f}else for(c=new P(n),o=0;o<n;++o)e[o]&&(c[o]=de[s[e[o]-1]++]>>15-e[o]);return c},Y=new p(288);for(var v=0;v<144;++v)Y[v]=8;for(var v=144;v<256;++v)Y[v]=9;for(var v=256;v<280;++v)Y[v]=7;for(var v=280;v<288;++v)Y[v]=8;var Re=new p(32);for(var v=0;v<32;++v)Re[v]=5;var rt=H(Y,9,1),nt=H(Re,5,1),re=function(e){for(var t=e[0],r=1;r<e.length;++r)e[r]>t&&(t=e[r]);return t},E=function(e,t,r){var n=t/8|0;return(e[n]|e[n+1]<<8)>>(t&7)&r},ne=function(e,t){var r=t/8|0;return(e[r]|e[r+1]<<8|e[r+2]<<16)>>(t&7)},ot=function(e){return(e+7)/8|0},ye=function(e,t,r){return(t==null||t<0)&&(t=0),(r==null||r>e.length)&&(r=e.length),new p(e.subarray(t,r))},at=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],y=function(e,t,r){var n=new Error(t||at[e]);if(n.code=e,Error.captureStackTrace&&Error.captureStackTrace(n,y),!r)throw n;return n},it=function(e,t,r,n){var o=e.length,i=n?n.length:0;if(!o||t.f&&!t.l)return r||new p(0);var s=!r,c=s||t.i!=2,l=t.i;s&&(r=new p(o*3));var f=function(Te){var be=r.length;if(Te>be){var Be=new p(Math.max(be*2,Te));Be.set(r),r=Be}},d=t.f||0,a=t.p||0,u=t.b||0,C=t.l,B=t.d,b=t.m,L=t.n,V=o*8;do{if(!C){d=E(e,a,1);var G=E(e,a+1,3);if(a+=3,G)if(G==1)C=rt,B=nt,b=9,L=5;else if(G==2){var Q=E(e,a,31)+257,Ee=E(e,a+10,15)+4,we=Q+E(e,a+5,31)+1;a+=14;for(var z=new p(we),j=new p(19),g=0;g<Ee;++g)j[je[g]]=E(e,a+g*3,7);a+=Ee*3;for(var Ce=re(j),Ye=(1<<Ce)-1,Ze=H(j,Ce,1),g=0;g<we;){var Le=Ze[E(e,a,Ye)];a+=Le&15;var x=Le>>4;if(x<16)z[g++]=x;else{var S=0,Z=0;for(x==16?(Z=3+E(e,a,3),a+=2,S=z[g-1]):x==17?(Z=3+E(e,a,7),a+=3):x==18&&(Z=11+E(e,a,127),a+=7);Z--;)z[g++]=S}}var xe=z.subarray(0,Q),k=z.subarray(Q);b=re(xe),L=re(k),C=H(xe,b,1),B=H(k,L,1)}else y(1);else{var x=ot(a)+4,q=e[x-4]|e[x-3]<<8,W=x+q;if(W>o){l&&y(0);break}c&&f(u+q),r.set(e.subarray(x,W),u),t.b=u+=q,t.p=a=W*8,t.f=d;continue}if(a>V){l&&y(0);break}}c&&f(u+131072);for(var $e=(1<<b)-1,Ve=(1<<L)-1,J=a;;J=a){var S=C[ne(e,a)&$e],D=S>>4;if(a+=S&15,a>V){l&&y(0);break}if(S||y(2),D<256)r[u++]=D;else if(D==256){J=a,C=null;break}else{var Ae=D-254;if(D>264){var g=D-257,R=_e[g];Ae=E(e,a,(1<<R)-1)+ze[g],a+=R}var ee=B[ne(e,a)&Ve],te=ee>>4;ee||y(3),a+=ee&15;var k=tt[te];if(te>3){var R=Me[te];k+=ne(e,a)&(1<<R)-1,a+=R}if(a>V){l&&y(0);break}c&&f(u+131072);var Ie=u+Ae;if(u<k){var ke=i-k,Ge=Math.min(k,Ie);for(ke+u<0&&y(3);u<Ge;++u)r[u]=n[ke+u]}for(;u<Ie;++u)r[u]=r[u-k]}}t.l=C,t.p=J,t.b=u,t.f=d,C&&(d=1,t.m=b,t.d=B,t.n=L)}while(!d);return u!=r.length&&s?ye(r,0,u):r.subarray(0,u)},st=new p(0),A=function(e,t){return e[t]|e[t+1]<<8},w=function(e,t){return(e[t]|e[t+1]<<8|e[t+2]<<16|e[t+3]<<24)>>>0},oe=function(e,t){return w(e,t)+w(e,t+4)*4294967296};function ct(e,t){return it(e,{i:2},t&&t.out,t&&t.dictionary)}var ve=typeof TextDecoder<"u"&&new TextDecoder,lt=0;try{ve.decode(st,{stream:!0}),lt=1}catch{}var ft=function(e){for(var t="",r=0;;){var n=e[r++],o=(n>127)+(n>223)+(n>239);if(r+o>e.length)return{s:t,r:ye(e,r-1)};o?o==3?(n=((n&15)<<18|(e[r++]&63)<<12|(e[r++]&63)<<6|e[r++]&63)-65536,t+=String.fromCharCode(55296|n>>10,56320|n&1023)):o&1?t+=String.fromCharCode((n&31)<<6|e[r++]&63):t+=String.fromCharCode((n&15)<<12|(e[r++]&63)<<6|e[r++]&63):t+=String.fromCharCode(n)}};function me(e,t){if(t){for(var r="",n=0;n<e.length;n+=16384)r+=String.fromCharCode.apply(null,e.subarray(n,n+16384));return r}else{if(ve)return ve.decode(e);var o=ft(e),i=o.s,r=o.r;return r.length&&y(8),i}}var ut=function(e,t){return t+30+A(e,t+26)+A(e,t+28)},dt=function(e,t,r){var n=A(e,t+28),o=me(e.subarray(t+46,t+46+n),!(A(e,t+8)&2048)),i=t+46+n,s=w(e,t+20),c=r&&s==4294967295?vt(e,i):[s,w(e,t+24),w(e,t+42)],l=c[0],f=c[1],d=c[2];return[A(e,t+10),l,f,o,i+A(e,t+30)+A(e,t+32),d]},vt=function(e,t){for(;A(e,t)!=1;t+=4+A(e,t+2));return[oe(e,t+12),oe(e,t+4),oe(e,t+20)]};function mt(e,t){for(var r={},n=e.length-22;w(e,n)!=101010256;--n)(!n||e.length-n>65558)&&y(13);var o=A(e,n+8);if(!o)return{};var i=w(e,n+16),s=i==4294967295||o==65535;if(s){var c=w(e,n-12);s=w(e,c)==101075792,s&&(o=w(e,c+32),i=w(e,c+48))}for(var l=0;l<o;++l){var f=dt(e,i,s),d=f[0],a=f[1],u=f[2],C=f[3],B=f[4],b=f[5],L=ut(e,b);i=B,d?d==8?r[C]=ct(e.subarray(L,L+a),{out:new p(u)}):y(14,"unknown compression type "+d):r[C]=ye(e,L,L+a)}return r}const N=document.getElementById("overlayToggle"),X=document.getElementById("tmdbKey"),ae=document.getElementById("saveKey"),ie=document.getElementById("clearCache"),O=document.getElementById("keyStatus"),se=document.getElementById("zipStatus"),Se=document.getElementById("zipMeta"),ce=document.getElementById("uploadZip"),I=document.getElementById("zipInput"),_=document.getElementById("zipError"),M=document.getElementById("zipSuccess"),le=document.getElementById("clearLetterboxd"),fe=document.getElementById("helpZip");let De=!1,F=!1,K=null,he=null;const Pe="https://letterboxd.com/settings/data/",He=e=>{const t=[];let r=[],n="",o=!1;for(let i=0;i<e.length;i+=1){const s=e[i],c=e[i+1];if(s==='"'){o&&c==='"'?(n+='"',i+=1):o=!o;continue}if(s===","&&!o){r.push(n),n="";continue}if((s===`
`||s==="\r")&&!o){s==="\r"&&c===`
`&&(i+=1),r.push(n),r.some(l=>l.trim().length>0)&&t.push(r),r=[],n="";continue}n+=s}return r.push(n),r.some(i=>i.trim().length>0)&&t.push(r),t},Xe=e=>{const t={};return e.forEach((r,n)=>{t[r.toLowerCase().trim()]=n}),t},U=(e,t)=>{var r;return t===void 0?"":((r=e[t])==null?void 0:r.trim())??""},Ue=e=>{const t=Number(e);if(!Number.isNaN(t))return t},ht=(e,t)=>{const r=He(e);if(!r.length)return 0;const n=Xe(r[0]),o=n.name??n.title,i=n.year,s=n.rating;let c=0;return r.slice(1).forEach(l=>{const f=U(l,o);if(!f)return;const d=Ue(U(l,i)),a=parseFloat(U(l,s));if(Number.isNaN(a))return;const u=Oe(f,d);t.ratingsByKey[u]=a,c+=1}),c},pt=(e,t)=>{const r=He(e);if(!r.length)return 0;const n=Xe(r[0]),o=n.name??n.title,i=n.year;let s=0;return r.slice(1).forEach(c=>{const l=U(c,o);if(!l)return;const f=Ue(U(c,i)),d=Oe(l,f);t.watchlistKeys[d]=!0,s+=1}),s},Ne=()=>{_&&(_.hidden=!0,_.textContent=""),M&&(M.hidden=!0,M.textContent="")},ue=e=>{_&&(_.textContent=e,_.hidden=!1)},pe=e=>{M&&(M.textContent=e,M.hidden=!1)},$=()=>{m("HELP_MODAL_CLOSE",{before:F}),F=!1,K&&(K.remove(),K=null),document.body.style.overflow="",he&&he.focus(),m("HELP_MODAL_CLOSE",{after:F})},gt=e=>{e.key==="Escape"&&F&&$()},yt=()=>{if(F)return;F=!0,he=document.activeElement,K&&K.remove();const e=document.createElement("div");e.className="modal";const t=document.createElement("div");t.className="modal-card",t.setAttribute("role","dialog"),t.setAttribute("aria-modal","true"),t.addEventListener("click",a=>a.stopPropagation());const r=document.createElement("div");r.className="modal-header";const n=document.createElement("div");n.className="modal-title",n.textContent="How to get your Letterboxd export ZIP";const o=document.createElement("button");o.className="link-button",o.type="button",o.textContent="Close",o.addEventListener("click",$),r.appendChild(n),r.appendChild(o);const i=document.createElement("ol");i.className="modal-steps",["Open Letterboxd and sign in","Go to Settings","Click Data","Export your data","Download the ZIP and upload it here (do not unzip)"].forEach(a=>{const u=document.createElement("li");u.textContent=a,i.appendChild(u)});const s=document.createElement("div");s.className="modal-link";const c=document.createElement("code");c.textContent=Pe;const l=document.createElement("button");l.className="button secondary",l.type="button",l.textContent="Copy link",l.addEventListener("click",async()=>{await navigator.clipboard.writeText(Pe),pe("Copied export link to clipboard.")}),s.appendChild(c),s.appendChild(l);const f=document.createElement("div");f.className="modal-footer";const d=document.createElement("button");d.className="button",d.type="button",d.textContent="Got it",d.addEventListener("click",$),f.appendChild(d),t.appendChild(r),t.appendChild(i),t.appendChild(s),t.appendChild(f),e.appendChild(t),e.addEventListener("click",$),document.body.appendChild(e),K=e,document.body.style.overflow="hidden",requestAnimationFrame(()=>{o.focus()}),m("HELP_MODAL_OPEN")},ge=async()=>{const e=await We();N&&(N.checked=e[h.OVERLAY_ENABLED]??!0),X&&(X.value=e[h.TMDB_API_KEY]??""),O&&(O.textContent=e[h.TMDB_API_KEY]?"Key saved.":"Not set.");const t=e[h.LETTERBOXD_STATS];se&&(t?se.textContent=`${t.ratingsCount} ratings • ${t.watchlistCount} watchlist`:se.textContent="No Letterboxd data imported yet."),Se&&(Se.textContent=t?`Last imported: ${t.importedAt}`:"Import your export ZIP to enable watchlist + rating badges and match %.")},Et=()=>{De||(De=!0,N==null||N.addEventListener("change",async()=>{const e=N.checked;await chrome.storage.local.set({[h.OVERLAY_ENABLED]:e}),m("Overlay toggle updated",{enabled:e})}),ae==null||ae.addEventListener("click",async()=>{const e=X==null?void 0:X.value.trim();if(!e){await chrome.storage.local.remove(h.TMDB_API_KEY),O&&(O.textContent="Not set."),m("TMDb key cleared");return}await chrome.storage.local.set({[h.TMDB_API_KEY]:e}),O&&(O.textContent="Key saved."),m("TMDb key saved")}),ie==null||ie.addEventListener("click",async()=>{await chrome.storage.local.remove(h.TMDB_CACHE),m("TMDb cache cleared")}),ce==null||ce.addEventListener("click",()=>{I==null||I.click()}),fe==null||fe.addEventListener("click",yt),window.addEventListener("keydown",gt),I==null||I.addEventListener("change",async()=>{var t;const e=(t=I.files)==null?void 0:t[0];if(e)try{Ne();const r=await e.arrayBuffer(),n=mt(new Uint8Array(r)),o=Object.keys(n).filter(a=>!a.startsWith("__MACOSX")&&!/\/\./.test(a));m("ZIP entries",o);const i=o.find(a=>/ratings\.csv$/i.test(a)),s=o.find(a=>/watchlist\.csv$/i.test(a));m("Detected ratings.csv",i),m("Detected watchlist.csv",s);const c={ratingsByKey:{},watchlistKeys:{},updatedAt:Date.now()};let l=0,f=0;if(i){const a=me(n[i]);l=ht(a,c)}if(s){const a=me(n[s]);f=pt(a,c)}if(m("Parsed counts",{ratingsCount:l,watchlistCount:f}),!i||!s){ue("Couldn’t find ratings.csv/watchlist.csv in this ZIP. Make sure you uploaded the official Letterboxd export ZIP (don’t unzip it).");return}if(i&&l===0||s&&f===0){ue("Found the file but parsed 0 rows. Please re-export from Letterboxd and try again.");return}const d={importedAt:new Date().toLocaleString(),ratingsCount:l,watchlistCount:f};c.updatedAt=Date.now(),await qe(c),await chrome.storage.local.set({[h.LETTERBOXD_STATS]:d,[h.LAST_IMPORT_AT]:d.importedAt}),console.log("LB_INDEX_SAVED",Object.keys(c.ratingsByKey).length,Object.keys(c.watchlistKeys).length),m("Letterboxd ZIP imported",{ratingsCount:l,watchlistCount:f}),chrome.runtime.sendMessage({type:"LB_INDEX_UPDATED"}).catch(a=>{m("LB_INDEX_UPDATED send failed",a)}),pe(`Imported ${l} ratings and ${f} watchlist items.`),await ge()}catch(r){m("Letterboxd ZIP import failed",r),ue("Import failed. Please re-export from Letterboxd and try again.")}finally{I&&(I.value="")}}),le==null||le.addEventListener("click",async()=>{await chrome.storage.local.remove([h.LETTERBOXD_INDEX,h.LETTERBOXD_STATS,h.LAST_IMPORT_AT]),Ne(),pe("Cleared Letterboxd data."),await ge()}))};Et();ge().catch(e=>{m("Popup render failed",e)});
//# sourceMappingURL=index.js.map
