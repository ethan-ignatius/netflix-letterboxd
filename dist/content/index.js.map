{"version":3,"file":"index.js","sources":["../../src/content/netflixSelectors.ts","../../src/content/overlay/index.ts","../../src/content/index.ts"],"sourcesContent":["export interface ActiveTitleCandidate {\n  netflixTitleId?: string;\n  titleText?: string;\n  year?: number;\n  href?: string;\n  source: string;\n}\n\nconst TITLE_ANCHOR_SELECTOR = \"a[href^='/title/']\";\n\nconst CONTAINER_SELECTORS = [\n  \"[role='dialog']\",\n  \"[aria-modal='true']\",\n  \"[aria-expanded='true']\",\n  \"[data-uia*='preview']\",\n  \"[data-uia*='billboard']\",\n  \"[data-uia*='hero']\",\n  \"[data-uia*='details']\"\n];\n\nconst TITLE_TEXT_SELECTORS = [\n  \"h1\",\n  \"h2\",\n  \"h3\",\n  \"[data-uia*='title']\",\n  \"[class*='title']\",\n  \"[class*='fallback']\",\n  \"[class*='preview'] [class*='header']\"\n];\n\nconst isVisible = (el: Element): boolean => {\n  const rect = el.getBoundingClientRect();\n  if (rect.width === 0 || rect.height === 0) return false;\n  const style = window.getComputedStyle(el as HTMLElement);\n  if (style.visibility === \"hidden\" || style.display === \"none\" || style.opacity === \"0\") {\n    return false;\n  }\n  const inViewport =\n    rect.bottom >= 0 &&\n    rect.right >= 0 &&\n    rect.top <= window.innerHeight &&\n    rect.left <= window.innerWidth;\n  return inViewport;\n};\n\nconst normalizeText = (value?: string | null): string | undefined => {\n  if (!value) return undefined;\n  const text = value.replace(/\\s+/g, \" \").trim();\n  return text.length ? text : undefined;\n};\n\nconst parseTitleIdFromHref = (href?: string | null): string | undefined => {\n  if (!href) return undefined;\n  const match = href.match(/\\/title\\/(\\d+)/);\n  return match?.[1];\n};\n\nconst parseYearFromText = (text?: string): number | undefined => {\n  if (!text) return undefined;\n  const match = text.match(/(19\\d{2}|20\\d{2})/);\n  if (!match) return undefined;\n  const year = Number(match[1]);\n  if (Number.isNaN(year)) return undefined;\n  return year;\n};\n\nconst extractFromAnchor = (anchor: HTMLAnchorElement, source: string): ActiveTitleCandidate => {\n  const href = anchor.getAttribute(\"href\") || undefined;\n  const netflixTitleId = parseTitleIdFromHref(href);\n  const titleText = normalizeText(anchor.getAttribute(\"aria-label\") || anchor.textContent);\n  return { netflixTitleId, titleText, href, source };\n};\n\nconst extractTitleTextNear = (container: Element): string | undefined => {\n  for (const selector of TITLE_TEXT_SELECTORS) {\n    const el = container.querySelector(selector);\n    if (el && isVisible(el)) {\n      const text = normalizeText(el.textContent);\n      if (text) return text;\n    }\n  }\n  return undefined;\n};\n\nexport const findOverlayAnchor = (container?: Element | null): Element | null => {\n  if (container) {\n    const anchor = findBestAnchorIn(container);\n    if (anchor && isVisible(anchor)) return anchor;\n    for (const selector of TITLE_TEXT_SELECTORS) {\n      const el = container.querySelector(selector);\n      if (el && isVisible(el)) return el;\n    }\n  }\n\n  const pageAnchor = Array.from(\n    document.querySelectorAll<HTMLAnchorElement>(TITLE_ANCHOR_SELECTOR)\n  ).find(isVisible);\n  if (pageAnchor) return pageAnchor;\n\n  const pageTitle = Array.from(document.querySelectorAll(TITLE_TEXT_SELECTORS.join(\",\"))).find(\n    isVisible\n  );\n  return pageTitle ?? null;\n};\n\nconst findBestAnchorIn = (container: Element): HTMLAnchorElement | undefined => {\n  const anchors = Array.from(container.querySelectorAll<HTMLAnchorElement>(TITLE_ANCHOR_SELECTOR));\n  const visible = anchors.filter(isVisible);\n  if (visible.length > 0) return visible[0];\n  return anchors[0];\n};\n\nconst findExpandedContainers = (): Element[] => {\n  const selectors = CONTAINER_SELECTORS.join(\",\");\n  const nodes = Array.from(document.querySelectorAll(selectors));\n  const visible = nodes.filter(isVisible);\n  return visible.length > 0 ? visible : nodes;\n};\n\nexport const detectActiveTitleContext = (): {\n  candidate: ActiveTitleCandidate | null;\n  container: Element | null;\n} => {\n  const containers = findExpandedContainers();\n\n  for (const container of containers) {\n    const anchor = findBestAnchorIn(container);\n    if (anchor) {\n      const candidate = extractFromAnchor(anchor, \"container-anchor\");\n      if (candidate.netflixTitleId || candidate.titleText) {\n        const titleText = candidate.titleText ?? extractTitleTextNear(container);\n        return {\n          candidate: {\n          ...candidate,\n          titleText,\n          year: parseYearFromText(titleText)\n          },\n          container\n        };\n      }\n    }\n\n    const titleText = extractTitleTextNear(container);\n    if (titleText) {\n      return {\n        candidate: {\n          titleText,\n          year: parseYearFromText(titleText),\n          source: \"container-text\"\n        },\n        container\n      };\n    }\n  }\n\n  const fallbackAnchor = Array.from(\n    document.querySelectorAll<HTMLAnchorElement>(TITLE_ANCHOR_SELECTOR)\n  ).find(isVisible);\n  if (fallbackAnchor) {\n    const candidate = extractFromAnchor(fallbackAnchor, \"page-anchor\");\n    return {\n      candidate: {\n        ...candidate,\n        year: parseYearFromText(candidate.titleText)\n      },\n      container: fallbackAnchor.closest(CONTAINER_SELECTORS.join(\",\")) ?? fallbackAnchor.parentElement\n    };\n  }\n\n  return { candidate: null, container: null };\n};\n\nexport const detectActiveTitle = (): ActiveTitleCandidate | null => {\n  return detectActiveTitleContext().candidate;\n};\n","export interface OverlayData {\n  titleLine: string;\n  communityRating?: number;\n  ratingCount?: number;\n  inWatchlist?: boolean;\n  userRating?: number;\n  matchScore?: number;\n  matchExplanation?: string;\n  debug?: {\n    titleText?: string;\n    year?: number;\n    netflixTitleId?: string;\n    href?: string;\n    tmdbId?: number;\n    tmdbVoteAverage?: number;\n    tmdbVoteCount?: number;\n    inWatchlist?: boolean;\n    userRating?: number;\n    matchScore?: number;\n    matchExplanation?: string;\n  };\n}\n\nconst OVERLAY_ID = \"nxlb-overlay-panel\";\nconst SAFE_OFFSET = { x: 16, y: 12 };\nconst positionOverrides = new WeakMap<Element, string>();\n\nconst ensureContainerPosition = (container: Element) => {\n  const computed = window.getComputedStyle(container);\n  if (computed.position !== \"static\") return;\n\n  if (!positionOverrides.has(container)) {\n    positionOverrides.set(container, container instanceof HTMLElement ? container.style.position : \"\");\n  }\n\n  if (container instanceof HTMLElement) {\n    container.style.position = \"relative\";\n    container.dataset.nxlbPositioned = \"true\";\n  }\n};\n\nconst restoreContainerPosition = (container: Element | null) => {\n  if (!container || !(container instanceof HTMLElement)) return;\n  if (!container.dataset.nxlbPositioned) return;\n\n  const previous = positionOverrides.get(container) ?? \"\";\n  container.style.position = previous;\n  delete container.dataset.nxlbPositioned;\n  positionOverrides.delete(container);\n};\n\nconst buildOverlay = (data: OverlayData): HTMLDivElement => {\n  const host = document.createElement(\"div\");\n  host.id = OVERLAY_ID;\n  host.style.position = \"absolute\";\n  host.style.top = \"12px\";\n  host.style.right = \"12px\";\n  host.style.zIndex = \"2147483647\";\n\n  const shadow = host.attachShadow({ mode: \"open\" });\n  const style = document.createElement(\"style\");\n  style.textContent = `\n    :host {\n      all: initial;\n      font-family: \"Space Grotesk\", sans-serif;\n      pointer-events: none;\n    }\n    .panel {\n      min-width: 220px;\n      max-width: 280px;\n      background: rgba(16, 16, 16, 0.92);\n      color: #f5f0ea;\n      border-radius: 12px;\n      padding: 12px 14px;\n      border: 1px solid rgba(255, 255, 255, 0.08);\n      box-shadow: 0 14px 30px rgba(0, 0, 0, 0.3);\n      display: grid;\n      gap: 8px;\n    }\n    .title {\n      font-size: 14px;\n      font-weight: 600;\n      letter-spacing: 0.01em;\n    }\n    .meta {\n      font-size: 12px;\n      opacity: 0.7;\n    }\n    .badges {\n      display: flex;\n      gap: 6px;\n      flex-wrap: wrap;\n    }\n    .badge {\n      font-size: 11px;\n      letter-spacing: 0.04em;\n      text-transform: uppercase;\n      padding: 4px 8px;\n      border-radius: 999px;\n      background: rgba(255, 255, 255, 0.12);\n    }\n    .debug {\n      margin-top: 4px;\n      padding-top: 8px;\n      border-top: 1px solid rgba(255, 255, 255, 0.08);\n      font-size: 11px;\n      opacity: 0.7;\n      display: none;\n      white-space: pre-wrap;\n    }\n  `;\n\n  const panel = document.createElement(\"div\");\n  panel.className = \"panel\";\n\n  const title = document.createElement(\"div\");\n  title.className = \"title\";\n  title.textContent = data.titleLine;\n\n  const communityRating = document.createElement(\"div\");\n  communityRating.className = \"meta\";\n  communityRating.dataset.field = \"communityRating\";\n  communityRating.textContent = \"Community rating: —\";\n\n  const ratingCount = document.createElement(\"div\");\n  ratingCount.className = \"meta\";\n  ratingCount.dataset.field = \"ratingCount\";\n  ratingCount.textContent = \"Rating count: —\";\n\n  const match = document.createElement(\"div\");\n  match.className = \"meta\";\n  match.dataset.field = \"match\";\n  match.textContent = \"Your match: —\";\n\n  const badges = document.createElement(\"div\");\n  badges.className = \"badges\";\n\n  const watchlistBadge = document.createElement(\"div\");\n  watchlistBadge.className = \"badge\";\n  watchlistBadge.dataset.field = \"watchlistBadge\";\n  watchlistBadge.textContent = \"On Watchlist\";\n\n  const ratingBadge = document.createElement(\"div\");\n  ratingBadge.className = \"badge\";\n  ratingBadge.dataset.field = \"ratingBadge\";\n  ratingBadge.textContent = \"You rated ★★★★\";\n\n  badges.appendChild(watchlistBadge);\n  badges.appendChild(ratingBadge);\n\n  panel.appendChild(title);\n  panel.appendChild(communityRating);\n  panel.appendChild(ratingCount);\n  panel.appendChild(match);\n  panel.appendChild(badges);\n\n  const debug = document.createElement(\"div\");\n  debug.className = \"debug\";\n  debug.dataset.field = \"debug\";\n  panel.appendChild(debug);\n\n  shadow.appendChild(style);\n  shadow.appendChild(panel);\n\n  return host;\n};\n\nlet currentContainer: Element | null = null;\nlet currentHost: HTMLDivElement | null = null;\nlet currentAnchor: Element | null = null;\n\nconst applySafePosition = (host: HTMLDivElement, anchor: Element | null) => {\n  if (!anchor) return;\n  const rect = anchor.getBoundingClientRect();\n  host.style.position = \"fixed\";\n  host.style.top = `${Math.max(8, rect.top + SAFE_OFFSET.y)}px`;\n  host.style.left = `${Math.max(8, rect.right + SAFE_OFFSET.x)}px`;\n  host.style.right = \"auto\";\n};\n\nconst applyOverlayData = (data: OverlayData) => {\n  const titleEl = currentHost?.shadowRoot?.querySelector(\".title\");\n  if (titleEl) titleEl.textContent = data.titleLine;\n\n  const communityEl = currentHost?.shadowRoot?.querySelector(\n    \"[data-field='communityRating']\"\n  ) as HTMLDivElement | null;\n  if (communityEl) {\n    communityEl.textContent =\n      data.communityRating !== undefined ? `Community rating: ${data.communityRating}` : \"Community rating: —\";\n  }\n\n  const ratingEl = currentHost?.shadowRoot?.querySelector(\n    \"[data-field='ratingCount']\"\n  ) as HTMLDivElement | null;\n  if (ratingEl) {\n    ratingEl.textContent =\n      data.ratingCount !== undefined ? `Rating count: ${data.ratingCount}` : \"Rating count: —\";\n  }\n\n  const watchlistEl = currentHost?.shadowRoot?.querySelector(\n    \"[data-field='watchlistBadge']\"\n  ) as HTMLDivElement | null;\n  if (watchlistEl) {\n    watchlistEl.style.display = data.inWatchlist ? \"inline-flex\" : \"none\";\n  }\n\n  const ratingBadgeEl = currentHost?.shadowRoot?.querySelector(\n    \"[data-field='ratingBadge']\"\n  ) as HTMLDivElement | null;\n  if (ratingBadgeEl) {\n    if (data.userRating !== undefined) {\n      ratingBadgeEl.style.display = \"inline-flex\";\n      ratingBadgeEl.textContent = `You rated ${renderStars(data.userRating)}`;\n    } else {\n      ratingBadgeEl.style.display = \"none\";\n    }\n  }\n\n  const matchEl = currentHost?.shadowRoot?.querySelector(\n    \"[data-field='match']\"\n  ) as HTMLDivElement | null;\n  if (matchEl) {\n    if (data.matchScore !== undefined) {\n      const explanation = data.matchExplanation ? ` · ${data.matchExplanation}` : \"\";\n      matchEl.textContent = `Your match: ${data.matchScore}${explanation}`;\n    } else {\n      matchEl.textContent = \"Your match: —\";\n    }\n  }\n\n  const debugEl = currentHost?.shadowRoot?.querySelector(\n    \"[data-field='debug']\"\n  ) as HTMLDivElement | null;\n  if (debugEl) {\n    if (data.debug) {\n      debugEl.style.display = \"block\";\n      debugEl.textContent = JSON.stringify(data.debug, null, 2);\n    } else {\n      debugEl.style.display = \"none\";\n      debugEl.textContent = \"\";\n    }\n  }\n};\n\nexport const updateOverlay = (\n  container: Element | null,\n  data: OverlayData | null,\n  anchor: Element | null = null,\n  safeMode = false\n) => {\n  if (!data || (!container && !anchor)) {\n    if (currentHost) currentHost.remove();\n    restoreContainerPosition(currentContainer);\n    currentContainer = null;\n    currentHost = null;\n    currentAnchor = null;\n    return;\n  }\n\n  if (currentContainer !== container || currentAnchor !== anchor) {\n    if (currentHost) currentHost.remove();\n    restoreContainerPosition(currentContainer);\n    currentContainer = container;\n    currentAnchor = anchor;\n    currentHost = buildOverlay(data);\n\n    if (container) {\n      ensureContainerPosition(container);\n      container.appendChild(currentHost);\n      if (safeMode) applySafePosition(currentHost, anchor ?? container);\n    } else if (anchor) {\n      document.documentElement.appendChild(currentHost);\n      applySafePosition(currentHost, anchor);\n    }\n\n    applyOverlayData(data);\n    return;\n  }\n\n  applyOverlayData(data);\n};\n\nconst renderStars = (rating: number): string => {\n  const clamped = Math.max(0, Math.min(5, rating));\n  const full = Math.floor(clamped);\n  const half = clamped - full >= 0.5;\n  const stars = \"★\".repeat(full);\n  if (half) return `${stars}½`;\n  return stars || \"—\";\n};\n","import { log } from \"../shared/log\";\nimport { getStorage, setStorage } from \"../shared/storage\";\nimport { detectActiveTitleContext, findOverlayAnchor } from \"./netflixSelectors\";\nimport { updateOverlay } from \"./overlay\";\nimport type { ResolveTitleMessage, TitleResolvedMessage } from \"../shared/types\";\nimport { DEBUG } from \"../shared/log\";\n\nconst BADGE_ID = \"nxlb-debug-badge\";\nconst TOGGLE_COMBO = {\n  ctrlKey: true,\n  shiftKey: true,\n  key: \"l\"\n};\nconst OBSERVER_DEBOUNCE_MS = 250;\n\nconst ensureBadge = (enabled: boolean) => {\n  const existing = document.getElementById(BADGE_ID);\n  if (!enabled) {\n    existing?.remove();\n    return;\n  }\n\n  if (existing) return;\n\n  const host = document.createElement(\"div\");\n  host.id = BADGE_ID;\n  host.style.position = \"fixed\";\n  host.style.bottom = \"16px\";\n  host.style.right = \"16px\";\n  host.style.zIndex = \"2147483647\";\n\n  const shadow = host.attachShadow({ mode: \"open\" });\n  const style = document.createElement(\"style\");\n  style.textContent = `\n    :host {\n      all: initial;\n      font-family: \"Space Grotesk\", sans-serif;\n    }\n    .badge {\n      background: #111;\n      color: #f5f5f5;\n      border-radius: 999px;\n      padding: 6px 10px;\n      font-size: 11px;\n      letter-spacing: 0.08em;\n      text-transform: uppercase;\n      border: 1px solid rgba(255, 255, 255, 0.14);\n      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.35);\n    }\n  `;\n\n  const badge = document.createElement(\"div\");\n  badge.className = \"badge\";\n  badge.textContent = \"N×L active\";\n\n  shadow.appendChild(style);\n  shadow.appendChild(badge);\n  document.documentElement.appendChild(host);\n};\n\nlet overlayEnabled = true;\n\nconst applyOverlayState = async (enabled: boolean) => {\n  overlayEnabled = enabled;\n  if (!enabled) {\n    updateOverlay(null, null);\n  }\n  ensureBadge(enabled);\n};\n\nlet lastActiveKey = \"\";\nlet lastContainer: Element | null = null;\nlet debounceTimer: number | undefined;\nlet lastRequestId = \"\";\n\nconst serializeCandidate = (\n  candidate: ReturnType<typeof detectActiveTitleContext>[\"candidate\"]\n): string => {\n  if (!candidate) return \"\";\n  return [\n    candidate.netflixTitleId ?? \"\",\n    candidate.titleText ?? \"\",\n    candidate.year ?? \"\",\n    candidate.href ?? \"\"\n  ].join(\"|\");\n};\n\nconst emitActiveTitleChange = () => {\n  if (!overlayEnabled) return;\n\n  const { candidate, container } = detectActiveTitleContext();\n  const anchor = findOverlayAnchor(container);\n  const key = serializeCandidate(candidate);\n  if (!candidate) {\n    try {\n      updateOverlay(null, null);\n    } catch (error) {\n      log(\"Overlay cleanup failed\", { error });\n    }\n    lastActiveKey = \"\";\n    lastContainer = null;\n    return;\n  }\n\n  if (key === lastActiveKey && container === lastContainer) return;\n  lastActiveKey = key;\n  lastContainer = container;\n  log(\"Active title changed\", {\n    ...candidate,\n    at: new Date().toISOString()\n  });\n\n  const requestId = `req_${Date.now()}_${Math.random().toString(36).slice(2, 8)}`;\n  lastRequestId = requestId;\n  const message: ResolveTitleMessage = {\n    type: \"RESOLVE_TITLE\",\n    requestId,\n    payload: {\n      netflixTitleId: candidate.netflixTitleId,\n      titleText: candidate.titleText,\n      year: candidate.year,\n      href: candidate.href\n    }\n  };\n\n  chrome.runtime\n    .sendMessage(message)\n    .then((response: TitleResolvedMessage) => {\n      if (response?.type !== \"TITLE_RESOLVED\") return;\n      if (response.requestId !== lastRequestId) return;\n      log(\"Title resolved\", { requestId, response });\n\n      try {\n        updateOverlay(\n          container,\n          {\n          titleLine,\n          communityRating: response.payload.tmdbVoteAverage,\n          ratingCount: response.payload.tmdbVoteCount,\n          inWatchlist: response.payload.inWatchlist,\n          userRating: response.payload.userRating,\n          matchScore: response.payload.matchScore,\n          matchExplanation: response.payload.matchExplanation,\n          debug: DEBUG\n            ? {\n                ...candidate,\n                ...response.payload\n              }\n            : undefined\n        },\n          anchor,\n          !container\n        );\n      } catch (error) {\n        log(\"Overlay update failed\", { error });\n      }\n    })\n    .catch((err) => {\n      log(\"Title resolve failed\", { requestId, err });\n    });\n\n  const titleLine = candidate.titleText\n    ? candidate.year\n      ? `${candidate.titleText} (${candidate.year})`\n      : candidate.titleText\n    : \"Unknown title\";\n\n  try {\n    updateOverlay(\n      container,\n      {\n        titleLine,\n        debug: DEBUG ? { ...candidate } : undefined\n      },\n      anchor,\n      !container\n    );\n  } catch (error) {\n    log(\"Overlay update failed\", { error });\n  }\n};\n\nconst scheduleActiveTitleCheck = () => {\n  if (debounceTimer) window.clearTimeout(debounceTimer);\n  debounceTimer = window.setTimeout(() => {\n    emitActiveTitleChange();\n  }, OBSERVER_DEBOUNCE_MS);\n};\n\nconst observeTitleChanges = () => {\n  const observer = new MutationObserver(() => {\n    try {\n      scheduleActiveTitleCheck();\n    } catch (error) {\n      log(\"Mutation observer failed\", { error });\n    }\n  });\n  observer.observe(document.body, {\n    childList: true,\n    subtree: true,\n    attributes: true,\n    attributeFilter: [\"class\", \"style\", \"aria-expanded\", \"aria-hidden\"]\n  });\n\n  document.addEventListener(\"pointerover\", () => {\n    try {\n      scheduleActiveTitleCheck();\n    } catch (error) {\n      log(\"Pointer observer failed\", { error });\n    }\n  }, true);\n  document.addEventListener(\"focusin\", () => {\n    try {\n      scheduleActiveTitleCheck();\n    } catch (error) {\n      log(\"Focus observer failed\", { error });\n    }\n  }, true);\n  scheduleActiveTitleCheck();\n};\n\nconst toggleOverlay = async () => {\n  const state = await getStorage();\n  const next = !(state.overlayEnabled ?? true);\n  await setStorage({ overlayEnabled: next });\n  await applyOverlayState(next);\n  if (next) scheduleActiveTitleCheck();\n  log(\"Overlay toggled\", { enabled: next });\n};\n\nconst handleKeydown = (event: KeyboardEvent) => {\n  if (\n    event.ctrlKey === TOGGLE_COMBO.ctrlKey &&\n    event.shiftKey === TOGGLE_COMBO.shiftKey &&\n    event.key.toLowerCase() === TOGGLE_COMBO.key\n  ) {\n    event.preventDefault();\n    toggleOverlay().catch((err) => log(\"Toggle failed\", err));\n  }\n};\n\nconst init = async () => {\n  const state = await getStorage();\n  const enabled = state.overlayEnabled ?? true;\n  await applyOverlayState(enabled);\n  observeTitleChanges();\n  window.addEventListener(\"keydown\", handleKeydown);\n};\n\nif (document.readyState === \"loading\") {\n  document.addEventListener(\"DOMContentLoaded\", () => {\n    init().catch((err) => log(\"Init failed\", err));\n  }, { once: true });\n} else {\n  init().catch((err) => log(\"Init failed\", err));\n}\n"],"names":["TITLE_ANCHOR_SELECTOR","CONTAINER_SELECTORS","TITLE_TEXT_SELECTORS","isVisible","el","rect","style","normalizeText","value","text","parseTitleIdFromHref","href","match","parseYearFromText","year","extractFromAnchor","anchor","source","netflixTitleId","titleText","extractTitleTextNear","container","selector","findOverlayAnchor","findBestAnchorIn","pageAnchor","anchors","visible","findExpandedContainers","selectors","nodes","detectActiveTitleContext","containers","candidate","fallbackAnchor","OVERLAY_ID","SAFE_OFFSET","positionOverrides","ensureContainerPosition","restoreContainerPosition","previous","buildOverlay","data","host","shadow","panel","title","communityRating","ratingCount","badges","watchlistBadge","ratingBadge","debug","currentContainer","currentHost","currentAnchor","applySafePosition","applyOverlayData","titleEl","_a","communityEl","_b","ratingEl","_c","watchlistEl","_d","ratingBadgeEl","_e","renderStars","matchEl","_f","explanation","debugEl","_g","updateOverlay","safeMode","rating","clamped","full","half","stars","BADGE_ID","TOGGLE_COMBO","OBSERVER_DEBOUNCE_MS","ensureBadge","enabled","existing","badge","overlayEnabled","applyOverlayState","lastActiveKey","lastContainer","debounceTimer","lastRequestId","serializeCandidate","emitActiveTitleChange","key","log","requestId","message","response","titleLine","DEBUG","err","scheduleActiveTitleCheck","observeTitleChanges","toggleOverlay","next","getStorage","setStorage","handleKeydown","event","init"],"mappings":"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"}