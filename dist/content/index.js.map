{"version":3,"file":"index.js","sources":["../../src/shared/log.ts","../../src/shared/storage.ts","../../src/content/netflixSelectors.ts","../../src/content/overlay/index.ts","../../src/content/index.ts"],"sourcesContent":["export const DEBUG = import.meta.env.DEV;\n\nexport const log = (...args: unknown[]) => {\n  if (!DEBUG) return;\n  console.log(\"[Netflix+Letterboxd]\", ...args);\n};\n\nexport const warn = (...args: unknown[]) => {\n  if (!DEBUG) return;\n  console.warn(\"[Netflix+Letterboxd]\", ...args);\n};\n\nexport const error = (...args: unknown[]) => {\n  if (!DEBUG) return;\n  console.error(\"[Netflix+Letterboxd]\", ...args);\n};\n","import { log, warn } from \"./log\";\nimport type { LetterboxdExport, LetterboxdIndex, LetterboxdStats } from \"./types\";\n\nexport interface StorageState {\n  letterboxdExport?: LetterboxdExport;\n  lastImportAt?: string;\n  overlayEnabled?: boolean;\n  tmdbApiKey?: string;\n  tmdbCache?: Record<string, unknown>;\n  letterboxdIndex?: LetterboxdIndex;\n  letterboxdStats?: LetterboxdStats;\n}\n\nexport const getStorage = async (): Promise<StorageState> => {\n  log(\"Loading storage state\");\n  return chrome.storage.local.get([\n    \"letterboxdExport\",\n    \"lastImportAt\",\n    \"overlayEnabled\",\n    \"tmdbApiKey\",\n    \"tmdbCache\",\n    \"letterboxdIndex\",\n    \"letterboxdStats\"\n  ]) as Promise<StorageState>;\n};\n\nexport const setStorage = async (state: StorageState): Promise<void> => {\n  log(\"Saving storage state\", state);\n  await chrome.storage.local.set(state);\n};\n\nexport const clearStorage = async (): Promise<void> => {\n  warn(\"Clearing storage state\");\n  await chrome.storage.local.clear();\n};\n","export interface ActiveTitleCandidate {\n  netflixTitleId?: string;\n  titleText?: string;\n  year?: number;\n  href?: string;\n  source: string;\n}\n\nconst TITLE_ANCHOR_SELECTOR = \"a[href^='/title/']\";\n\nconst CONTAINER_SELECTORS = [\n  \"[role='dialog']\",\n  \"[aria-modal='true']\",\n  \"[aria-expanded='true']\",\n  \"[data-uia*='preview']\",\n  \"[data-uia*='billboard']\",\n  \"[data-uia*='hero']\",\n  \"[data-uia*='details']\"\n];\n\nconst TITLE_TEXT_SELECTORS = [\n  \"h1\",\n  \"h2\",\n  \"h3\",\n  \"[data-uia*='title']\",\n  \"[class*='title']\",\n  \"[class*='fallback']\",\n  \"[class*='preview'] [class*='header']\"\n];\n\nconst PREVIEW_SELECTORS = [\n  \"video\",\n  \"img\",\n  \"[data-uia*='preview'] video\",\n  \"[data-uia*='preview'] img\",\n  \"[class*='preview'] video\",\n  \"[class*='preview'] img\",\n  \"[data-uia*='player'] video\",\n  \"[data-uia*='hero'] img\"\n];\n\nconst METADATA_SELECTORS = [\n  \"[data-uia*='maturity-rating']\",\n  \"[data-uia*='season']\",\n  \"[data-uia*='resolution']\",\n  \"[data-uia*='hd']\",\n  \"[class*='maturity']\",\n  \"[class*='season']\",\n  \"[class*='quality']\"\n];\n\nconst GENRE_SELECTORS = [\n  \"[data-uia*='genre']\",\n  \"a[href*='/genre/']\",\n  \"[class*='genre']\"\n];\n\nconst isVisible = (el: Element): boolean => {\n  const rect = el.getBoundingClientRect();\n  if (rect.width === 0 || rect.height === 0) return false;\n  const style = window.getComputedStyle(el as HTMLElement);\n  if (style.visibility === \"hidden\" || style.display === \"none\" || style.opacity === \"0\") {\n    return false;\n  }\n  const inViewport =\n    rect.bottom >= 0 &&\n    rect.right >= 0 &&\n    rect.top <= window.innerHeight &&\n    rect.left <= window.innerWidth;\n  return inViewport;\n};\n\nconst normalizeText = (value?: string | null): string | undefined => {\n  if (!value) return undefined;\n  const text = value.replace(/\\s+/g, \" \").trim();\n  return text.length ? text : undefined;\n};\n\nconst collectVisibleText = (container: Element, selectors: string[]): string[] => {\n  const values: string[] = [];\n  selectors.forEach((selector) => {\n    container.querySelectorAll(selector).forEach((el) => {\n      if (!isVisible(el)) return;\n      const text = normalizeText(el.textContent);\n      if (!text) return;\n      values.push(text);\n    });\n  });\n  return values;\n};\n\nconst isMetadataCandidate = (value: string) => {\n  const lower = value.toLowerCase();\n  if (lower.includes(\"episode\")) return false;\n  if (lower.includes(\"min\")) return false;\n  if (lower.includes(\"season\") || lower.includes(\"hd\") || lower.includes(\"tv-\")) return true;\n  return true;\n};\n\nconst parseTitleIdFromHref = (href?: string | null): string | undefined => {\n  if (!href) return undefined;\n  const match = href.match(/\\/title\\/(\\d+)/);\n  return match?.[1];\n};\n\nconst parseYearFromText = (text?: string): number | undefined => {\n  if (!text) return undefined;\n  const match = text.match(/(19\\d{2}|20\\d{2})/);\n  if (!match) return undefined;\n  const year = Number(match[1]);\n  if (Number.isNaN(year)) return undefined;\n  return year;\n};\n\nconst extractFromAnchor = (anchor: HTMLAnchorElement, source: string): ActiveTitleCandidate => {\n  const href = anchor.getAttribute(\"href\") || undefined;\n  const netflixTitleId = parseTitleIdFromHref(href);\n  const titleText = normalizeText(anchor.getAttribute(\"aria-label\") || anchor.textContent);\n  return { netflixTitleId, titleText, href, source };\n};\n\nconst extractTitleTextNear = (container: Element): string | undefined => {\n  for (const selector of TITLE_TEXT_SELECTORS) {\n    const el = container.querySelector(selector);\n    if (el && isVisible(el)) {\n      const text = normalizeText(el.textContent);\n      if (text) return text;\n    }\n  }\n  return undefined;\n};\n\nexport const findOverlayAnchor = (container?: Element | null): Element | null => {\n  if (container) {\n    const anchor = findBestAnchorIn(container);\n    if (anchor && isVisible(anchor)) return anchor;\n    for (const selector of TITLE_TEXT_SELECTORS) {\n      const el = container.querySelector(selector);\n      if (el && isVisible(el)) return el;\n    }\n  }\n\n  const pageAnchor = Array.from(\n    document.querySelectorAll<HTMLAnchorElement>(TITLE_ANCHOR_SELECTOR)\n  ).find(isVisible);\n  if (pageAnchor) return pageAnchor;\n\n  const pageTitle = Array.from(document.querySelectorAll(TITLE_TEXT_SELECTORS.join(\",\"))).find(\n    isVisible\n  );\n  return pageTitle ?? null;\n};\n\nexport const findPreviewElement = (container?: Element | null): Element | null => {\n  if (!container) return null;\n  for (const selector of PREVIEW_SELECTORS) {\n    const el = container.querySelector(selector);\n    if (el && isVisible(el)) return el;\n  }\n  return null;\n};\n\nexport const extractMetadataLine = (container?: Element | null): string | undefined => {\n  if (!container) return undefined;\n  const values = collectVisibleText(container, METADATA_SELECTORS)\n    .map((value) => value.replace(/\\s+/g, \" \").trim())\n    .filter((value) => value.length > 0)\n    .filter(isMetadataCandidate);\n  const unique = Array.from(new Set(values));\n  if (!unique.length) return undefined;\n  return unique.slice(0, 3).join(\" • \");\n};\n\nexport const extractGenresLine = (container?: Element | null): string | undefined => {\n  if (!container) return undefined;\n  const values = collectVisibleText(container, GENRE_SELECTORS)\n    .map((value) => value.replace(/\\s+/g, \" \").trim())\n    .filter((value) => value.length > 0)\n    .filter((value) => !/episode|min/i.test(value));\n  const unique = Array.from(new Set(values));\n  if (!unique.length) return undefined;\n  return unique.slice(0, 3).join(\" • \");\n};\n\nconst findBestAnchorIn = (container: Element): HTMLAnchorElement | undefined => {\n  const anchors = Array.from(container.querySelectorAll<HTMLAnchorElement>(TITLE_ANCHOR_SELECTOR));\n  const visible = anchors.filter(isVisible);\n  if (visible.length > 0) return visible[0];\n  return anchors[0];\n};\n\nconst findExpandedContainers = (): Element[] => {\n  const selectors = CONTAINER_SELECTORS.join(\",\");\n  const nodes = Array.from(document.querySelectorAll(selectors));\n  const visible = nodes.filter(isVisible);\n  return visible.length > 0 ? visible : nodes;\n};\n\nexport const detectActiveTitleContext = (): {\n  candidate: ActiveTitleCandidate | null;\n  container: Element | null;\n} => {\n  const containers = findExpandedContainers();\n\n  for (const container of containers) {\n    const anchor = findBestAnchorIn(container);\n    if (anchor) {\n      const candidate = extractFromAnchor(anchor, \"container-anchor\");\n      if (candidate.netflixTitleId || candidate.titleText) {\n        const titleText = candidate.titleText ?? extractTitleTextNear(container);\n        return {\n          candidate: {\n          ...candidate,\n          titleText,\n          year: parseYearFromText(titleText)\n          },\n          container\n        };\n      }\n    }\n\n    const titleText = extractTitleTextNear(container);\n    if (titleText) {\n      return {\n        candidate: {\n          titleText,\n          year: parseYearFromText(titleText),\n          source: \"container-text\"\n        },\n        container\n      };\n    }\n  }\n\n  const fallbackAnchor = Array.from(\n    document.querySelectorAll<HTMLAnchorElement>(TITLE_ANCHOR_SELECTOR)\n  ).find(isVisible);\n  if (fallbackAnchor) {\n    const candidate = extractFromAnchor(fallbackAnchor, \"page-anchor\");\n    return {\n      candidate: {\n        ...candidate,\n        year: parseYearFromText(candidate.titleText)\n      },\n      container: fallbackAnchor.closest(CONTAINER_SELECTORS.join(\",\")) ?? fallbackAnchor.parentElement\n    };\n  }\n\n  return { candidate: null, container: null };\n};\n\nexport const detectActiveTitle = (): ActiveTitleCandidate | null => {\n  return detectActiveTitleContext().candidate;\n};\n","export interface OverlayData {\n  titleLine: string;\n  metadataLine?: string;\n  genresLine?: string;\n  communityRating?: number;\n  ratingCount?: number;\n  inWatchlist?: boolean;\n  userRating?: number;\n  matchScore?: number;\n  matchExplanation?: string;\n  debug?: {\n    titleText?: string;\n    year?: number;\n    netflixTitleId?: string;\n    href?: string;\n    tmdbId?: number;\n    tmdbVoteAverage?: number;\n    tmdbVoteCount?: number;\n    inWatchlist?: boolean;\n    userRating?: number;\n    matchScore?: number;\n    matchExplanation?: string;\n  };\n}\n\nconst OVERLAY_ID = \"nxlb-overlay-panel\";\nconst SAFE_OFFSET = { x: 16, y: 12 };\nconst positionOverrides = new WeakMap<Element, string>();\n\nconst ensureContainerPosition = (container: Element) => {\n  const computed = window.getComputedStyle(container);\n  if (computed.position !== \"static\") return;\n\n  if (!positionOverrides.has(container)) {\n    positionOverrides.set(container, container instanceof HTMLElement ? container.style.position : \"\");\n  }\n\n  if (container instanceof HTMLElement) {\n    container.style.position = \"relative\";\n    container.dataset.nxlbPositioned = \"true\";\n  }\n};\n\nconst restoreContainerPosition = (container: Element | null) => {\n  if (!container || !(container instanceof HTMLElement)) return;\n  if (!container.dataset.nxlbPositioned) return;\n\n  const previous = positionOverrides.get(container) ?? \"\";\n  container.style.position = previous;\n  delete container.dataset.nxlbPositioned;\n  positionOverrides.delete(container);\n};\n\nconst buildOverlay = (data: OverlayData): HTMLDivElement => {\n  const host = document.createElement(\"div\");\n  host.id = OVERLAY_ID;\n  host.style.position = \"absolute\";\n  host.style.inset = \"0\";\n  host.style.zIndex = \"2147483647\";\n\n  const shadow = host.attachShadow({ mode: \"open\" });\n  const style = document.createElement(\"style\");\n  style.textContent = `\n    :host {\n      all: initial;\n      font-family: \"Netflix Sans\", \"Helvetica Neue\", Helvetica, Arial, sans-serif;\n      pointer-events: none;\n      --preview-top: 45%;\n      --preview-bottom: 70%;\n      --preview-height: 180px;\n      --controls-height: 64px;\n    }\n    .nxl-card {\n      position: absolute;\n      inset: 0;\n      display: grid;\n      grid-template-rows: auto auto auto auto 1fr auto;\n      gap: 12px;\n      padding: 20px;\n      background: linear-gradient(\n        to bottom,\n        rgba(0, 0, 0, 0.88) 0%,\n        rgba(0, 0, 0, 0.88) var(--preview-top),\n        rgba(0, 0, 0, 0) var(--preview-top),\n        rgba(0, 0, 0, 0) var(--preview-bottom),\n        rgba(0, 0, 0, 0.88) var(--preview-bottom),\n        rgba(0, 0, 0, 0.88) 100%\n      );\n      backdrop-filter: blur(8px);\n      border-radius: 12px;\n      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.4);\n      border: 1px solid rgba(255, 255, 255, 0.08);\n      animation: nxlFadeIn 150ms ease-out;\n    }\n    .nxl-top {\n      display: flex;\n      justify-content: space-between;\n      align-items: flex-start;\n      gap: 16px;\n    }\n    .nxl-title {\n      font-size: 30px;\n      font-weight: 700;\n      letter-spacing: 0.01em;\n    }\n    .nxl-meta {\n      font-size: 14px;\n      color: rgba(255, 255, 255, 0.75);\n      margin-top: 6px;\n    }\n    .nxl-genres {\n      font-size: 14px;\n      color: rgba(255, 255, 255, 0.7);\n      margin-top: 4px;\n    }\n    .nxl-branding {\n      display: flex;\n      align-items: center;\n      gap: 8px;\n      font-size: 12px;\n      color: rgba(255, 255, 255, 0.8);\n      white-space: nowrap;\n    }\n    .nxl-dots {\n      display: inline-flex;\n      gap: 4px;\n      align-items: center;\n    }\n    .nxl-dot {\n      width: 8px;\n      height: 8px;\n      border-radius: 50%;\n      display: inline-block;\n    }\n    .nxl-dot.green { background: #00c46a; }\n    .nxl-dot.orange { background: #f2b34c; }\n    .nxl-dot.blue { background: #4aa8ff; }\n    .nxl-divider {\n      height: 1px;\n      width: 100%;\n      background: rgba(255, 255, 255, 0.1);\n    }\n    .nxl-metadata {\n      display: grid;\n      gap: 8px;\n      font-size: 16px;\n      color: rgba(255, 255, 255, 0.9);\n    }\n    .nxl-rating {\n      display: flex;\n      align-items: center;\n      gap: 8px;\n    }\n    .nxl-star {\n      color: #e3b341;\n      font-size: 16px;\n    }\n    .nxl-match {\n      display: flex;\n      align-items: baseline;\n      gap: 8px;\n    }\n    .nxl-match-value {\n      color: #46d369;\n      font-weight: 700;\n      font-size: 20px;\n      animation: nxlPop 200ms ease-out;\n    }\n    .nxl-because {\n      color: rgba(255, 255, 255, 0.7);\n      font-size: 14px;\n    }\n    .nxl-preview {\n      min-height: var(--preview-height);\n    }\n    .nxl-controls {\n      min-height: var(--controls-height);\n    }\n    .debug {\n      margin-top: 4px;\n      padding-top: 8px;\n      border-top: 1px solid rgba(255, 255, 255, 0.08);\n      font-size: 11px;\n      opacity: 0.7;\n      display: none;\n      white-space: pre-wrap;\n    }\n    @keyframes nxlFadeIn {\n      from { opacity: 0; transform: translateY(6px); }\n      to { opacity: 1; transform: translateY(0); }\n    }\n    @keyframes nxlPop {\n      0% { transform: scale(0.96); }\n      100% { transform: scale(1); }\n    }\n  `;\n\n  const panel = document.createElement(\"div\");\n  panel.className = \"nxl-card\";\n\n  const top = document.createElement(\"div\");\n  top.className = \"nxl-top\";\n\n  const titleSection = document.createElement(\"div\");\n  titleSection.className = \"nxl-title-section\";\n\n  const title = document.createElement(\"div\");\n  title.className = \"nxl-title\";\n  title.textContent = data.titleLine;\n\n  const metaLine = document.createElement(\"div\");\n  metaLine.className = \"nxl-meta\";\n  metaLine.dataset.field = \"metadata\";\n  metaLine.textContent = data.metadataLine ?? \"TV-14 • 2 Seasons • HD\";\n\n  const genresLine = document.createElement(\"div\");\n  genresLine.className = \"nxl-genres\";\n  genresLine.dataset.field = \"genres\";\n  genresLine.textContent = data.genresLine ?? \"Genres\";\n\n  titleSection.appendChild(title);\n  titleSection.appendChild(metaLine);\n  titleSection.appendChild(genresLine);\n\n  const branding = document.createElement(\"div\");\n  branding.className = \"nxl-branding\";\n  branding.innerHTML = `\n    Powered by\n    <span class=\"nxl-dots\">\n      <span class=\"nxl-dot green\"></span>\n      <span class=\"nxl-dot orange\"></span>\n      <span class=\"nxl-dot blue\"></span>\n    </span>\n    Letterboxd\n  `;\n\n  top.appendChild(titleSection);\n  top.appendChild(branding);\n\n  const divider = document.createElement(\"div\");\n  divider.className = \"nxl-divider\";\n\n  const metadata = document.createElement(\"div\");\n  metadata.className = \"nxl-metadata\";\n\n  const communityRating = document.createElement(\"div\");\n  communityRating.className = \"nxl-rating\";\n  communityRating.dataset.field = \"communityRating\";\n  communityRating.textContent = \"Community rating: —\";\n\n  const match = document.createElement(\"div\");\n  match.className = \"nxl-match\";\n  match.dataset.field = \"match\";\n  match.textContent = \"Your match: —\";\n\n  const because = document.createElement(\"div\");\n  because.className = \"nxl-because\";\n  because.dataset.field = \"because\";\n  because.textContent = \"Because you like —\";\n\n  metadata.appendChild(communityRating);\n  metadata.appendChild(match);\n  metadata.appendChild(because);\n\n  const preview = document.createElement(\"div\");\n  preview.className = \"nxl-preview\";\n  preview.dataset.field = \"preview\";\n\n  const controls = document.createElement(\"div\");\n  controls.className = \"nxl-controls\";\n  controls.dataset.field = \"controls\";\n\n  panel.appendChild(top);\n  panel.appendChild(divider);\n  panel.appendChild(metadata);\n  panel.appendChild(preview);\n  panel.appendChild(controls);\n\n  const debug = document.createElement(\"div\");\n  debug.className = \"debug\";\n  debug.dataset.field = \"debug\";\n  panel.appendChild(debug);\n\n  shadow.appendChild(style);\n  shadow.appendChild(panel);\n\n  return host;\n};\n\nlet currentContainer: Element | null = null;\nlet currentHost: HTMLDivElement | null = null;\nlet currentAnchor: Element | null = null;\n\nconst applySafePosition = (host: HTMLDivElement, anchor: Element | null) => {\n  if (!anchor) return;\n  const rect = anchor.getBoundingClientRect();\n  host.style.position = \"fixed\";\n  host.style.top = `${Math.max(8, rect.top - SAFE_OFFSET.y)}px`;\n  host.style.left = `${Math.max(8, rect.left)}px`;\n  host.style.right = \"auto\";\n  host.style.width = `${Math.max(280, rect.width)}px`;\n  host.style.height = `${Math.max(220, rect.height)}px`;\n};\n\nconst formatRatingCount = (value?: number) => {\n  if (value === undefined) return \"\";\n  if (value >= 1_000_000) return `${(value / 1_000_000).toFixed(1)}M`;\n  if (value >= 1_000) return `${(value / 1_000).toFixed(1)}K`;\n  return `${value}`;\n};\n\nconst applyOverlayData = (data: OverlayData) => {\n  const titleEl = currentHost?.shadowRoot?.querySelector(\".nxl-title\");\n  if (titleEl) titleEl.textContent = data.titleLine;\n\n  const communityEl = currentHost?.shadowRoot?.querySelector(\n    \"[data-field='communityRating']\"\n  ) as HTMLDivElement | null;\n  if (communityEl) {\n    if (data.communityRating !== undefined) {\n      const count = formatRatingCount(data.ratingCount);\n      communityEl.innerHTML = `\n        Community rating:\n        <span class=\"nxl-star\">★</span>\n        ${data.communityRating.toFixed(1)}${count ? ` <span class=\"nxl-meta\">${count} ratings</span>` : \"\"}\n      `;\n    } else {\n      communityEl.textContent = \"Community rating: —\";\n    }\n  }\n\n  const matchEl = currentHost?.shadowRoot?.querySelector(\n    \"[data-field='match']\"\n  ) as HTMLDivElement | null;\n  if (matchEl) {\n    if (data.matchScore !== undefined) {\n      matchEl.innerHTML = `Your match: <span class=\"nxl-match-value\">${data.matchScore}%</span>`;\n    } else {\n      matchEl.textContent = \"Your match: —\";\n    }\n  }\n\n  const becauseEl = currentHost?.shadowRoot?.querySelector(\n    \"[data-field='because']\"\n  ) as HTMLDivElement | null;\n  if (becauseEl) {\n    becauseEl.textContent = data.matchExplanation ?? \"Because you like —\";\n  }\n\n  const metaEl = currentHost?.shadowRoot?.querySelector(\n    \"[data-field='metadata']\"\n  ) as HTMLDivElement | null;\n  if (metaEl) {\n    metaEl.textContent = data.metadataLine ?? \"TV-14 • 2 Seasons • HD\";\n  }\n\n  const genresEl = currentHost?.shadowRoot?.querySelector(\n    \"[data-field='genres']\"\n  ) as HTMLDivElement | null;\n  if (genresEl) {\n    genresEl.textContent = data.genresLine ?? \"Genres\";\n  }\n\n  const debugEl = currentHost?.shadowRoot?.querySelector(\n    \"[data-field='debug']\"\n  ) as HTMLDivElement | null;\n  if (debugEl) {\n    if (data.debug) {\n      debugEl.style.display = \"block\";\n      debugEl.textContent = JSON.stringify(data.debug, null, 2);\n    } else {\n      debugEl.style.display = \"none\";\n      debugEl.textContent = \"\";\n    }\n  }\n};\n\nexport const updateOverlay = (\n  container: Element | null,\n  data: OverlayData | null,\n  anchor: Element | null = null,\n  safeMode = false,\n  previewRegion?: {\n    top: number;\n    bottom: number;\n    containerHeight: number;\n    previewHeight: number;\n    controlsHeight: number;\n  }\n) => {\n  if (!data || (!container && !anchor)) {\n    if (currentHost) currentHost.remove();\n    restoreContainerPosition(currentContainer);\n    currentContainer = null;\n    currentHost = null;\n    currentAnchor = null;\n    return;\n  }\n\n  if (currentContainer !== container || currentAnchor !== anchor) {\n    if (currentHost) currentHost.remove();\n    restoreContainerPosition(currentContainer);\n    currentContainer = container;\n    currentAnchor = anchor;\n    currentHost = buildOverlay(data);\n\n    if (container) {\n      ensureContainerPosition(container);\n      container.appendChild(currentHost);\n      if (previewRegion) {\n        const topPct = Math.max(\n          0,\n          Math.min(100, (previewRegion.top / previewRegion.containerHeight) * 100)\n        );\n        const bottomPct = Math.max(\n          0,\n          Math.min(100, (previewRegion.bottom / previewRegion.containerHeight) * 100)\n        );\n        currentHost.style.setProperty(\"--preview-top\", `${topPct}%`);\n        currentHost.style.setProperty(\"--preview-bottom\", `${bottomPct}%`);\n        currentHost.style.setProperty(\"--preview-height\", `${previewRegion.previewHeight}px`);\n        currentHost.style.setProperty(\"--controls-height\", `${previewRegion.controlsHeight}px`);\n      }\n      if (safeMode) applySafePosition(currentHost, anchor ?? container);\n    } else if (anchor) {\n      document.documentElement.appendChild(currentHost);\n      applySafePosition(currentHost, anchor);\n    }\n\n    applyOverlayData(data);\n    return;\n  }\n\n  if (previewRegion) {\n    const topPct = Math.max(\n      0,\n      Math.min(100, (previewRegion.top / previewRegion.containerHeight) * 100)\n    );\n    const bottomPct = Math.max(\n      0,\n      Math.min(100, (previewRegion.bottom / previewRegion.containerHeight) * 100)\n    );\n    currentHost.style.setProperty(\"--preview-top\", `${topPct}%`);\n    currentHost.style.setProperty(\"--preview-bottom\", `${bottomPct}%`);\n    currentHost.style.setProperty(\"--preview-height\", `${previewRegion.previewHeight}px`);\n    currentHost.style.setProperty(\"--controls-height\", `${previewRegion.controlsHeight}px`);\n  }\n  applyOverlayData(data);\n};\n","import { log } from \"../shared/log\";\nimport { getStorage, setStorage } from \"../shared/storage\";\nimport {\n  detectActiveTitleContext,\n  extractGenresLine,\n  extractMetadataLine,\n  findOverlayAnchor,\n  findPreviewElement\n} from \"./netflixSelectors\";\nimport { updateOverlay } from \"./overlay\";\nimport type { ResolveTitleMessage, TitleResolvedMessage } from \"../shared/types\";\nimport { DEBUG } from \"../shared/log\";\n\nconst BADGE_ID = \"nxlb-debug-badge\";\nconst TOGGLE_COMBO = {\n  ctrlKey: true,\n  shiftKey: true,\n  key: \"l\"\n};\nconst OBSERVER_DEBOUNCE_MS = 250;\n\nconst ensureBadge = (enabled: boolean) => {\n  const existing = document.getElementById(BADGE_ID);\n  if (!enabled) {\n    existing?.remove();\n    return;\n  }\n\n  if (existing) return;\n\n  const host = document.createElement(\"div\");\n  host.id = BADGE_ID;\n  host.style.position = \"fixed\";\n  host.style.bottom = \"16px\";\n  host.style.right = \"16px\";\n  host.style.zIndex = \"2147483647\";\n\n  const shadow = host.attachShadow({ mode: \"open\" });\n  const style = document.createElement(\"style\");\n  style.textContent = `\n    :host {\n      all: initial;\n      font-family: \"Space Grotesk\", sans-serif;\n    }\n    .badge {\n      background: #111;\n      color: #f5f5f5;\n      border-radius: 999px;\n      padding: 6px 10px;\n      font-size: 11px;\n      letter-spacing: 0.08em;\n      text-transform: uppercase;\n      border: 1px solid rgba(255, 255, 255, 0.14);\n      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.35);\n    }\n  `;\n\n  const badge = document.createElement(\"div\");\n  badge.className = \"badge\";\n  badge.textContent = \"N×L active\";\n\n  shadow.appendChild(style);\n  shadow.appendChild(badge);\n  document.documentElement.appendChild(host);\n};\n\nlet overlayEnabled = true;\n\nconst applyOverlayState = async (enabled: boolean) => {\n  overlayEnabled = enabled;\n  if (!enabled) {\n    updateOverlay(null, null);\n  }\n  ensureBadge(enabled);\n};\n\nlet lastActiveKey = \"\";\nlet lastContainer: Element | null = null;\nlet debounceTimer: number | undefined;\nlet lastRequestId = \"\";\n\nconst serializeCandidate = (\n  candidate: ReturnType<typeof detectActiveTitleContext>[\"candidate\"]\n): string => {\n  if (!candidate) return \"\";\n  return [\n    candidate.netflixTitleId ?? \"\",\n    candidate.titleText ?? \"\",\n    candidate.year ?? \"\",\n    candidate.href ?? \"\"\n  ].join(\"|\");\n};\n\nconst emitActiveTitleChange = () => {\n  if (!overlayEnabled) return;\n\n  const { candidate, container } = detectActiveTitleContext();\n  const anchor = findOverlayAnchor(container);\n  const previewEl = findPreviewElement(container);\n  const metadataLine = extractMetadataLine(container);\n  const genresLine = extractGenresLine(container);\n  const previewRegion = (() => {\n    if (!container || !previewEl) return undefined;\n    const containerRect = container.getBoundingClientRect();\n    const previewRect = previewEl.getBoundingClientRect();\n    if (containerRect.height === 0) return undefined;\n    const top = Math.max(0, previewRect.top - containerRect.top);\n    const bottom = Math.max(0, previewRect.bottom - containerRect.top);\n    const controlsHeight = Math.max(0, containerRect.bottom - previewRect.bottom);\n    return {\n      top,\n      bottom,\n      containerHeight: containerRect.height,\n      previewHeight: Math.max(0, previewRect.height),\n      controlsHeight\n    };\n  })();\n  const safeMode = !container || !previewEl;\n  const key = serializeCandidate(candidate);\n  if (!candidate) {\n    try {\n      updateOverlay(null, null);\n    } catch (error) {\n      log(\"Overlay cleanup failed\", { error });\n    }\n    lastActiveKey = \"\";\n    lastContainer = null;\n    return;\n  }\n\n  if (key === lastActiveKey && container === lastContainer) return;\n  lastActiveKey = key;\n  lastContainer = container;\n  log(\"Active title changed\", {\n    ...candidate,\n    at: new Date().toISOString()\n  });\n\n  const requestId = `req_${Date.now()}_${Math.random().toString(36).slice(2, 8)}`;\n  lastRequestId = requestId;\n  const message: ResolveTitleMessage = {\n    type: \"RESOLVE_TITLE\",\n    requestId,\n    payload: {\n      netflixTitleId: candidate.netflixTitleId,\n      titleText: candidate.titleText,\n      year: candidate.year,\n      href: candidate.href\n    }\n  };\n\n  chrome.runtime\n    .sendMessage(message)\n    .then((response: TitleResolvedMessage) => {\n      if (response?.type !== \"TITLE_RESOLVED\") return;\n      if (response.requestId !== lastRequestId) return;\n      log(\"Title resolved\", { requestId, response });\n\n      try {\n        updateOverlay(\n          container,\n          {\n            titleLine,\n            metadataLine,\n            genresLine,\n            communityRating: response.payload.tmdbVoteAverage,\n            ratingCount: response.payload.tmdbVoteCount,\n            inWatchlist: response.payload.inWatchlist,\n            userRating: response.payload.userRating,\n            matchScore: response.payload.matchScore,\n            matchExplanation: response.payload.matchExplanation,\n            debug: DEBUG\n              ? {\n                ...candidate,\n                ...response.payload\n              }\n              : undefined\n          },\n          anchor,\n          safeMode,\n          previewRegion\n        );\n      } catch (error) {\n        log(\"Overlay update failed\", { error });\n      }\n    })\n    .catch((err) => {\n      log(\"Title resolve failed\", { requestId, err });\n    });\n\n  const titleLine = candidate.titleText\n    ? candidate.year\n      ? `${candidate.titleText} (${candidate.year})`\n      : candidate.titleText\n    : \"Unknown title\";\n\n  try {\n    updateOverlay(\n      container,\n      {\n        titleLine,\n        metadataLine,\n        genresLine,\n        debug: DEBUG ? { ...candidate } : undefined\n      },\n      anchor,\n      safeMode,\n      previewRegion\n    );\n  } catch (error) {\n    log(\"Overlay update failed\", { error });\n  }\n};\n\nconst scheduleActiveTitleCheck = () => {\n  if (debounceTimer) window.clearTimeout(debounceTimer);\n  debounceTimer = window.setTimeout(() => {\n    emitActiveTitleChange();\n  }, OBSERVER_DEBOUNCE_MS);\n};\n\nconst observeTitleChanges = () => {\n  const observer = new MutationObserver(() => {\n    try {\n      scheduleActiveTitleCheck();\n    } catch (error) {\n      log(\"Mutation observer failed\", { error });\n    }\n  });\n  observer.observe(document.body, {\n    childList: true,\n    subtree: true,\n    attributes: true,\n    attributeFilter: [\"class\", \"style\", \"aria-expanded\", \"aria-hidden\"]\n  });\n\n  document.addEventListener(\"pointerover\", () => {\n    try {\n      scheduleActiveTitleCheck();\n    } catch (error) {\n      log(\"Pointer observer failed\", { error });\n    }\n  }, true);\n  document.addEventListener(\"focusin\", () => {\n    try {\n      scheduleActiveTitleCheck();\n    } catch (error) {\n      log(\"Focus observer failed\", { error });\n    }\n  }, true);\n  scheduleActiveTitleCheck();\n};\n\nconst toggleOverlay = async () => {\n  const state = await getStorage();\n  const next = !(state.overlayEnabled ?? true);\n  await setStorage({ overlayEnabled: next });\n  await applyOverlayState(next);\n  if (next) scheduleActiveTitleCheck();\n  log(\"Overlay toggled\", { enabled: next });\n};\n\nconst handleKeydown = (event: KeyboardEvent) => {\n  if (\n    event.ctrlKey === TOGGLE_COMBO.ctrlKey &&\n    event.shiftKey === TOGGLE_COMBO.shiftKey &&\n    event.key.toLowerCase() === TOGGLE_COMBO.key\n  ) {\n    event.preventDefault();\n    toggleOverlay().catch((err) => log(\"Toggle failed\", err));\n  }\n};\n\nconst init = async () => {\n  const state = await getStorage();\n  const enabled = state.overlayEnabled ?? true;\n  await applyOverlayState(enabled);\n  observeTitleChanges();\n  window.addEventListener(\"keydown\", handleKeydown);\n};\n\nif (document.readyState === \"loading\") {\n  document.addEventListener(\"DOMContentLoaded\", () => {\n    init().catch((err) => log(\"Init failed\", err));\n  }, { once: true });\n} else {\n  init().catch((err) => log(\"Init failed\", err));\n}\n"],"names":["log","args","getStorage","setStorage","state","TITLE_ANCHOR_SELECTOR","CONTAINER_SELECTORS","TITLE_TEXT_SELECTORS","PREVIEW_SELECTORS","METADATA_SELECTORS","GENRE_SELECTORS","isVisible","el","rect","style","normalizeText","value","text","collectVisibleText","container","selectors","values","selector","isMetadataCandidate","lower","parseTitleIdFromHref","href","match","parseYearFromText","year","extractFromAnchor","anchor","source","netflixTitleId","titleText","extractTitleTextNear","findOverlayAnchor","findBestAnchorIn","pageAnchor","findPreviewElement","extractMetadataLine","unique","extractGenresLine","anchors","visible","findExpandedContainers","nodes","detectActiveTitleContext","containers","candidate","fallbackAnchor","OVERLAY_ID","SAFE_OFFSET","positionOverrides","ensureContainerPosition","restoreContainerPosition","previous","buildOverlay","data","host","shadow","panel","top","titleSection","title","metaLine","genresLine","branding","divider","metadata","communityRating","because","preview","controls","debug","currentContainer","currentHost","currentAnchor","applySafePosition","formatRatingCount","applyOverlayData","titleEl","_a","communityEl","_b","count","matchEl","_c","becauseEl","_d","metaEl","_e","genresEl","_f","debugEl","_g","updateOverlay","safeMode","previewRegion","topPct","bottomPct","BADGE_ID","TOGGLE_COMBO","OBSERVER_DEBOUNCE_MS","ensureBadge","enabled","existing","badge","overlayEnabled","applyOverlayState","lastActiveKey","lastContainer","debounceTimer","lastRequestId","serializeCandidate","emitActiveTitleChange","previewEl","metadataLine","containerRect","previewRect","bottom","controlsHeight","key","requestId","message","response","titleLine","err","scheduleActiveTitleCheck","observeTitleChanges","toggleOverlay","next","handleKeydown","event","init"],"mappings":"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"}