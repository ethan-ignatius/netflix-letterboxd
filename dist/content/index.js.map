{"version":3,"file":"index.js","sources":["../../src/shared/constants.ts","../../src/shared/logger.ts","../../src/shared/storage.ts","../../src/content/netflix/selectors.ts","../../src/content/ui/overlay/index.ts","../../src/content/ui/badge/index.ts","../../src/content/OverlayController.ts","../../src/content/index.ts"],"sourcesContent":["export const DEBUG = import.meta.env.DEV;\n\nexport const STORAGE_KEYS = {\n  OVERLAY_ENABLED: \"overlayEnabled\",\n  TMDB_API_KEY: \"tmdbApiKey\",\n  TMDB_CACHE: \"tmdbCache\",\n  TMDB_FEATURE_CACHE: \"tmdbFeatureCache\",\n  MATCH_PROFILE: \"matchProfile\",\n  LETTERBOXD_INDEX: \"lb_index_v1\",\n  LETTERBOXD_STATS: \"lb_stats_v1\",\n  LAST_IMPORT_AT: \"lastImportAt\"\n} as const;\n\nexport type StorageKey = (typeof STORAGE_KEYS)[keyof typeof STORAGE_KEYS];\n","import { DEBUG } from \"./constants\";\n\nexport { DEBUG };\n\nexport const log = (...args: unknown[]) => {\n  if (!DEBUG) return;\n  console.log(\"[Netflix+Letterboxd]\", ...args);\n};\n\nexport const warn = (...args: unknown[]) => {\n  if (!DEBUG) return;\n  console.warn(\"[Netflix+Letterboxd]\", ...args);\n};\n\nexport const error = (...args: unknown[]) => {\n  if (!DEBUG) return;\n  console.error(\"[Netflix+Letterboxd]\", ...args);\n};\n","import { log, warn } from \"./logger\";\nimport { STORAGE_KEYS } from \"./constants\";\nimport { makeKey, parseLegacyLetterboxdKey } from \"./normalize\";\nimport type { LetterboxdIndex, LetterboxdIndexLegacy, LetterboxdStats } from \"./types\";\n\nexport interface StorageState {\n  [STORAGE_KEYS.OVERLAY_ENABLED]?: boolean;\n  [STORAGE_KEYS.TMDB_API_KEY]?: string;\n  [STORAGE_KEYS.TMDB_CACHE]?: Record<string, unknown>;\n  [STORAGE_KEYS.TMDB_FEATURE_CACHE]?: Record<string, unknown>;\n  [STORAGE_KEYS.MATCH_PROFILE]?: Record<string, unknown>;\n  [STORAGE_KEYS.LETTERBOXD_INDEX]?: LetterboxdIndex | LetterboxdIndexLegacy;\n  [STORAGE_KEYS.LETTERBOXD_STATS]?: LetterboxdStats;\n  [STORAGE_KEYS.LAST_IMPORT_AT]?: string;\n}\n\nexport const getStorage = async (): Promise<StorageState> => {\n  log(\"Loading storage state\");\n  return chrome.storage.local.get([\n    STORAGE_KEYS.OVERLAY_ENABLED,\n    STORAGE_KEYS.TMDB_API_KEY,\n    STORAGE_KEYS.TMDB_CACHE,\n    STORAGE_KEYS.TMDB_FEATURE_CACHE,\n    STORAGE_KEYS.MATCH_PROFILE,\n    STORAGE_KEYS.LETTERBOXD_INDEX,\n    STORAGE_KEYS.LETTERBOXD_STATS,\n    STORAGE_KEYS.LAST_IMPORT_AT\n  ]) as Promise<StorageState>;\n};\n\nexport const setStorage = async (state: StorageState): Promise<void> => {\n  log(\"Saving storage state\", state);\n  await chrome.storage.local.set(state);\n};\n\nexport const clearStorage = async (): Promise<void> => {\n  warn(\"Clearing storage state\");\n  await chrome.storage.local.clear();\n};\n\nexport const getLetterboxdIndex = async (): Promise<LetterboxdIndex | null> => {\n  const data = await chrome.storage.local.get([STORAGE_KEYS.LETTERBOXD_INDEX]);\n  const raw = data[STORAGE_KEYS.LETTERBOXD_INDEX] as\n    | LetterboxdIndex\n    | LetterboxdIndexLegacy\n    | undefined;\n  if (!raw) return null;\n\n  if (\"ratingsByKey\" in raw && \"watchlistKeys\" in raw) {\n    const index = raw as LetterboxdIndex;\n    const needsMigration =\n      Object.keys(index.ratingsByKey).some((key) => key.includes(\"|\")) ||\n      Object.keys(index.watchlistKeys).some((key) => key.includes(\"|\"));\n    if (!needsMigration) return index;\n    const migratedRatings: Record<string, number> = {};\n    const migratedWatchlist: Record<string, true> = {};\n    Object.entries(index.ratingsByKey).forEach(([key, rating]) => {\n      const parsed = parseLegacyLetterboxdKey(key);\n      const nextKey = makeKey(parsed.title, parsed.year);\n      migratedRatings[nextKey] = rating;\n    });\n    Object.keys(index.watchlistKeys).forEach((key) => {\n      const parsed = parseLegacyLetterboxdKey(key);\n      const nextKey = makeKey(parsed.title, parsed.year);\n      migratedWatchlist[nextKey] = true;\n    });\n    return {\n      ratingsByKey: migratedRatings,\n      watchlistKeys: migratedWatchlist,\n      updatedAt: Date.now()\n    };\n  }\n\n  const legacy = raw as LetterboxdIndexLegacy;\n  const ratingsByKey: Record<string, number> = {};\n  const watchlistKeys: Record<string, true> = {};\n  Object.entries(legacy).forEach(([key, entry]) => {\n    const parsed = parseLegacyLetterboxdKey(key);\n    const nextKey = makeKey(parsed.title, parsed.year);\n    if (entry.r !== undefined) ratingsByKey[nextKey] = entry.r;\n    if (entry.w === 1) watchlistKeys[nextKey] = true;\n  });\n  return {\n    ratingsByKey,\n    watchlistKeys,\n    updatedAt: Date.now()\n  };\n};\n\nexport const setLetterboxdIndex = async (index: LetterboxdIndex): Promise<void> => {\n  await chrome.storage.local.set({ [STORAGE_KEYS.LETTERBOXD_INDEX]: index });\n};\n","export interface ActiveTitleCandidate {\n  netflixTitleId?: string;\n  titleText?: string;\n  year?: number;\n  href?: string;\n  source: string;\n}\n\nconst TITLE_ANCHOR_SELECTOR = \"a[href^='/title/']\";\n\nconst CONTAINER_SELECTORS = [\n  \"[role='dialog']\",\n  \"[aria-modal='true']\",\n  \"[aria-expanded='true']\",\n  \"[data-uia*='jawbone']\",\n  \"[class*='jawbone']\",\n  \"[data-uia*='preview']\",\n  \"[data-uia*='billboard']\",\n  \"[data-uia*='hero']\",\n  \"[data-uia*='details']\"\n];\n\nexport const EXPANDED_CONTAINER_SELECTOR = CONTAINER_SELECTORS.join(\",\");\n\nconst TITLE_TEXT_SELECTORS = [\n  \"h1\",\n  \"h2\",\n  \"h3\",\n  \"[data-uia*='title']\",\n  \"[class*='title']\",\n  \"[class*='fallback']\",\n  \"[class*='preview'] [class*='header']\"\n];\n\nconst PREVIEW_SELECTORS = [\n  \"video\",\n  \"img\",\n  \"[data-uia*='preview'] video\",\n  \"[data-uia*='preview'] img\",\n  \"[class*='preview'] video\",\n  \"[class*='preview'] img\",\n  \"[data-uia*='player'] video\",\n  \"[data-uia*='hero'] img\"\n];\n\nconst CONTROLS_SELECTORS = [\n  \"[data-uia*='controls']\",\n  \"[class*='controls']\",\n  \"[class*='control']\",\n  \"[role='toolbar']\"\n];\n\nconst EPISODE_TITLE_PATTERN =\n  /(S\\d+\\s*:?\\s*E\\d+|Season\\s*\\d+\\s*Episode\\s*\\d+|Episode\\s*\\d+|\\bE\\d+\\b)/i;\nconst EPISODE_TIME_PATTERN = /(\\b\\d+\\s*(m|min|minutes)\\b|\\b\\d+\\s*of\\s*\\d+\\s*(m|min|minutes)\\b)/i;\n\nconst METADATA_SELECTORS = [\n  \"[data-uia*='maturity-rating']\",\n  \"[data-uia*='season']\",\n  \"[data-uia*='resolution']\",\n  \"[data-uia*='hd']\",\n  \"[class*='maturity']\",\n  \"[class*='season']\",\n  \"[class*='quality']\"\n];\n\nconst GENRE_SELECTORS = [\n  \"[data-uia*='genre']\",\n  \"a[href*='/genre/']\",\n  \"[class*='genre']\"\n];\n\nconst TITLE_LIKE_SELECTORS = [\n  \"h1\",\n  \"h2\",\n  \"h3\",\n  \"h4\",\n  \"[data-uia*='title']\",\n  \"[class*='title']\",\n  \"[class*='headline']\",\n  \"[class*='header']\",\n  \"[class*='name']\"\n];\n\nconst NAV_BANNED_PATTERN = /(browse|home|my list|popular)/i;\n\nconst isVisible = (el: Element): boolean => {\n  const rect = el.getBoundingClientRect();\n  if (rect.width === 0 || rect.height === 0) return false;\n  const style = window.getComputedStyle(el as HTMLElement);\n  if (style.visibility === \"hidden\" || style.display === \"none\" || style.opacity === \"0\") {\n    return false;\n  }\n  const inViewport =\n    rect.bottom >= 0 &&\n    rect.right >= 0 &&\n    rect.top <= window.innerHeight &&\n    rect.left <= window.innerWidth;\n  return inViewport;\n};\n\nconst normalizeText = (value?: string | null): string | undefined => {\n  if (!value) return undefined;\n  const text = value.replace(/\\s+/g, \" \").trim();\n  return text.length ? text : undefined;\n};\n\nconst parseTitleIdFromHref = (href?: string | null): string | undefined => {\n  if (!href) return undefined;\n  const match = href.match(/\\/title\\/(\\d+)/);\n  return match?.[1];\n};\n\nconst parseYearFromText = (text?: string): number | undefined => {\n  if (!text) return undefined;\n  const match = text.match(/(19\\d{2}|20\\d{2})/);\n  if (!match) return undefined;\n  const year = Number(match[1]);\n  if (Number.isNaN(year)) return undefined;\n  return year;\n};\n\nexport const normalizeNetflixTitle = (raw?: string): string | undefined => {\n  if (!raw) return undefined;\n  let value = raw;\n  value = value.replace(/^\\s*S\\d+\\s*:?\\s*E\\d+\\s*/i, \"\");\n  value = value.replace(/\"[^\"]*\"/g, (match) => {\n    const inner = match.replace(/\"/g, \"\");\n    return EPISODE_TITLE_PATTERN.test(inner) ? \"\" : match;\n  });\n  value = value.replace(/Episode\\s*\\d+/gi, \"\");\n  value = value.replace(/\\bE\\d+\\b/gi, \"\");\n  value = value.replace(EPISODE_TIME_PATTERN, \"\");\n  value = value.replace(/\\s+of\\s+\\d+\\s*(m|min|minutes)?/gi, \"\");\n  value = value.replace(/\\s+/g, \" \").trim();\n  return value.length ? value : undefined;\n};\n\nconst extractFromAnchor = (anchor: HTMLAnchorElement, source: string): ActiveTitleCandidate => {\n  const href = anchor.getAttribute(\"href\") || undefined;\n  const netflixTitleId = parseTitleIdFromHref(href);\n  const titleText = normalizeText(anchor.getAttribute(\"aria-label\") || anchor.textContent);\n  return { netflixTitleId, titleText, href, source };\n};\n\nconst extractTitleTextNear = (container: Element): string | undefined => {\n  for (const selector of TITLE_TEXT_SELECTORS) {\n    const el = container.querySelector(selector);\n    if (el && isVisible(el)) {\n      const text = normalizeText(el.textContent);\n      if (text) return text;\n    }\n  }\n  return undefined;\n};\n\nexport const getRawTitleText = (container?: Element | null): string | undefined => {\n  if (!container) return undefined;\n  return extractTitleTextNear(container);\n};\n\nconst findPrimaryTitle = (container?: Element | null): string | undefined => {\n  if (!container) return undefined;\n  for (const selector of TITLE_TEXT_SELECTORS) {\n    const nodes = Array.from(container.querySelectorAll(selector));\n    for (const node of nodes) {\n      if (!isVisible(node)) continue;\n      const text = normalizeText(node.textContent);\n      if (!text) continue;\n      if (EPISODE_TITLE_PATTERN.test(text) || EPISODE_TIME_PATTERN.test(text)) continue;\n      const normalized = normalizeNetflixTitle(text);\n      if (normalized) return normalized;\n    }\n  }\n  return undefined;\n};\n\nexport const findOverlayAnchor = (container?: Element | null): Element | null => {\n  if (container) {\n    const anchor = findBestAnchorIn(container);\n    if (anchor && isVisible(anchor)) return anchor;\n    for (const selector of TITLE_TEXT_SELECTORS) {\n      const el = container.querySelector(selector);\n      if (el && isVisible(el)) return el;\n    }\n  }\n\n  const pageAnchor = Array.from(\n    document.querySelectorAll<HTMLAnchorElement>(TITLE_ANCHOR_SELECTOR)\n  ).find(isVisible);\n  if (pageAnchor) return pageAnchor;\n\n  const pageTitle = Array.from(document.querySelectorAll(TITLE_TEXT_SELECTORS.join(\",\"))).find(\n    isVisible\n  );\n  return pageTitle ?? null;\n};\n\nexport const findPreviewElement = (container?: Element | null): Element | null => {\n  if (!container) return null;\n  const candidates: Element[] = [];\n  PREVIEW_SELECTORS.forEach((selector) => {\n    container.querySelectorAll(selector).forEach((el) => {\n      if (isVisible(el)) candidates.push(el);\n    });\n  });\n  if (!candidates.length) return null;\n  return candidates.reduce((best, current) => {\n    const bestRect = best.getBoundingClientRect();\n    const currentRect = current.getBoundingClientRect();\n    const bestArea = bestRect.width * bestRect.height;\n    const currentArea = currentRect.width * currentRect.height;\n    return currentArea > bestArea ? current : best;\n  });\n};\n\nexport const findControlsRow = (root?: Element | null): HTMLElement | null => {\n  if (!root) return null;\n  const candidates: HTMLElement[] = [];\n  CONTROLS_SELECTORS.forEach((selector) => {\n    root.querySelectorAll<HTMLElement>(selector).forEach((el) => {\n      if (!isVisible(el)) return;\n      candidates.push(el);\n    });\n  });\n  const unique = Array.from(new Set(candidates));\n  const scored = unique\n    .map((el) => {\n      const buttons = el.querySelectorAll(\"button, [role='button']\").length;\n      const rect = el.getBoundingClientRect();\n      const score = buttons * 10 + rect.width;\n      return { el, score, top: rect.top };\n    })\n    .filter((entry) => entry.score > 0);\n  scored.sort((a, b) => b.score - a.score || b.top - a.top);\n  return scored[0]?.el ?? null;\n};\n\nexport const hasMetadataSection = (root?: Element | null): boolean => {\n  if (!root) return false;\n  const selectors = [...METADATA_SELECTORS, ...GENRE_SELECTORS].join(\",\");\n  const nodes = Array.from(root.querySelectorAll(selectors));\n  return nodes.some((node) => isVisible(node));\n};\n\nexport const findExpandedRoot = (): HTMLElement | null => {\n  const candidates = findExpandedContainers();\n  const maxWidth = window.innerWidth * 0.85;\n  const maxHeight = window.innerHeight * 0.6;\n  for (const candidate of candidates) {\n    const rect = candidate.getBoundingClientRect();\n    if (rect.width > maxWidth || rect.height > maxHeight) continue;\n    const preview = findPreviewElement(candidate);\n    const controls = findControlsRow(candidate);\n    const metadata = hasMetadataSection(candidate);\n    if (preview && controls && metadata) {\n      return candidate as HTMLElement;\n    }\n  }\n  return null;\n};\n\n\nconst isBannedTitleText = (text: string) => {\n  if (NAV_BANNED_PATTERN.test(text)) return true;\n  return (\n    EPISODE_TITLE_PATTERN.test(text) ||\n    EPISODE_TIME_PATTERN.test(text) ||\n    /\\b\\d+\\s*of\\s*\\d+\\s*(m|min|minutes)?\\b/i.test(text) ||\n    /\\b\\d+\\s*(m|min|minutes)\\b/i.test(text)\n  );\n};\n\nconst isInProgressRegion = (el: Element, controlsTop?: number) => {\n  if (el.closest('[role=\"progressbar\"], [data-uia*=\"progress\"], [class*=\"progress\"]')) {\n    return true;\n  }\n  if (controlsTop !== undefined) {\n    const rect = el.getBoundingClientRect();\n    return rect.bottom >= controlsTop - 8;\n  }\n  return false;\n};\n\nexport const extractDisplayTitle = (expandedRoot: HTMLElement): {\n  title: string | null;\n  chosen?: Element;\n  rejectedCount: number;\n} => {\n  const rootRect = expandedRoot.getBoundingClientRect();\n  const controls = findControlsRow(expandedRoot);\n  const controlsTop = controls ? controls.getBoundingClientRect().top : undefined;\n  const candidates = Array.from(expandedRoot.querySelectorAll(TITLE_LIKE_SELECTORS.join(\",\")));\n  let best: { el: Element; score: number; text: string } | undefined;\n  let rejectedCount = 0;\n  const episodeNodes: Element[] = [];\n\n  candidates.forEach((el) => {\n    if (!isVisible(el)) {\n      rejectedCount += 1;\n      return;\n    }\n    if (isInProgressRegion(el, controlsTop)) {\n      rejectedCount += 1;\n      return;\n    }\n    const text = normalizeText(el.textContent);\n    if (!text || text.length < 2 || text.length > 80) {\n      rejectedCount += 1;\n      return;\n    }\n    if (isBannedTitleText(text)) {\n      episodeNodes.push(el);\n      rejectedCount += 1;\n      return;\n    }\n\n    const rect = el.getBoundingClientRect();\n    const style = window.getComputedStyle(el as HTMLElement);\n    const fontSize = parseFloat(style.fontSize) || 14;\n    const fontWeightRaw = style.fontWeight === \"bold\" ? 700 : Number(style.fontWeight);\n    const fontWeight = Number.isNaN(fontWeightRaw) ? 400 : fontWeightRaw;\n    const dx = rect.left - rootRect.left;\n    const dy = rect.top - rootRect.top;\n    const dist = Math.hypot(dx, dy);\n    const score = fontSize * 10 + fontWeight / 10 + Math.max(0, 300 - dist);\n    if (!best || score > best.score) {\n      best = { el, score, text };\n    }\n  });\n\n  if (best) {\n    const normalized = normalizeNetflixTitle(best.text);\n    return { title: normalized ?? best.text, chosen: best.el, rejectedCount };\n  }\n\n  for (const episodeNode of episodeNodes) {\n    let current: Element | null = episodeNode.parentElement;\n    let depth = 0;\n    while (current && depth < 4) {\n      const siblingCandidates = Array.from(\n        current.querySelectorAll(TITLE_LIKE_SELECTORS.join(\",\"))\n      ).filter((el) => el !== episodeNode);\n      for (const sibling of siblingCandidates) {\n        if (!isVisible(sibling)) continue;\n        if (isInProgressRegion(sibling, controlsTop)) continue;\n        const text = normalizeText(sibling.textContent);\n        if (!text || text.length < 2 || text.length > 80) continue;\n        if (isBannedTitleText(text)) continue;\n        return {\n          title: normalizeNetflixTitle(text) ?? text,\n          chosen: sibling,\n          rejectedCount\n        };\n      }\n      current = current.parentElement;\n      depth += 1;\n    }\n  }\n\n  const anchor = expandedRoot.querySelector(\"a[href^='/title/']\");\n  if (anchor) {\n    const heading = anchor.querySelector(TITLE_LIKE_SELECTORS.join(\",\"));\n    const directText = normalizeText(heading?.textContent || anchor.textContent);\n    if (directText && !isBannedTitleText(directText)) {\n      return {\n        title: normalizeNetflixTitle(directText) ?? directText,\n        chosen: heading ?? anchor,\n        rejectedCount\n      };\n    }\n\n    let current: Element | null = anchor.parentElement;\n    let depth = 0;\n    while (current && depth < 4) {\n      const nearby = Array.from(current.querySelectorAll(TITLE_LIKE_SELECTORS.join(\",\")));\n      for (const node of nearby) {\n        if (!isVisible(node)) continue;\n        if (isInProgressRegion(node, controlsTop)) continue;\n        const text = normalizeText(node.textContent);\n        if (!text || text.length < 2 || text.length > 80) continue;\n        if (isBannedTitleText(text)) continue;\n        return {\n          title: normalizeNetflixTitle(text) ?? text,\n          chosen: node,\n          rejectedCount\n        };\n      }\n      current = current.parentElement;\n      depth += 1;\n    }\n  }\n\n  return { title: null, rejectedCount };\n};\n\nexport const resolveTitleText = (\n  container?: Element | null,\n  fallback?: string\n): string | undefined => {\n  const primary = findPrimaryTitle(container);\n  if (primary) return primary;\n\n  const normalizedFallback = normalizeNetflixTitle(fallback);\n  if (normalizedFallback && !EPISODE_TITLE_PATTERN.test(normalizedFallback)) {\n    return normalizedFallback;\n  }\n\n  if (fallback) return normalizeNetflixTitle(fallback) ?? fallback;\n  return undefined;\n};\n\n\nconst findBestAnchorIn = (container: Element): HTMLAnchorElement | undefined => {\n  const anchors = Array.from(container.querySelectorAll<HTMLAnchorElement>(TITLE_ANCHOR_SELECTOR));\n  const visible = anchors.filter(isVisible);\n  if (visible.length > 0) return visible[0];\n  return anchors[0];\n};\n\nconst findExpandedContainers = (): Element[] => {\n  const selectors = CONTAINER_SELECTORS.join(\",\");\n  const nodes = Array.from(document.querySelectorAll(selectors));\n  const visible = nodes.filter(isVisible);\n  const maxWidth = window.innerWidth * 0.85;\n  const maxHeight = window.innerHeight * 0.6;\n  const filtered = visible.filter((el) => {\n    const rect = el.getBoundingClientRect();\n    if (rect.width === 0 || rect.height === 0) return false;\n    if (rect.width < 240 || rect.height < 180) return false;\n    if (rect.width > maxWidth || rect.height > maxHeight) return false;\n    return true;\n  });\n  if (filtered.length > 0) {\n    return filtered.sort((a, b) => {\n      const ra = a.getBoundingClientRect();\n      const rb = b.getBoundingClientRect();\n      return rb.width * rb.height - ra.width * ra.height;\n    });\n  }\n  return visible.length > 0 ? visible : nodes;\n};\n\nexport const detectActiveTitleContext = (): {\n  candidate: ActiveTitleCandidate | null;\n  container: Element | null;\n} => {\n  const containers = findExpandedContainers();\n\n  for (const container of containers) {\n    const anchor = findBestAnchorIn(container);\n    if (anchor) {\n      const candidate = extractFromAnchor(anchor, \"container-anchor\");\n      if (candidate.netflixTitleId || candidate.titleText) {\n        const titleText = candidate.titleText ?? extractTitleTextNear(container);\n        const resolvedTitle = resolveTitleText(container, titleText ?? candidate.titleText);\n        return {\n          candidate: {\n            ...candidate,\n            titleText: resolvedTitle,\n            year: parseYearFromText(resolvedTitle ?? titleText)\n          },\n          container\n        };\n      }\n    }\n\n    const titleText = extractTitleTextNear(container);\n    if (titleText) {\n      const resolvedTitle = resolveTitleText(container, titleText);\n      return {\n        candidate: {\n          titleText: resolvedTitle ?? titleText,\n          year: parseYearFromText(resolvedTitle ?? titleText),\n          source: \"container-text\"\n        },\n        container\n      };\n    }\n  }\n\n  const fallbackAnchor = Array.from(\n    document.querySelectorAll<HTMLAnchorElement>(TITLE_ANCHOR_SELECTOR)\n  ).find(isVisible);\n  if (fallbackAnchor) {\n    const candidate = extractFromAnchor(fallbackAnchor, \"page-anchor\");\n    const resolvedTitle = resolveTitleText(\n      fallbackAnchor.closest(CONTAINER_SELECTORS.join(\",\")) ?? fallbackAnchor.parentElement,\n      candidate.titleText\n    );\n    return {\n      candidate: {\n        ...candidate,\n        titleText: resolvedTitle ?? candidate.titleText,\n        year: parseYearFromText(resolvedTitle ?? candidate.titleText)\n      },\n      container: fallbackAnchor.closest(CONTAINER_SELECTORS.join(\",\")) ?? fallbackAnchor.parentElement\n    };\n  }\n\n  return { candidate: null, container: null };\n};\n\n// Intentionally no default export.\n","import type { OverlayData } from \"../../../shared/types\";\n\nconst TOP_SECTION_ID = \"nxlb-top-section\";\n\nconst buildTopSection = (): HTMLDivElement => {\n  const host = document.createElement(\"div\");\n  host.id = TOP_SECTION_ID;\n  host.style.display = \"block\";\n  host.style.width = \"100%\";\n  host.style.pointerEvents = \"none\";\n\n  const shadow = host.attachShadow({ mode: \"open\" });\n  const style = document.createElement(\"style\");\n  style.textContent = `\n    :host {\n      all: initial;\n      font-family: \"Netflix Sans\", \"Helvetica Neue\", Helvetica, Arial, sans-serif;\n      pointer-events: none;\n      display: block;\n      width: 100%;\n      box-sizing: border-box;\n      opacity: 0;\n      transform: translateY(-8px);\n      transition: opacity 180ms cubic-bezier(0.2, 0, 0, 1),\n        transform 180ms cubic-bezier(0.2, 0, 0, 1);\n      will-change: opacity, transform;\n    }\n    :host(.nxl-visible) {\n      opacity: 1;\n      transform: translateY(0);\n    }\n    .nxl-top-section {\n      background: rgba(0, 0, 0, 0.82);\n      color: #f5f5f5;\n      padding: 16px 20px;\n      border-top-left-radius: 12px;\n      border-top-right-radius: 12px;\n      border-bottom: 1px solid rgba(255, 255, 255, 0.1);\n      display: grid;\n      gap: 8px;\n      box-sizing: border-box;\n    }\n    .nxl-header {\n      display: flex;\n      align-items: center;\n      justify-content: flex-end;\n      gap: 16px;\n    }\n    .nxl-branding {\n      display: inline-flex;\n      align-items: center;\n      gap: 8px;\n      font-size: 12px;\n      color: rgba(255, 255, 255, 0.85);\n      white-space: nowrap;\n      flex-shrink: 0;\n    }\n    .nxl-dots {\n      display: inline-flex;\n      gap: 4px;\n      align-items: center;\n    }\n    .nxl-dot {\n      width: 8px;\n      height: 8px;\n      border-radius: 999px;\n      display: inline-block;\n    }\n    .nxl-dot.green { background: #00c46a; }\n    .nxl-dot.orange { background: #f2b34c; }\n    .nxl-dot.blue { background: #4aa8ff; }\n    .nxl-body {\n      display: grid;\n      gap: 6px;\n      font-size: 15px;\n      color: rgba(255, 255, 255, 0.9);\n    }\n    .nxl-rating {\n      display: flex;\n      align-items: center;\n      gap: 8px;\n    }\n    .nxl-star {\n      color: #e3b341;\n      font-size: 16px;\n    }\n    .nxl-match {\n      display: flex;\n      align-items: baseline;\n      gap: 8px;\n    }\n    .nxl-match-value {\n      color: #46d369;\n      font-weight: 700;\n      font-size: 20px;\n    }\n    .nxl-because {\n      color: rgba(255, 255, 255, 0.7);\n      font-size: 14px;\n    }\n    .nxl-badges {\n      display: flex;\n      gap: 8px;\n      flex-wrap: wrap;\n      font-size: 12px;\n      color: rgba(255, 255, 255, 0.85);\n    }\n    .nxl-badge {\n      display: inline-flex;\n      align-items: center;\n      gap: 6px;\n      padding: 4px 8px;\n      border-radius: 999px;\n      border: 1px solid rgba(255, 255, 255, 0.18);\n      background: rgba(255, 255, 255, 0.06);\n    }\n  `;\n\n  const section = document.createElement(\"div\");\n  section.className = \"nxl-top-section\";\n\n  const header = document.createElement(\"div\");\n  header.className = \"nxl-header\";\n\n  const branding = document.createElement(\"div\");\n  branding.className = \"nxl-branding\";\n  branding.innerHTML = `\n    Powered by\n    <span class=\"nxl-dots\">\n      <span class=\"nxl-dot green\"></span>\n      <span class=\"nxl-dot orange\"></span>\n      <span class=\"nxl-dot blue\"></span>\n    </span>\n    Letterboxd\n  `;\n\n  header.appendChild(branding);\n\n  const body = document.createElement(\"div\");\n  body.className = \"nxl-body\";\n\n  const communityRating = document.createElement(\"div\");\n  communityRating.className = \"nxl-rating\";\n  communityRating.dataset.field = \"communityRating\";\n  communityRating.textContent = \"Community rating: —\";\n\n  const match = document.createElement(\"div\");\n  match.className = \"nxl-match\";\n  match.dataset.field = \"match\";\n  match.textContent = \"Your match: —\";\n\n  const because = document.createElement(\"div\");\n  because.className = \"nxl-because\";\n  because.dataset.field = \"because\";\n  because.textContent = \"Because you like: —\";\n\n  const badges = document.createElement(\"div\");\n  badges.className = \"nxl-badges\";\n  badges.dataset.field = \"badges\";\n\n  body.appendChild(communityRating);\n  body.appendChild(match);\n  body.appendChild(because);\n  body.appendChild(badges);\n\n  section.appendChild(header);\n  section.appendChild(body);\n\n  shadow.appendChild(style);\n  shadow.appendChild(section);\n\n  return host;\n};\n\nconst formatRatingCount = (value: number | null | undefined) => {\n  if (value === undefined || value === null) return \"\";\n  if (value >= 1_000_000) return `${(value / 1_000_000).toFixed(1)}M`;\n  if (value >= 1_000) return `${(value / 1_000).toFixed(1)}K`;\n  return `${value}`;\n};\n\nconst renderStars = (rating: number) => {\n  const clamped = Math.max(0, Math.min(5, rating));\n  const full = Math.floor(clamped);\n  const half = clamped % 1 >= 0.5;\n  return \"★\".repeat(full) + (half ? \"½\" : \"\");\n};\n\nconst applyTopSectionData = (host: HTMLDivElement, data: OverlayData) => {\n  const tmdbVoteAverage = data.tmdb?.voteAverage ?? null;\n  const tmdbVoteCount = data.tmdb?.voteCount ?? null;\n  const letterboxd = data.letterboxd;\n  const communityEl = host.shadowRoot?.querySelector(\n    \"[data-field='communityRating']\"\n  ) as HTMLDivElement | null;\n  if (communityEl) {\n    if (tmdbVoteAverage !== null && tmdbVoteAverage !== undefined) {\n      const count = formatRatingCount(tmdbVoteCount);\n      const ratingOutOfFive = tmdbVoteAverage / 2;\n      communityEl.innerHTML = `\n        Community rating:\n        <span class=\"nxl-star\">★</span>\n        ${ratingOutOfFive.toFixed(1)}${\n        count ? ` <span class=\"nxl-meta\">${count} ratings</span>` : \"\"\n      }\n      `;\n    } else {\n      communityEl.textContent = \"Community rating: —\";\n    }\n  }\n\n  const matchEl = host.shadowRoot?.querySelector(\"[data-field='match']\") as\n    | HTMLDivElement\n    | null;\n  if (matchEl) {\n    if (letterboxd?.matchPercent !== null && letterboxd?.matchPercent !== undefined) {\n      matchEl.innerHTML = `Your match: <span class=\"nxl-match-value\">${letterboxd.matchPercent}%</span>`;\n    } else {\n      matchEl.textContent = \"Your match: —\";\n    }\n  }\n\n  const becauseEl = host.shadowRoot?.querySelector(\"[data-field='because']\") as\n    | HTMLDivElement\n    | null;\n  if (becauseEl) {\n    const list = letterboxd?.becauseYouLike ?? [];\n    if (list.length > 0) {\n      becauseEl.style.display = \"block\";\n      becauseEl.textContent = `Because you like: ${list.join(\", \")}`;\n    } else {\n      becauseEl.style.display = \"none\";\n      becauseEl.textContent = \"\";\n    }\n  }\n\n  const badgesEl = host.shadowRoot?.querySelector(\"[data-field='badges']\") as\n    | HTMLDivElement\n    | null;\n  if (badgesEl) {\n    badgesEl.innerHTML = \"\";\n    if (letterboxd?.inWatchlist) {\n      const badge = document.createElement(\"span\");\n      badge.className = \"nxl-badge\";\n      badge.textContent = \"On your watchlist\";\n      badgesEl.appendChild(badge);\n    }\n    if (letterboxd?.userRating !== null && letterboxd?.userRating !== undefined) {\n      const badge = document.createElement(\"span\");\n      badge.className = \"nxl-badge\";\n      badge.textContent = `You rated ${renderStars(letterboxd.userRating)}`;\n      badgesEl.appendChild(badge);\n    }\n    if (!letterboxd?.inWatchlist && letterboxd?.userRating === undefined) {\n      const badge = document.createElement(\"span\");\n      badge.className = \"nxl-badge\";\n      badge.textContent = \"Letterboxd: —\";\n      badgesEl.appendChild(badge);\n    }\n  }\n};\n\nexport const createOverlayManager = () => {\n  let currentRoot: HTMLElement | null = null;\n  let host: HTMLDivElement | null = null;\n  let lastData: OverlayData | null = null;\n\n  const ensureHost = () => {\n    if (!host) host = buildTopSection();\n  };\n\n  const mount = (expandedRoot: HTMLElement) => {\n    ensureHost();\n    if (!host) return;\n    if (currentRoot !== expandedRoot) {\n      host.remove();\n      expandedRoot.insertBefore(host, expandedRoot.firstChild);\n      currentRoot = expandedRoot;\n      requestAnimationFrame(() => {\n        host?.classList.add(\"nxl-visible\");\n      });\n    }\n  };\n\n  const update = (data: OverlayData) => {\n    lastData = data;\n    if (host) applyTopSectionData(host, data);\n  };\n\n  const unmount = () => {\n    if (host) host.remove();\n    currentRoot = null;\n  };\n\n  const renderLast = () => {\n    if (host && lastData) applyTopSectionData(host, lastData);\n  };\n\n  return {\n    mount,\n    update,\n    unmount,\n    renderLast,\n    getLastData: () => lastData,\n    getCurrentRoot: () => currentRoot,\n    isMounted: () => Boolean(host && host.isConnected)\n  };\n};\n","import { log } from \"../../../shared/logger\";\n\nconst BADGE_ID = \"nxlb-status-badge\";\n\nconst buildBadgeHost = () => {\n  const host = document.createElement(\"div\");\n  host.id = BADGE_ID;\n  host.style.position = \"fixed\";\n  host.style.bottom = \"16px\";\n  host.style.right = \"16px\";\n  host.style.zIndex = \"2147483647\";\n  host.style.pointerEvents = \"none\";\n\n  const shadow = host.attachShadow({ mode: \"open\" });\n  const style = document.createElement(\"style\");\n  style.textContent = `\n    :host {\n      all: initial;\n      font-family: \"Netflix Sans\", \"Helvetica Neue\", Helvetica, Arial, sans-serif;\n    }\n    .badge {\n      display: inline-flex;\n      align-items: center;\n      gap: 8px;\n      background: rgba(0, 0, 0, 0.8);\n      border: 1px solid rgba(255, 255, 255, 0.12);\n      border-radius: 999px;\n      padding: 8px 12px;\n      color: #f5f5f5;\n      font-size: 12px;\n      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.35);\n      pointer-events: auto;\n      position: relative;\n    }\n    .dots {\n      display: inline-flex;\n      gap: 4px;\n      align-items: center;\n    }\n    .dot {\n      width: 8px;\n      height: 8px;\n      border-radius: 50%;\n      display: inline-block;\n    }\n    .dot.orange { background: #f2b34c; }\n    .dot.green { background: #00c46a; }\n    .dot.blue { background: #4aa8ff; }\n    .status {\n      width: 6px;\n      height: 6px;\n      border-radius: 50%;\n      background: #46d369;\n      box-shadow: 0 0 6px rgba(70, 211, 105, 0.6);\n    }\n    .tooltip {\n      position: absolute;\n      bottom: calc(100% + 8px);\n      right: 0;\n      background: rgba(0, 0, 0, 0.9);\n      color: #f5f5f5;\n      font-size: 11px;\n      padding: 6px 8px;\n      border-radius: 8px;\n      opacity: 0;\n      transform: translateY(4px);\n      transition: opacity 120ms ease, transform 120ms ease;\n      white-space: nowrap;\n      pointer-events: none;\n    }\n    .badge:hover .tooltip {\n      opacity: 1;\n      transform: translateY(0);\n    }\n  `;\n\n  const badge = document.createElement(\"div\");\n  badge.className = \"badge\";\n  badge.innerHTML = `\n    <span class=\"dots\">\n      <span class=\"dot orange\"></span>\n      <span class=\"dot green\"></span>\n      <span class=\"dot blue\"></span>\n    </span>\n    <span>Letterboxd</span>\n    <span class=\"status\" aria-hidden=\"true\"></span>\n    <span class=\"tooltip\">Netflix × Letterboxd overlay enabled</span>\n  `;\n\n  shadow.appendChild(style);\n  shadow.appendChild(badge);\n  return host;\n};\n\nexport const setBadgeVisible = (enabled: boolean) => {\n  const existing = document.getElementById(BADGE_ID);\n  if (!enabled) {\n    if (existing) {\n      existing.remove();\n      log(\"OVERLAY_BADGE_REMOVED\");\n    }\n    return;\n  }\n\n  if (existing) return;\n\n  const host = buildBadgeHost();\n  document.documentElement.appendChild(host);\n  log(\"OVERLAY_BADGE_MOUNTED\");\n};\n","import { log, DEBUG } from \"../shared/logger\";\nimport { STORAGE_KEYS } from \"../shared/constants\";\nimport { getStorage } from \"../shared/storage\";\nimport type {\n  LetterboxdIndexUpdatedAckMessage,\n  LetterboxdIndexUpdatedMessage,\n  OverlayData,\n  OverlayDataResolvedMessage,\n  ResolveOverlayDataMessage\n} from \"../shared/types\";\nimport {\n  detectActiveTitleContext,\n  extractDisplayTitle,\n  findExpandedRoot,\n  findPreviewElement,\n  findControlsRow,\n  hasMetadataSection,\n  normalizeNetflixTitle,\n  EXPANDED_CONTAINER_SELECTOR\n} from \"./netflix/selectors\";\nimport { createOverlayManager } from \"./ui/overlay\";\nimport { setBadgeVisible } from \"./ui/badge\";\n\nexport type ExtractedTitleInfo = {\n  titleText: string;\n  netflixTitleId?: string;\n  year?: number;\n  href?: string;\n};\n\nexport type Settings = {\n  overlayEnabled: boolean;\n};\n\ntype JawboneDetection = {\n  cardEl: HTMLElement;\n  extracted: ExtractedTitleInfo;\n  strategy: string;\n};\n\nconst OBSERVER_DEBOUNCE_MS = 200;\nconst WATCHDOG_INTERVAL_MS = 2000;\nconst HERO_WIDTH_THRESHOLD = 0.85;\nconst HERO_HEIGHT_THRESHOLD = 0.6;\n\ntype NxlWindow = Window & {\n  __nxlBooted?: boolean;\n  __nxlDebug?: {\n    getLbIndex: () => Promise<Record<string, unknown>>;\n    lastOverlayData: () => OverlayData | null;\n    forceResolve: () => void;\n  };\n};\n\nconst getNxlWindow = () => window as NxlWindow;\n\nexport class OverlayController {\n  private overlayManager = createOverlayManager();\n  private currentCard: HTMLElement | null = null;\n  private currentExtracted: ExtractedTitleInfo | null = null;\n  private currentRequestId = \"\";\n  private overlayEnabled = true;\n  private playbackActive = false;\n  private debounceTimer?: number;\n  private watchdogTimer?: number;\n  private lastData: OverlayData | null = null;\n  private observer?: MutationObserver;\n\n  init(): void {\n    const win = getNxlWindow();\n    if (win.__nxlBooted) return;\n    win.__nxlBooted = true;\n\n    void this.loadSettings();\n    this.bindRuntimeMessages();\n    this.bindStorageListener();\n    this.bindPlaybackListeners();\n    this.bindPointerFallback();\n    this.startObserver();\n    this.startWatchdog();\n    this.setDebugHook();\n  }\n\n  onActiveCardChange(cardEl: HTMLElement, extracted: ExtractedTitleInfo): void {\n    const prev = this.currentExtracted;\n    if (\n      this.currentCard === cardEl &&\n      prev &&\n      prev.titleText === extracted.titleText &&\n      prev.netflixTitleId === extracted.netflixTitleId\n    ) {\n      return;\n    }\n\n    if (prev) {\n      log(\"ACTIVE_CARD_CHANGED\", {\n        from: { title: prev.titleText, id: prev.netflixTitleId },\n        to: { title: extracted.titleText, id: extracted.netflixTitleId }\n      });\n    }\n\n    this.currentCard = cardEl;\n    this.currentExtracted = extracted;\n\n    this.overlayManager.mount(cardEl);\n    this.overlayManager.update(this.buildBlankOverlayData(extracted));\n    this.sendOverlayRequest(extracted);\n  }\n\n  onSettingsChange(settings: Settings): void {\n    this.overlayEnabled = settings.overlayEnabled;\n    if (!this.overlayEnabled) {\n      this.overlayManager.unmount();\n      setBadgeVisible(false);\n      return;\n    }\n\n    this.updatePlaybackState();\n    if (!this.playbackActive) {\n      setBadgeVisible(true);\n      log(\"BADGE_SHOWN\");\n      log(\"BROWSE_MODE_DETECTED\");\n      if (this.currentExtracted && this.currentCard) {\n        this.overlayManager.mount(this.currentCard);\n        this.sendOverlayRequest(this.currentExtracted);\n      }\n    }\n  }\n\n  onDataResolved(data: OverlayData): void {\n    this.lastData = data;\n    this.overlayManager.update(data);\n  }\n\n  forceRefresh(): void {\n    if (!this.currentExtracted || !this.currentCard) return;\n    this.sendOverlayRequest(this.currentExtracted);\n  }\n\n  private async loadSettings(): Promise<void> {\n    const state = await getStorage();\n    const enabled = state[STORAGE_KEYS.OVERLAY_ENABLED] ?? true;\n    this.onSettingsChange({ overlayEnabled: enabled });\n  }\n\n  private sendOverlayRequest(extracted: ExtractedTitleInfo): void {\n    if (!this.overlayEnabled) return;\n    this.updatePlaybackState();\n    if (this.playbackActive) return;\n\n    const requestId = `req_${Date.now()}_${Math.random().toString(36).slice(2, 8)}`;\n    this.currentRequestId = requestId;\n\n    const message: ResolveOverlayDataMessage = {\n      type: \"RESOLVE_OVERLAY_DATA\",\n      requestId,\n      extracted\n    };\n\n    log(\"OVERLAY_REQUEST_SENT\", { titleText: extracted.titleText, id: extracted.netflixTitleId });\n\n    chrome.runtime\n      .sendMessage(message)\n      .then((response: OverlayDataResolvedMessage) => {\n        if (!response || response.type !== \"OVERLAY_DATA_RESOLVED\") return;\n        if (response.requestId !== this.currentRequestId) {\n          log(\"OVERLAY_RESPONSE_IGNORED_STALE\", { requestId: response.requestId });\n          return;\n        }\n        log(\"OVERLAY_RESPONSE_RECEIVED\", {\n          tmdb: response.payload.tmdb,\n          letterboxd: response.payload.letterboxd\n        });\n        this.onDataResolved(response.payload);\n\n        if (response.error === \"TMDB_KEY_MISSING\") {\n          log(\"TMDB_KEY_MISSING\");\n        }\n      })\n      .catch((err) => {\n        log(\"Overlay resolve failed\", { err });\n      });\n  }\n\n  private buildBlankOverlayData(extracted: ExtractedTitleInfo): OverlayData {\n    return {\n      title: extracted.titleText,\n      year: extracted.year ?? null,\n      tmdb: {\n        id: null,\n        voteAverage: null,\n        voteCount: null\n      },\n      letterboxd: {\n        inWatchlist: false,\n        userRating: null,\n        matchPercent: null,\n        becauseYouLike: []\n      }\n    };\n  }\n\n  private startObserver(): void {\n    if (this.observer) this.observer.disconnect();\n\n    this.observer = new MutationObserver(() => {\n      this.debounceDetect(\"mutation\");\n    });\n\n    this.observer.observe(document.body, {\n      childList: true,\n      subtree: true,\n      attributes: true,\n      attributeFilter: [\"class\", \"style\", \"aria-expanded\", \"aria-hidden\"]\n    });\n\n    this.debounceDetect(\"init\");\n  }\n\n  private debounceDetect(reason: string): void {\n    if (this.debounceTimer) window.clearTimeout(this.debounceTimer);\n    this.debounceTimer = window.setTimeout(() => {\n      this.detectActiveCard(reason);\n    }, OBSERVER_DEBOUNCE_MS);\n  }\n\n  private detectActiveCard(reason: string): void {\n    if (!this.overlayEnabled) return;\n    this.updatePlaybackState();\n    if (this.playbackActive) return;\n\n    if (DEBUG) log(\"OVERLAY_MOUNT_ATTEMPT\", { reason });\n    const detection = this.findActiveJawbone();\n    if (!detection) return;\n\n    if (DEBUG) {\n      log(\"ACTIVE_CARD_DETECTED\", {\n        title: detection.extracted.titleText,\n        id: detection.extracted.netflixTitleId,\n        strategy: detection.strategy\n      });\n    }\n\n    this.onActiveCardChange(detection.cardEl, detection.extracted);\n  }\n\n  private startWatchdog(): void {\n    if (this.watchdogTimer) window.clearInterval(this.watchdogTimer);\n    this.watchdogTimer = window.setInterval(() => {\n      if (!this.overlayEnabled) return;\n      this.updatePlaybackState();\n      if (this.playbackActive) return;\n      if (!this.overlayManager.isMounted()) {\n        this.detectActiveCard(\"watchdog\");\n      }\n    }, WATCHDOG_INTERVAL_MS);\n  }\n\n  private bindPointerFallback(): void {\n    document.addEventListener(\n      \"pointerover\",\n      () => {\n        this.debounceDetect(\"pointer\");\n      },\n      true\n    );\n    document.addEventListener(\n      \"focusin\",\n      () => {\n        this.debounceDetect(\"focus\");\n      },\n      true\n    );\n  }\n\n  private bindRuntimeMessages(): void {\n    chrome.runtime.onMessage.addListener(\n      (message: LetterboxdIndexUpdatedAckMessage | LetterboxdIndexUpdatedMessage) => {\n        if (message?.type === \"LB_INDEX_UPDATED\") {\n          log(\"LB_INDEX_UPDATED\");\n          this.forceRefresh();\n          return;\n        }\n        if (message?.type === \"LB_INDEX_UPDATED_ACK\") {\n          log(\"LB_INDEX_UPDATED_ACK\", message.payload);\n          this.forceRefresh();\n        }\n      }\n    );\n  }\n\n  private bindStorageListener(): void {\n    chrome.storage.onChanged.addListener((changes) => {\n      if (changes[STORAGE_KEYS.OVERLAY_ENABLED]) {\n        const next = changes[STORAGE_KEYS.OVERLAY_ENABLED].newValue;\n        this.onSettingsChange({ overlayEnabled: next ?? true });\n      }\n    });\n  }\n\n  private bindPlaybackListeners(): void {\n    window.addEventListener(\"visibilitychange\", () => this.updatePlaybackState());\n    window.addEventListener(\"popstate\", () => this.updatePlaybackState());\n    window.addEventListener(\"hashchange\", () => this.updatePlaybackState());\n  }\n\n  private updatePlaybackState(): void {\n    const next = this.detectPlaybackActive();\n    if (next === this.playbackActive) return;\n    this.playbackActive = next;\n\n    if (this.playbackActive) {\n      setBadgeVisible(false);\n      log(\"BADGE_HIDDEN_PLAYBACK\");\n      this.overlayManager.unmount();\n    } else if (this.overlayEnabled) {\n      setBadgeVisible(true);\n      log(\"BADGE_SHOWN\");\n      log(\"BROWSE_MODE_DETECTED\");\n    }\n  }\n\n  private detectPlaybackActive(): boolean {\n    if (window.location.pathname.includes(\"/watch/\")) return true;\n\n    const videos = Array.from(document.querySelectorAll(\"video\"));\n    const playing = videos.some((video) => {\n      if (video.paused || video.ended) return false;\n      const rect = video.getBoundingClientRect();\n      if (rect.width === 0 || rect.height === 0) return false;\n      const widthRatio = rect.width / window.innerWidth;\n      const heightRatio = rect.height / window.innerHeight;\n      return widthRatio > 0.85 || heightRatio > 0.6;\n    });\n    if (playing) return true;\n\n    const playerContainer = document.querySelector(\n      \"[data-uia*='video-player'], [class*='VideoPlayer'], [class*='watch-video'], [data-uia*='player']\"\n    );\n    return Boolean(playerContainer && videos.length > 0);\n  }\n\n  private findActiveJawbone(): JawboneDetection | null {\n    const candidates: Array<{ root: HTMLElement; strategy: string }> = [];\n\n    const expanded = findExpandedRoot();\n    if (expanded) candidates.push({ root: expanded, strategy: \"expanded-root\" });\n\n    const detected = detectActiveTitleContext();\n    if (detected.container instanceof HTMLElement) {\n      candidates.push({ root: detected.container, strategy: \"detect-active\" });\n    }\n\n    const hovered = this.findHoveredJawbone();\n    if (hovered) candidates.push({ root: hovered, strategy: \"hovered\" });\n\n    for (const candidate of candidates) {\n      if (!this.isJawbone(candidate.root)) continue;\n      const extracted = this.extractTitleInfo(candidate.root, detected.candidate ?? null);\n      if (!extracted) continue;\n      return { cardEl: candidate.root, extracted, strategy: candidate.strategy };\n    }\n\n    return null;\n  }\n\n  private extractTitleInfo(\n    root: HTMLElement,\n    fallback: ReturnType<typeof detectActiveTitleContext>[\"candidate\"] | null\n  ): ExtractedTitleInfo | null {\n    const display = extractDisplayTitle(root);\n    const titleText = display.title ?? fallback?.titleText;\n    if (!titleText) return null;\n\n    const anchor = root.querySelector(\"a[href^='/title/']\") as HTMLAnchorElement | null;\n    const href = anchor?.getAttribute(\"href\") ?? fallback?.href;\n    const match = href?.match(/\\/title\\/(\\d+)/);\n    const netflixTitleId = match?.[1] ?? fallback?.netflixTitleId;\n    const normalized = normalizeNetflixTitle(titleText) ?? titleText;\n    const year = this.parseYearFromText(normalized) ?? fallback?.year;\n\n    return {\n      titleText: normalized,\n      netflixTitleId,\n      year,\n      href\n    };\n  }\n\n  private parseYearFromText(text?: string) {\n    if (!text) return undefined;\n    const match = text.match(/(19\\d{2}|20\\d{2})/);\n    if (!match) return undefined;\n    const year = Number(match[1]);\n    return Number.isNaN(year) ? undefined : year;\n  }\n\n  private isJawbone(root: HTMLElement): boolean {\n    if (this.isHeroSized(root)) return false;\n    const preview = findPreviewElement(root);\n    if (!preview) return false;\n    const controls = findControlsRow(root);\n    if (!controls) return false;\n    if (!hasMetadataSection(root)) return false;\n    return true;\n  }\n\n  private isHeroSized(el: Element): boolean {\n    const rect = el.getBoundingClientRect();\n    if (rect.width === 0 || rect.height === 0) return false;\n    return (\n      rect.width > window.innerWidth * HERO_WIDTH_THRESHOLD ||\n      rect.height > window.innerHeight * HERO_HEIGHT_THRESHOLD\n    );\n  }\n\n  private findHoveredJawbone(): HTMLElement | null {\n    const hovered = Array.from(document.querySelectorAll(\":hover\"));\n    if (!hovered.length) return null;\n    const candidates = hovered\n      .map((el) => (el as Element).closest(EXPANDED_CONTAINER_SELECTOR) ?? (el as Element))\n      .filter(Boolean) as Element[];\n    let best: HTMLElement | null = null;\n    let bestArea = 0;\n    candidates.forEach((candidate) => {\n      const rect = candidate.getBoundingClientRect();\n      if (rect.width === 0 || rect.height === 0) return;\n      const area = rect.width * rect.height;\n      if (area > bestArea) {\n        bestArea = area;\n        best = candidate as HTMLElement;\n      }\n    });\n    return best;\n  }\n\n  private setDebugHook(): void {\n    const win = getNxlWindow();\n    win.__nxlDebug = {\n      getLbIndex: async () => chrome.storage.local.get(\"lb_index_v1\"),\n      lastOverlayData: () => this.lastData,\n      forceResolve: () => this.forceRefresh()\n    };\n  }\n}\n","import { log } from \"../shared/logger\";\nimport { OverlayController } from \"./OverlayController\";\n\nconst controller = new OverlayController();\n\nconst init = async () => {\n  controller.init();\n};\n\nif (document.readyState === \"loading\") {\n  document.addEventListener(\n    \"DOMContentLoaded\",\n    () => {\n      init().catch((err) => log(\"Init failed\", err));\n    },\n    { once: true }\n  );\n} else {\n  init().catch((err) => log(\"Init failed\", err));\n}\n"],"names":["STORAGE_KEYS","log","args","getStorage","TITLE_ANCHOR_SELECTOR","CONTAINER_SELECTORS","EXPANDED_CONTAINER_SELECTOR","TITLE_TEXT_SELECTORS","PREVIEW_SELECTORS","CONTROLS_SELECTORS","EPISODE_TITLE_PATTERN","EPISODE_TIME_PATTERN","METADATA_SELECTORS","GENRE_SELECTORS","TITLE_LIKE_SELECTORS","NAV_BANNED_PATTERN","isVisible","el","rect","style","normalizeText","value","text","parseTitleIdFromHref","href","match","parseYearFromText","year","normalizeNetflixTitle","raw","inner","extractFromAnchor","anchor","source","netflixTitleId","titleText","extractTitleTextNear","container","selector","findPrimaryTitle","nodes","node","normalized","findPreviewElement","candidates","best","current","bestRect","currentRect","bestArea","findControlsRow","root","scored","buttons","score","entry","a","b","_a","hasMetadataSection","selectors","findExpandedRoot","findExpandedContainers","maxWidth","maxHeight","candidate","preview","controls","metadata","isBannedTitleText","isInProgressRegion","controlsTop","extractDisplayTitle","expandedRoot","rootRect","rejectedCount","episodeNodes","fontSize","fontWeightRaw","fontWeight","dx","dy","dist","episodeNode","depth","siblingCandidates","sibling","heading","directText","nearby","resolveTitleText","fallback","primary","normalizedFallback","findBestAnchorIn","anchors","visible","filtered","ra","rb","detectActiveTitleContext","containers","resolvedTitle","fallbackAnchor","TOP_SECTION_ID","buildTopSection","host","shadow","section","header","branding","body","communityRating","because","badges","formatRatingCount","renderStars","rating","clamped","full","half","applyTopSectionData","data","tmdbVoteAverage","tmdbVoteCount","_b","letterboxd","communityEl","_c","count","ratingOutOfFive","matchEl","_d","becauseEl","_e","list","badgesEl","_f","badge","createOverlayManager","currentRoot","lastData","ensureHost","BADGE_ID","buildBadgeHost","setBadgeVisible","enabled","existing","OBSERVER_DEBOUNCE_MS","WATCHDOG_INTERVAL_MS","HERO_WIDTH_THRESHOLD","HERO_HEIGHT_THRESHOLD","getNxlWindow","OverlayController","win","cardEl","extracted","prev","settings","requestId","message","response","err","reason","detection","changes","next","videos","video","widthRatio","heightRatio","expanded","detected","hovered","area","controller","init"],"mappings":"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"}