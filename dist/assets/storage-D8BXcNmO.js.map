{"version":3,"file":"storage-D8BXcNmO.js","sources":["../../src/shared/constants.ts","../../src/shared/logger.ts","../../src/shared/normalize.ts","../../src/shared/storage.ts"],"sourcesContent":["export const DEBUG = import.meta.env.DEV;\n\nexport const STORAGE_KEYS = {\n  OVERLAY_ENABLED: \"overlayEnabled\",\n  TMDB_API_KEY: \"tmdbApiKey\",\n  TMDB_CACHE: \"tmdbCache\",\n  TMDB_FEATURE_CACHE: \"tmdbFeatureCache\",\n  MATCH_PROFILE: \"matchProfile\",\n  LETTERBOXD_INDEX: \"lb_index_v1\",\n  LETTERBOXD_STATS: \"lb_stats_v1\",\n  LAST_IMPORT_AT: \"lastImportAt\"\n} as const;\n\nexport type StorageKey = (typeof STORAGE_KEYS)[keyof typeof STORAGE_KEYS];\n","import { DEBUG } from \"./constants\";\n\nexport { DEBUG };\n\nexport const log = (...args: unknown[]) => {\n  if (!DEBUG) return;\n  console.log(\"[Netflix+Letterboxd]\", ...args);\n};\n\nexport const warn = (...args: unknown[]) => {\n  if (!DEBUG) return;\n  console.warn(\"[Netflix+Letterboxd]\", ...args);\n};\n\nexport const error = (...args: unknown[]) => {\n  if (!DEBUG) return;\n  console.error(\"[Netflix+Letterboxd]\", ...args);\n};\n","export const normalizeTitle = (title?: string): string => {\n  if (!title) return \"\";\n  return title\n    .toLowerCase()\n    .replace(/&/g, \" and \")\n    .replace(/[^a-z0-9]+/g, \" \")\n    .replace(/\\s+/g, \" \")\n    .trim();\n};\n\nexport const makeKey = (title?: string, year?: number): string => {\n  const normalized = normalizeTitle(title);\n  const suffix = year ? String(year) : \"\";\n  return `${normalized}-${suffix}`;\n};\n\nexport const buildTmdbCacheKey = (title?: string, year?: number): string => {\n  const normalized = normalizeTitle(title);\n  return year ? `${normalized} (${year})` : normalized;\n};\n\nexport const buildLetterboxdKey = (title?: string, year?: number): string => {\n  return makeKey(title, year);\n};\n\nexport const parseLetterboxdKey = (key: string): { title: string; year?: number } => {\n  const parts = key.split(\"-\");\n  if (parts.length >= 2) {\n    const maybeYear = parts[parts.length - 1];\n    if (maybeYear === \"\") {\n      return { title: parts.slice(0, -1).join(\"-\") };\n    }\n    const year = Number(maybeYear);\n    if (!Number.isNaN(year) && maybeYear.length === 4) {\n      return { title: parts.slice(0, -1).join(\"-\"), year };\n    }\n  }\n  return { title: key };\n};\n\nexport const buildLegacyLetterboxdKey = (title?: string, year?: number): string => {\n  const normalized = normalizeTitle(title);\n  return year ? `${normalized}|${year}` : normalized;\n};\n\nexport const parseLegacyLetterboxdKey = (key: string): { title: string; year?: number } => {\n  const parts = key.split(\"|\");\n  if (parts.length === 2) {\n    const year = Number(parts[1]);\n    return { title: parts[0], year: Number.isNaN(year) ? undefined : year };\n  }\n  return { title: key };\n};\n","import { log, warn } from \"./logger\";\nimport { STORAGE_KEYS } from \"./constants\";\nimport { makeKey, parseLegacyLetterboxdKey } from \"./normalize\";\nimport type { LetterboxdIndex, LetterboxdIndexLegacy, LetterboxdStats } from \"./types\";\n\nexport interface StorageState {\n  [STORAGE_KEYS.OVERLAY_ENABLED]?: boolean;\n  [STORAGE_KEYS.TMDB_API_KEY]?: string;\n  [STORAGE_KEYS.TMDB_CACHE]?: Record<string, unknown>;\n  [STORAGE_KEYS.TMDB_FEATURE_CACHE]?: Record<string, unknown>;\n  [STORAGE_KEYS.MATCH_PROFILE]?: Record<string, unknown>;\n  [STORAGE_KEYS.LETTERBOXD_INDEX]?: LetterboxdIndex | LetterboxdIndexLegacy;\n  [STORAGE_KEYS.LETTERBOXD_STATS]?: LetterboxdStats;\n  [STORAGE_KEYS.LAST_IMPORT_AT]?: string;\n}\n\nexport const getStorage = async (): Promise<StorageState> => {\n  log(\"Loading storage state\");\n  return chrome.storage.local.get([\n    STORAGE_KEYS.OVERLAY_ENABLED,\n    STORAGE_KEYS.TMDB_API_KEY,\n    STORAGE_KEYS.TMDB_CACHE,\n    STORAGE_KEYS.TMDB_FEATURE_CACHE,\n    STORAGE_KEYS.MATCH_PROFILE,\n    STORAGE_KEYS.LETTERBOXD_INDEX,\n    STORAGE_KEYS.LETTERBOXD_STATS,\n    STORAGE_KEYS.LAST_IMPORT_AT\n  ]) as Promise<StorageState>;\n};\n\nexport const setStorage = async (state: StorageState): Promise<void> => {\n  log(\"Saving storage state\", state);\n  await chrome.storage.local.set(state);\n};\n\nexport const clearStorage = async (): Promise<void> => {\n  warn(\"Clearing storage state\");\n  await chrome.storage.local.clear();\n};\n\nexport const getLetterboxdIndex = async (): Promise<LetterboxdIndex | null> => {\n  const data = await chrome.storage.local.get([STORAGE_KEYS.LETTERBOXD_INDEX]);\n  const raw = data[STORAGE_KEYS.LETTERBOXD_INDEX] as\n    | LetterboxdIndex\n    | LetterboxdIndexLegacy\n    | undefined;\n  if (!raw) return null;\n\n  if (\"ratingsByKey\" in raw && \"watchlistKeys\" in raw) {\n    const index = raw as LetterboxdIndex;\n    const needsMigration =\n      Object.keys(index.ratingsByKey).some((key) => key.includes(\"|\")) ||\n      Object.keys(index.watchlistKeys).some((key) => key.includes(\"|\"));\n    if (!needsMigration) return index;\n    const migratedRatings: Record<string, number> = {};\n    const migratedWatchlist: Record<string, true> = {};\n    Object.entries(index.ratingsByKey).forEach(([key, rating]) => {\n      const parsed = parseLegacyLetterboxdKey(key);\n      const nextKey = makeKey(parsed.title, parsed.year);\n      migratedRatings[nextKey] = rating;\n    });\n    Object.keys(index.watchlistKeys).forEach((key) => {\n      const parsed = parseLegacyLetterboxdKey(key);\n      const nextKey = makeKey(parsed.title, parsed.year);\n      migratedWatchlist[nextKey] = true;\n    });\n    return {\n      ratingsByKey: migratedRatings,\n      watchlistKeys: migratedWatchlist,\n      updatedAt: Date.now()\n    };\n  }\n\n  const legacy = raw as LetterboxdIndexLegacy;\n  const ratingsByKey: Record<string, number> = {};\n  const watchlistKeys: Record<string, true> = {};\n  Object.entries(legacy).forEach(([key, entry]) => {\n    const parsed = parseLegacyLetterboxdKey(key);\n    const nextKey = makeKey(parsed.title, parsed.year);\n    if (entry.r !== undefined) ratingsByKey[nextKey] = entry.r;\n    if (entry.w === 1) watchlistKeys[nextKey] = true;\n  });\n  return {\n    ratingsByKey,\n    watchlistKeys,\n    updatedAt: Date.now()\n  };\n};\n\nexport const setLetterboxdIndex = async (index: LetterboxdIndex): Promise<void> => {\n  await chrome.storage.local.set({ [STORAGE_KEYS.LETTERBOXD_INDEX]: index });\n};\n"],"names":["STORAGE_KEYS","log","args","normalizeTitle","title","makeKey","year","normalized","suffix","buildTmdbCacheKey","buildLetterboxdKey","parseLetterboxdKey","key","parts","maybeYear","buildLegacyLetterboxdKey","parseLegacyLetterboxdKey","getStorage","getLetterboxdIndex","raw","index","migratedRatings","migratedWatchlist","rating","parsed","nextKey","legacy","ratingsByKey","watchlistKeys","entry","setLetterboxdIndex"],"mappings":"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"}